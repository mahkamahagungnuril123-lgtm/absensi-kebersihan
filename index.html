<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1280">
    <title>Absensi Kebersihan Kantor Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
   <link rel="icon" href="Logo MS Str.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <style>
        /* --- VARIABLE & GLOBAL STYLES --- */
        :root {
            --bg-primary: #161b22;
            --bg-secondary: #0d1117;
            --bg-tertiary: #21262d;
            --sidebar-bg: rgba(13, 17, 23, 0.85);
            --border-primary: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-primary: #58a6ff;
            --accent-secondary: #1f6feb;
            --danger-color: #f85149;
            --success-color: #3fb950;
            --warning-color: #d29922;
        }
        html { scroll-behavior: smooth; }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            /* overflow-x: hidden; -- INILAH PENYEBAB MASALAH, SUDAH SAYA HAPUS */
        }

        body {
            background-color: var(--bg-primary);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-image 0.8s ease-in-out;
        }
        
        #app-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 100vh;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- BACKGROUND & ANIMATIONS --- */
        body::before {
            content: ''; 
            position: fixed; 
            inset: 0; 
            z-index: -2;
            background-image: url('gedung fix.jpg'); 
            background-size: cover; 
            background-position: center center;
            animation: kenBurnsEffect 40s ease-in-out infinite alternate;
            will-change: transform;
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }

        @keyframes kenBurnsEffect {
            from { transform: scale(1.0); }
            to { transform: scale(1.15); }
        }
        
        .bg-gradient-overlay {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(135deg, rgba(13, 17, 23, 0.65), rgba(22, 27, 34, 0.75));
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }

        body.dashboard-active {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2358a6ff' fill-opacity='0.06'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        body.dashboard-active::before,
        body.dashboard-active .bg-gradient-overlay {
            opacity: 0;
        }

        #animation-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none;
        }
        
        .particle {
            position: absolute; background-color: rgba(88, 166, 255, 0.1);
            border-radius: 50%; animation: floatUp ease-in-out infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            10%, 90% { opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }
        
        /* --- LOADERS & UTILITIES --- */
        #initial-loader {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1rem; transition: opacity 0.5s ease-out;
        }
        
        .logo-img { image-rendering: auto; }

        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        .main-view {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }

        body.dashboard-active #login-page {
            display: none !important;
        }

        /* --- CARD & FORM STYLES --- */
        .glass-card {
            background: rgba(22, 27, 34, 0.75);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-primary); border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
        }
        .card-header {
            background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid var(--border-primary);
            border-radius: 1rem 1rem 0 0;
        }
        
        .form-section-card {
            background-color: rgba(13, 17, 23, 0.5); padding: 2rem; border-radius: 1rem;
            border: 1px solid var(--border-primary); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease-in-out;
        }
        .form-section-card:hover { box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 0 15px rgba(88, 166, 255, 0.1); }
        
        input[type="date"], input[type="time"] {
            background-color: var(--bg-secondary); color: white; border: 1px solid var(--border-primary);
        }
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        .form-input, .choices__inner, .date-time-input {
            background-color: var(--bg-secondary) !important; color: var(--text-primary) !important;
            border: 1px solid var(--border-primary) !important; border-radius: 0.5rem !important;
            padding: 0.75rem 1rem !important; transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
            background-image: none !important;
        }
        .form-input::placeholder { color: var(--text-secondary) !important; opacity: 0.7; }
        .form-input:focus, .choices__inner.is-focused, .date-time-input:focus {
            outline: none !important; border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3), inset 0 1px 2px rgba(0,0,0,0.2) !important;
        }
        .form-input[readonly] { background-color: var(--bg-tertiary) !important; cursor: not-allowed; }
        
        .choices__list--dropdown {
            background-color: var(--bg-secondary) !important; border-radius: 0.5rem !important;
            border-color: var(--border-primary) !important; max-height: 200px !important; overflow-y: auto !important;
        }
        .choices__list--dropdown .choices__item { color: var(--text-primary) !important; }
        .choices__list--dropdown .choices__item--selectable.is-highlighted { background-color: var(--accent-primary) !important; color: var(--bg-primary) !important; }
        .choices__list--multiple .choices__item { background-color: var(--accent-secondary) !important; border-color: var(--accent-primary) !important; }
        .choices__placeholder { color: var(--text-secondary) !important; opacity: 0.7; }
        .choices__optgroup-heading { font-weight: 600; color: var(--accent-primary) !important; }
        
        /* --- BUTTONS & BADGES --- */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
            display: inline-flex; align-items: center; justify-content: center;
            border: 1px solid transparent;
        }
        .btn svg { margin-right: 0.5rem; }
        .btn.icon-only svg { margin-right: 0; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); filter: brightness(1.15); }
        .btn:active { transform: translateY(0px); filter: brightness(1); }
        .btn-primary {   background-color: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.5);color: rgba(255, 255, 255, 0.7); opacity: 1; /* Menghapus efek transparan */}
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-image: linear-gradient(to right, #03a9f4 0%, #0288d1 100%); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .loader {
            border: 4px solid rgba(255,255,255,0.2); border-radius: 50%;
            border-top: 4px solid var(--text-primary); width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
         .inline-loader {
            width: 16px; height: 16px; border-width: 2px;
            display: inline-block; vertical-align: middle; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-badge {
            display: inline-flex; align-items: center; padding: 0.5rem 1rem;
            border-radius: 9999px; font-weight: 500; margin-top: 1rem;
        }
        .status-badge.success { background-color: rgba(63, 185, 80, 0.2); color: var(--success-color); border: 1px solid rgba(63, 185, 80, 0.4); }
        .status-badge.danger { background-color: rgba(248, 81, 73, 0.2); color: var(--danger-color); border: 1px solid rgba(248, 81, 73, 0.4); }
        .status-badge.warning { background-color: rgba(210, 153, 34, 0.2); color: var(--warning-color); border: 1px solid rgba(210, 153, 34, 0.4); }
        .status-badge.info { background-color: rgba(88, 166, 255, 0.2); color: var(--accent-primary); border: 1px solid rgba(88, 166, 255, 0.4); }

        .day-toggle-btn {
            padding: 0.5rem 1rem; border: 1px solid var(--border-primary); border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s ease;
            background-color: var(--bg-tertiary); color: var(--text-secondary);
        }
        .day-toggle-btn:hover { background-color: var(--bg-secondary); border-color: var(--accent-secondary); }
        .day-toggle-btn.active {
            background-color: var(--accent-primary); color: var(--bg-primary);
            border-color: var(--accent-primary); font-weight: 600;
        }

        /* --- KEYFRAMES & TRANSITIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0); } }
        @keyframes flash-success-anim { from { background-color: rgba(63, 185, 80, 0.4); } to { background-color: transparent; } }
        
        .flash-success { animation: flash-success-anim 1.5s ease-out forwards; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.8s ease-out forwards; }
        .form-section > * { opacity: 0; animation: slideInUp 0.6s ease-out forwards; }

        /* --- MAP & LEAFLET STYLES --- */
        .center-marker-icon, .corner-marker-icon {
            background-color: var(--accent-primary); border: 3px solid white; border-radius: 50%;
            width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
            color: var(--bg-primary); font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: grab;
            transition: transform 0.2s ease-in-out;
        }
        .center-marker-icon:active, .corner-marker-icon:active { cursor: grabbing; transform: scale(1.25); }
        
        .leaflet-control-layers {
            background: rgba(22, 27, 34, 0.85) !important;
            backdrop-filter: blur(10px) !important; -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid var(--border-primary) !important; border-radius: 0.5rem !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            color: var(--text-primary) !important;
        }
        .leaflet-control-layers-base label { font-weight: 500 !important; }
        .leaflet-control-layers-separator { border-top: 1px solid var(--border-primary) !important; }
        
        /* --- TABLES & TABS --- */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed;}
        .report-table th, .report-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-primary); }
        .report-table th { background-color: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); border-bottom-width: 2px; }
        .report-table td { color: var(--text-secondary); font-size: 0.9rem; }
        .report-table tbody tr { transition: background-color 0.2s ease, opacity 0.3s ease; }
        .report-table tbody tr:hover { background-color: rgba(88, 166, 255, 0.08); }
        .report-table .room-cell { font-style: italic; color: var(--text-primary); }
        
        .assessment-select, .assessment-input {
            width: 150px; background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary); color: var(--text-primary);
            border-radius: 0.5rem; padding: 0.5rem;
        }
        
        .tab-nav-item {
            padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; font-weight: 600; color: var(--text-secondary); white-space: nowrap;
        }
        .tab-nav-item:hover { color: var(--text-primary); }
        .tab-nav-item.active {
            color: var(--accent-primary); border-bottom-color: var(--accent-primary);
            background-color: rgba(88, 166, 255, 0.05);
        }
        .tab-pane { display: none; animation: fadeIn 0.5s ease; }
        .tab-pane.active { display: block; }
        
        .job-table td[contenteditable="true"] {
            background-color: rgba(0, 0, 0, 0.2); outline: none; cursor: text;
            transition: all 0.2s ease; border-radius: 8px;
        }
        .job-table td[contenteditable="true"]:hover { background-color: rgba(88, 166, 255, 0.1); }
        .job-table td[contenteditable="true"]:focus {
            background-color: rgba(88, 166, 255, 0.2); box-shadow: 0 0 0 2px var(--accent-primary);
        }
        
        /* --- TOGGLE SWITCH --- */
        .toggle-with-text { display: inline-flex; align-items: center; cursor: pointer; }
        .toggle-track {
            width: 72px; height: 32px; background-color: var(--danger-color); border-radius: 9999px;
            position: relative; transition: background-color 0.3s ease; display: flex;
            align-items: center; font-size: 12px; font-weight: bold; text-transform: uppercase;
        }
        .toggle-thumb {
            width: 24px; height: 24px; background-color: white; border-radius: 50%;
            position: absolute; top: 4px; left: 4px; transition: transform 0.3s ease;
        }
        .toggle-track::before, .toggle-track::after { position: absolute; transition: opacity 0.3s ease; }
        .toggle-track::before { content: 'ON'; color: white; left: 10px; opacity: 0; }
        .toggle-track::after { content: 'OFF'; color: white; right: 10px; opacity: 1; }
        .toggle-input:checked + .toggle-track { background-color: var(--success-color); }
        .toggle-input:checked + .toggle-track .toggle-thumb { transform: translateX(40px); }
        .toggle-input:checked + .toggle-track::before { opacity: 1; }
        .toggle-input:checked + .toggle-track::after { opacity: 0; }
  
        /* --- SUPERVISOR DASHBOARD LAYOUT --- */
        #supervisor-dashboard-layout { display: flex; flex-grow: 1; }
        #supervisor-sidebar {
            width: 260px; background: var(--sidebar-bg); backdrop-filter: blur(15px);
            border-right: 1px solid var(--border-primary); padding: 1.5rem 0;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            z-index: 40;
        }
        .sidebar-header { padding: 0 1.5rem 1.5rem 1.5rem; border-bottom: 1px solid var(--border-primary); }
        .sidebar-nav { flex-grow: 1; padding: 1rem 0; }
        .sidebar-nav-item {
            display: flex; align-items: center; padding: 0.8rem 1.5rem;
            margin: 0.25rem 1rem; border-radius: 0.5rem; color: var(--text-secondary);
            font-weight: 500; cursor: pointer; transition: all 0.2s ease; gap: 0.8rem;
        }
        .sidebar-nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .sidebar-nav-item .nav-text { opacity: 1; transition: opacity 0.2s ease; }
        .sidebar-nav-item:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
        .sidebar-nav-item.active { background-color: var(--accent-primary); color: var(--bg-primary); font-weight: 600; }
        .sidebar-footer { padding: 1rem; text-align: center; }
        #supervisor-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            min-width: 0;
            background-color: var(--bg-primary);
        }
        #mobile-header { display: none; }
        
        /* --- DIAGNOSTIC TAB STYLES --- */
        #diagnostic-results-list { list-style-type: none; padding: 0; margin-top: 1.5rem; font-family: 'Inter', sans-serif; }
        #diagnostic-results-list li {
            background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 5px solid; transition: all 0.3s ease;
        }
        #diagnostic-results-list .status-icon { font-size: 1.5rem; margin-right: 1rem; }
        #diagnostic-results-list .status-ok { border-left-color: var(--success-color); }
        #diagnostic-results-list .status-ok .status-icon { color: var(--success-color); }
        #diagnostic-results-list .status-error { border-left-color: var(--danger-color); }
        #diagnostic-results-list .status-error .status-icon { color: var(--danger-color); }
        #diagnostic-results-list .status-warning { border-left-color: var(--warning-color); }
        #diagnostic-results-list .status-warning .status-icon { color: var(--warning-color); }
        #diagnostic-results-list .status-text { flex-grow: 1; }
        #diagnostic-results-list .status-title { font-weight: 600; color: var(--text-primary); }
        #diagnostic-results-list .status-message { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .diagnostic-category {
            font-size: 1.25rem; font-weight: 700; color: var(--accent-primary); margin-top: 2rem;
            margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-primary);
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 1024px) {
            .login-card .logo-img,
            #supervisor-sidebar .logo-img,
            #mobile-header .logo-img,
            #supervisor-content .logo-img {
                display: none !important;
            }

            #supervisor-sidebar {
                position: fixed; left: 0; top: 0; height: 100%;
                transform: translateX(-100%);
            }
            #supervisor-sidebar.open {
                transform: translateX(0);
                box-shadow: 10px 0 25px rgba(0,0,0,0.3);
            }
            #supervisor-content { padding: 1rem; }
            #mobile-header {
                display: flex; align-items: center; justify-content: space-between;
                padding: 1rem; background: rgba(22, 27, 34, 0.7);
                backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-primary);
                position: sticky; top: 0; z-index: 30;
            }
            #sidebar-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 39;
                opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            }
            #sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        @media (max-width: 640px) {
            .login-card {
                padding: 1.5rem 1rem !important; border: none !important; border-radius: 0 !important;
                height: 100%; width: 100%; max-width: 100%;
                background: transparent; backdrop-filter: none; box-shadow: none;
                display: flex; flex-direction: column; justify-content: center;
            }
             .login-card h2 { font-size: 1.5rem; }
        }
        
        #snap-button, #submit-button { color: white; }
        .card-header h1 { color: white; }
        
        /* --- PERBAIKAN SCROLL --- */
        /* PERBAIKAN UTAMA: Memastikan container tabel bisa di-scroll di mobile */
        #job-allocation-container,
        #progress-report-container {
             display: block; 
             overflow-x: auto; 
             -webkit-overflow-scrolling: touch;
             max-width: 100%; /* Tambahan untuk robustnes di beberapa browser mobile */
        }
        
        .job-table {
            min-width: 800px;
        }

        .daily-recap-table {
            border-collapse: collapse; margin-top: 1rem;
            font-size: 0.8rem;
            min-width: 1800px; /* Lebar minimum agar tabel tidak rusak & memicu scroll */
        }

        .daily-recap-table th, 
        .daily-recap-table td {
            border: 1px solid var(--border-primary);
            padding: 0.6rem;
            text-align: left;
            vertical-align: top;
        }

        .daily-recap-table thead th {
            background-color: var(--bg-tertiary); font-weight: 600;
            position: sticky; /* Membuat header tetap terlihat saat scroll ke bawah */
            top: 0;
            z-index: 10;
            white-space: nowrap; /* Mencegah teks header terpotong */
        }

        .daily-recap-table tbody td:first-child {
            font-weight: 600; background-color: var(--bg-tertiary);
            position: sticky; /* Membuat kolom nama pegawai tetap terlihat saat scroll ke samping */
            left: 0;
            z-index: 5;
            width: 150px;
            min-width: 150px;
        }

        .daily-recap-table td.is-off-day {
            background-color: rgba(33, 38, 45, 0.7);
            text-align: center; font-style: italic;
        }

        .daily-recap-table ul { list-style-type: none; padding-left: 0; margin: 0; font-size: 0.75rem; }
        .daily-recap-table ul li { margin-bottom: 2px; }

        .recap-complete { color: var(--success-color); }
        .recap-incomplete { color: var(--danger-color); }

        .recap-action-btn { font-size: 0.7rem; padding: 0.2rem 0.4rem; width: 100%; margin-top: 0.5rem; }

    </style>
    <style>*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,li,ol,p,pre,ul{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-meridiem-field,::-webkit-datetime-edit-minute-field,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-second-field,::-webkit-datetime-edit-year-field{padding-bottom:0;padding-top:0}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0}.inset-y-0{top:0;bottom:0}.right-0{right:0}.top-0{top:0}.z-10{z-index:10}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mr-2{margin-right:.5rem}.mr-3{margin-right:.75rem}.mr-4{margin-right:1rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-28{height:7rem}.h-48{height:12rem}.h-6{height:1.5rem}.h-80{height:20rem}.h-full{height:100%}.w-1\/4{width:25%}.w-12{width:3rem}.w-28{width:7rem}.w-6{width:1.5rem}.w-full{width:100%}.max-w-3xl{max-width:48rem}.max-w-7xl{max-width:80rem}.max-w-lg{max-width:32rem}.flex-grow{flex-grow:1}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-x-\[-1\]{--tw-scale-x:-1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.appearance-none{-webkit-appearance:none;appearance:none}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.items-center{align-items:center}.items-end{align-items:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-danger-color\/50{border-color:rgb(248 81 73/.5)}.border-accent-primary{--tw-border-opacity:1;border-color:rgb(88 166 255/var(--tw-border-opacity))}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99/var(--tw-border-opacity))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81/var(--tw-border-opacity))}.bg-black\/20{background-color:rgb(0 0 0/.2)}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0/var(--tw-bg-opacity))}.bg-opacity-20{--tw-bg-opacity:.2}.bg-opacity-30{--tw-bg-opacity:.3}.bg-opacity-50{--tw-bg-opacity:.5}.bg-danger-color\/10{background-color:rgb(248 81 73/.1)}.bg-cover{background-size:cover}.bg-fixed{background-position:fixed}.bg-center{background-position:50%}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.pr-2{padding-right:.5rem}.pr-12{padding-right:3rem}.pt-4{padding-top:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.tracking-tight{letter-spacing:-.025em}.whitespace-pre-wrap{white-space:pre-wrap}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.text-danger-color{color:var(--danger-color)}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-text-primary{--tw-text-opacity:1;color:rgb(201 209 217/var(--tw-text-opacity))}.text-text-secondary{--tw-text-opacity:1;color:rgb(139 148 158/var(--tw-text-opacity))}.text-warning-color{color:var(--warning-color)}.opacity-0{opacity:0}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 #0000000d;--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px #0000001a,0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.list-disc{list-style-type:disc}.list-inside{list-style-position:inside}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.hover\:scale-110:hover{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:text-text-primary:hover{--tw-text-opacity:1;color:rgb(201 209 217/var(--tw-text-opacity))}.hover\:underline:hover{text-decoration-line:underline}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:opacity-50:disabled{opacity:.5}@media(min-width:768px){.md\:w-auto{width:auto}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:flex-row{flex-direction:row}.md\:p-8{padding:2rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}@media(min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:col-span-2{grid-column:span 2/span 2}}</style>
</head>
<body>

<div id="initial-loader">
    <div class="loader" style="width: 48px; height: 48px; border-width: 5px;"></div>
    <p class="text-text-secondary">Mempersiapkan aplikasi...</p>
</div>

<div class="bg-gradient-overlay"></div>
<div id="animation-wrapper"></div>

<div id="app-container" style="visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in-out;">
<div id="app-wrapper">

    <div id="login-page" class="main-view">
        <main class="relative z-10 flex items-center justify-center flex-grow p-4 sm:p-0">
            <div class="login-card glass-card p-6 sm:p-8 md:p-10 w-full max-w-lg text-white slide-in-up">
                
                <div class="text-center mb-8">
                    <img src="Logo MS Str.png" alt="Logo" class="logo-img mx-auto mb-4 w-28 h-28 transform transition-transform duration-300 hover:scale-110">
                    <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight text-text-primary">Sistem Informasi Kebersihan</h2>
                    <p class="text-text-secondary mt-2">Mahkamah Syar'iyah Simpang Tiga Redelong</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-role" class="block mb-2 text-sm font-medium text-text-secondary">Status</label>
                        <select id="login-role" class="form-input w-full" required>
                            <option value="" disabled selected>-- Pilih Status Anda --</option>
                            <option value="Pengawas">Pengawas</option>
                            <option value="Pegawai">Pegawai</option>
                            <option value="Pengunjung">Pengunjung</option>
                        </select>
                    </div>

                    <div id="pegawai-selection-container" class="hidden">
                        <label for="login-username" class="block mb-2 text-sm font-medium text-text-secondary">Nama Pegawai</label>
                        <select id="login-username" class="form-input w-full">
                            </select>
                    </div>

                    <div id="password-container" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label for="login-password" class="block text-sm font-medium text-text-secondary">Password</label>
                            <a href="#" id="forgot-password-link" class="text-sm text-accent-primary hover:underline hidden">Lupa Kata Sandi?</a>
                        </div>
                        <div class="relative flex items-center">
                            <input type="password" id="login-password" class="form-input w-full pr-12" placeholder="....................">
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-text-primary">
                                <svg id="eye-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <svg id="eye-slash-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.664 1.373-3.16 2.458-4.425L13.875 18.825z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.125 10.125L3.175 3.175m17.65 17.65l-7.075-7.075M12 5c.58 0 1.154.067 1.706.196M21.542 12c-.527 1.664-1.373-3.16-2.458-4.425" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.175 3.175L20.825 20.825" /></svg>
                            </button>
                        </div>
                        <p id="password-status-text" class="text-center text-sm text-warning-color mt-2 hidden"></p>
                    </div>

                    <button type="submit" id="login-btn" class="btn btn-primary w-full mt-8 flex items-center justify-center p-4" disabled>
                        <span id="login-btn-text">Masuk</span>
                        <div id="login-loader" class="loader hidden ml-3"></div>
                    </button>
                    <button type="button" id="exit-login-btn" class="btn btn-secondary w-full mt-3 hidden">
                     <span>Keluar</span>
                    </button>
                </form>
            </div>
        </main>
    </div>
    <div id="attendance-page-wrapper" class="main-view">
        </div>

    <div id="supervisor-page-wrapper" class="main-view">
        </div>

    <div id="visitor-page-wrapper" class="main-view">
        </div>

</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
// --- ================================== ---
// ---      KONFIGURASI & VARIABEL GLOBAL     ---
// --- ================================== ---

    const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbzfuRWOTygLrICdhrQ8ASpY5V-4qtA616guVRUF0eyqu7hRxthrtzPQtFo1e-q-y8Uk6Q/exec';
    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
    
    // Opsi untuk menonaktifkan partikel latar belakang jika dirasa berat
    const ENABLE_PARTICLES = true;

    // --- Variabel State Aplikasi ---
    let stream = null; // Menyimpan stream kamera
    let detectionInterval = null; // Menyimpan interval untuk deteksi wajah
    let fullAttendanceData = []; // Cache untuk semua data absensi dari server
    let editingState = {}; // Menyimpan state saat mengedit baris tabel
    let roomChoicesInstance = null; // Instance untuk dropdown ruangan
    // **BARU: Variabel untuk menyimpan semua pengaturan dari Google Sheet**
    let appSettings = {}; 


    // --- ================================== ---
    // ---   MANAJEMEN DATA (SHEET & LOCAL)   ---
    // --- ================================== ---

    /**
     * Mengambil semua pengaturan dari Google Sheet.
     * Ini menjadi sumber data utama (source of truth) untuk Pengawas.
     */
    async function fetchAppSettings() {
        console.log("Mengambil pengaturan dari Google Sheet...");
        try {
            const response = await fetch(`${SPREADSHEET_URL}?action=getSettings&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const data = await response.json();
            if (data.result === 'success') {
                appSettings = data.settings;
                // Sinkronkan data dari sheet ke localStorage sebagai cache/fallback
                for (const key in appSettings) {
                    try {
                        // Coba parse, jika ini adalah JSON string (seperti daftar/objek)
                        // PERBAIKAN: Tangani nilai yang sudah berupa objek/array dari Apps Script
                        const value = appSettings[key];
                        if (typeof value === 'object') {
                             localStorage.setItem(key, JSON.stringify(value));
                        } else {
                            const parsedValue = JSON.parse(value);
                            localStorage.setItem(key, JSON.stringify(parsedValue));
                        }
                    } catch (e) {
                        // Jika bukan JSON string (seperti password biasa), simpan langsung
                        localStorage.setItem(key, appSettings[key]);
                    }
                }
                console.log("Pengaturan berhasil diambil dan disinkronkan ke local storage.", appSettings);
                return true;
            } else {
                throw new Error(data.message || "Gagal mengambil pengaturan dari sheet.");
            }
        } catch (error) {
            console.error("Gagal mengambil App Settings dari sheet:", error);
            // Jika gagal, aplikasi akan otomatis menggunakan data dari localStorage
            alert("Gagal mengambil pengaturan terbaru dari server. Aplikasi akan berjalan menggunakan data terakhir yang tersimpan di perangkat ini. Beberapa data mungkin tidak update.");
            return false;
        }
    }
    
    /**
     * Menyimpan satu atau lebih pengaturan ke Google Sheet.
     * @param {object} settingsToSave - Objek berisi key-value yang ingin disimpan. Cth: { employeeList: [...] }
     */
    async function saveAppSettings(settingsToSave) {
        console.log("Menyimpan pengaturan ke Google Sheet:", settingsToSave);
        try {
            const payload = {};
            for (const key in settingsToSave) {
                const value = settingsToSave[key];
                // Pastikan objek atau array di-stringify sebelum dikirim
                payload[key] = typeof value === 'object' ? JSON.stringify(value) : value;
            }

            // Kirim sebagai request standar agar sesuai dengan Apps Script
            const response = await fetch(`${SPREADSHEET_URL}?action=saveSettings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Gunakan text/plain untuk menghindari preflight CORS
                },
                body: JSON.stringify(payload) 
            });

            const result = await response.json();
            if (result.result === 'success') {
                console.log("Pengaturan berhasil disimpan di server.");
                return true;
            } else {
                throw new Error(result.error || "Gagal menyimpan di server.");
            }
        } catch (error) {
            console.error("Gagal menyimpan pengaturan ke sheet:", error);
            alert("Gagal menyimpan pengaturan ke server. Perubahan hanya tersimpan di perangkat ini. Periksa koneksi internet Anda.");
            return false;
        }
    }
    
    /**
     * Membaca data dari cache (localStorage).
     * @param {string} key - Kunci di localStorage
     * @param {any} defaultData - Nilai default jika data tidak ada/rusak
     * @returns {any} Data yang sudah di-parse
     */
    function getDataFromCache(key, defaultData) {
        const storedData = localStorage.getItem(key);
        if (storedData) {
            try {
                // Khusus untuk kredensial, jangan di-parse jika bukan JSON
                if (key.toLowerCase().includes('password') && !storedData.startsWith('{')) {
                    return storedData;
                }
                return JSON.parse(storedData);
            } catch (e) {
                localStorage.setItem(key, JSON.stringify(defaultData));
                return defaultData;
            }
        }
        localStorage.setItem(key, JSON.stringify(defaultData));
        return defaultData;
    }

    /**
     * Helper untuk menyimpan data ke cache (localStorage) dan ke Sheet.
     */
    async function updateAndSaveData(key, newData) {
        // 1. Simpan ke cache lokal terlebih dahulu untuk responsivitas
        localStorage.setItem(key, JSON.stringify(newData));
        // 2. Kirim pembaruan ke Google Sheet
        await saveAppSettings({ [key]: newData });
    }

    // --- Manajemen Kredensial (Password & Email) ---
    function getCredentials() {
        const defaults = {
            pengawasPassword: "ADMIN", pegawaiPassword: "admin", pengunjungPassword: "admin",
            recoveryEmails: ["mahkamahagungnuril123@gmail.com"],
            passwordStates: { pengawas: true, pegawai: true, pengunjung: true }
        };
        const cached = getDataFromCache('loginCredentials', defaults);
        return { ...defaults, ...cached };
    }

    async function saveCredentials(newCredentials) {
        await updateAndSaveData('loginCredentials', newCredentials);
    }

    // --- Manajemen Pegawai ---
    const getEmployeeList = () => getDataFromCache('employeeList', ["Suryadi", "Arif Munandar", "Para Pegawai Kesekretariatan", "Para Pegawai Kepaniteraan", "Firda Saputra", "Firda Saputra & Rusdi", "Arif Munandar & Suryadi", "Elfiana", "Pegawai Posyabakum", "Eko Setiawan", "Seri Wahyuni"]);
    
    async function addEmployee(name) {
        if (!name || name.trim() === '') { alert('Nama pegawai tidak boleh kosong!'); return; }
        const employeeList = getEmployeeList();
        if (employeeList.map(e => e.toLowerCase()).includes(name.trim().toLowerCase())) { alert('Nama pegawai sudah ada!'); return; }
        employeeList.push(name.trim());
        await updateAndSaveData('employeeList', employeeList);
    }
    
    async function removeEmployee(name) {
        if (confirm(`Anda yakin ingin menghapus "${name}"?\n\nPERINGATAN: Ini juga akan menghapus semua data pembagian tugas yang terkait dengan nama ini.`)) {
            let employeeList = getEmployeeList().filter(e => e !== name);
            await updateAndSaveData('employeeList', employeeList);

            let jobAllocations = getJobAllocations().filter(alloc => alloc.name !== name);
            await saveJobAllocations(jobAllocations);
            
            if (document.getElementById('job-allocation-table')) {
                renderJobAllocationTable();
            }
        }
    }
    
    // --- Manajemen Ruangan ---
    const getDefaultRoomData = () => ({
        "Lantai 1": ["Halaman Depan & Front Desk", "Ruang Tunggu VIP", "Ruang Kesekretariatan", "Toilet Kesekretariatan", "Ruang Kepaniteraan", "Toilet Kepaniteraan", "Ruang Kasir", "Ruang PTSP Dalam", "Ruang Server", "Ruang PTSP Luar", "Ruang Posyabakum", "Ruang Jaksa/Pengacara", "Ruang Sidang Utama", "Ruang Sidang Utama Belakang", "Ruang Tahanan", "Toilet Tahanan", "Ruang Tunggu Sidang", "Ruang Sidang 1", "Ruang Mediasi", "Toilet Umum Laki-laki (Para Pihak)", "Toilet Umum Perempuan (Para Pihak)", "Tempat Bermain Anak"],
        "Lantai 2": ["Ruang Ketua", "Toilet Ruang Ketua", "Ruang Tunggu Lantai 2 & Tangga", "Ruang Media Center", "Ruang Panitera", "Toilet Panitera", "Ruang Hakim", "Ruang Perpustakaan", "Gudang Kecil", "Ruang Aula & Tangga", "Ruang Wakil Ketua", "Toilet Wakil Ketua", "Ruang Bendahara", "Ruang Sekretaris", "Toilet Sekretaris", "Toilet Pria (Lantai 2)", "Toilet Wanita (Lantai 2)", "Balkon", "Pantri Coffe", "Arsip Dinamis", "Arsip Perkara"]
    });
    const getRoomData = () => getDataFromCache('roomData', getDefaultRoomData());
    async function saveRoomData(newData) { await updateAndSaveData('roomData', newData); }

    // --- Manajemen GPS ---
    const defaultOfficePolygon = [
        [4.727530, 96.833301], [4.727530, 96.833832],
        [4.727048, 96.833832], [4.727048, 96.833301]
    ];
    const defaultOfficeCenter = { lat: 4.72728, lon: 96.83355 };

    /**
     * PERBAIKAN: Fungsi getActivePolygon sekarang mengambil dari appSettings (sheet) dulu,
     * baru fallback ke localStorage, lalu ke default. Ini memastikan data persisten.
     */
    const getActivePolygon = () => {
        // Prioritas 1: Dari appSettings yang baru di-fetch dari sheet
        if (appSettings && appSettings.activeGpsCoords) {
            try {
                 // Cek jika nilainya string JSON, parse dulu
                if (typeof appSettings.activeGpsCoords === 'string') {
                    return JSON.parse(appSettings.activeGpsCoords);
                }
                // Jika sudah objek/array, langsung kembalikan
                return appSettings.activeGpsCoords;
            } catch(e) { console.error("Gagal parse activeGpsCoords dari appSettings"); }
        }
        // Prioritas 2: Dari cache local storage
        return getDataFromCache('activeGpsCoords', defaultOfficePolygon);
    };

    const getGpsPresets = () => getDataFromCache('gpsPresetList', [{ name: "Area Kantor MS Redelong (Default)", coords: defaultOfficePolygon }]);
    async function saveGpsPresets(presets) { await updateAndSaveData('gpsPresetList', presets); }
    
    async function addGpsPreset(name, coords) {
        if (!name || name.trim() === '') { alert('Nama preset tidak boleh kosong!'); return false; }
        const presets = getGpsPresets();
        const existingPresetIndex = presets.findIndex(p => p.name.trim().toLowerCase() === name.trim().toLowerCase());

        if (existingPresetIndex !== -1) {
             if(confirm(`Preset dengan nama "${name.trim()}" sudah ada. Apakah Anda ingin menimpanya dengan koordinat saat ini?`)){
                presets[existingPresetIndex].coords = coords;
             } else {
                return false;
             }
        } else {
            presets.push({ name: name.trim(), coords });
        }
        await saveGpsPresets(presets);
        return true;
    }

    async function removeGpsPreset(name) {
        if (name === "Area Kantor MS Redelong (Default)") {
            alert("Preset default tidak dapat dihapus.");
            return;
        }
        let presets = getGpsPresets().filter(p => p.name !== name);
        await saveGpsPresets(presets);
    }

    // --- Manajemen Pembagian Tugas ---
    const getDefaultJobAllocations = () => ([
        { name: "Suryadi", roomsLantai1: "Halaman Depan & Front Desk, Ruang Tunggu VIP, Ruang Kepaniteraan, Ruang Kasir, Ruang PTSP Dalam, Ruang Server, Toilet Umum Perempuan (Para Pihak)", roomsLantai2: "" },
        { name: "Arif Munandar", roomsLantai1: "Ruang Kesekretariatan, Ruang Sidang 1, Ruang Mediasi, Tempat Bermain Anak, Toilet Umum Perempuan", roomsLantai2: "Balkon" },
        { name: "Firda Saputra", roomsLantai1: "Ruang PTSP Luar, Ruang Tunggu Sidang, Toilet Umum Laki-laki (Para Pihak)", roomsLantai2: "" },
        { name: "Eko Setiawan", roomsLantai1: "Ruang Jaksa/Pengacara, Ruang Sidang Utama, Ruang Sidang Utama Belakang, Ruang Tahanan, Toilet Tahanan", roomsLantai2: "" },
        { name: "Elfiana", roomsLantai1: "", roomsLantai2: "Ruang Ketua, Toilet Ruang Ketua, Ruang Media Center, Ruang Panitera, Toilet Panitera, Ruang Hakim, Ruang Perpustakaan, Gudang Kecil, Ruang Aula & Tangga, Toilet Wanita (Lantai 2)" },
        { name: "Seri Wahyuni", roomsLantai1: "", roomsLantai2: "Ruang Tunggu Lantai 2 & Tangga, Ruang Wakil Ketua, Toilet Wakil Ketua, Ruang Bendahara, Ruang Sekretaris, Toilet Sekretaris, Toilet Pria (Lantai 2), Pantri Coffe, Arsip Dinamis, Arsip Perkara" },
        { name: "Pegawai Posyabakum", roomsLantai1: "Ruang Posyabakum", roomsLantai2: "" },
        { name: "Para Pegawai Kesekretariatan", roomsLantai1: "Toilet Kesekretariatan", roomsLantai2: "" },
        { name: "Para Pegawai Kepaniteraan", roomsLantai1: "Toilet Kepaniteraan", roomsLantai2: "" },
        { name: "Firda Saputra & Rusdi", roomsLantai1: "Toilet Umum Laki-laki (Para Pihak)", roomsLantai2: "" },
        { name: "Arif Munandar & Suryadi", roomsLantai1: "Toilet Umum Perempuan (Para Pihak)", roomsLantai2: "" }
    ]);
    const getJobAllocations = () => getDataFromCache('jobAllocations', getDefaultJobAllocations());
    async function saveJobAllocations(allocations) { await updateAndSaveData('jobAllocations', allocations); }
    
// --- ================================== ---
// ---       INSIALISASI APLIKASI         ---
// --- ================================== ---

    /**
     * Membuat animasi partikel di latar belakang.
     */
    function initParticleAnimation() {
        if (!ENABLE_PARTICLES) return;
        const wrapper = document.getElementById('animation-wrapper');
        if (!wrapper || wrapper.children.length > 0) return; // Mencegah duplikasi partikel
        const particleCount = 20;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            const size = Math.random() * 40 + 10;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.bottom = `-${size}px`;
            const duration = Math.random() * 20 + 20;
            const delay = Math.random() * 15;
            particle.style.animationDuration = `${duration}s`;
            particle.style.animationDelay = `${delay}s`;
            wrapper.appendChild(particle);
        }
    }
    
    /**
     * Menampilkan view (halaman) tertentu dan menyembunyikan yang lain.
     */
    function showView(viewId) {
        console.log(`Mencoba menampilkan view: ${viewId}`);
        document.querySelectorAll('.main-view').forEach(view => {
            if (view.id === 'attendance-page-wrapper' && view.style.display !== 'none') {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    console.log("Stream kamera dihentikan.");
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
            }
            view.style.display = 'none';
        });

        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.style.display = 'flex'; 
            targetView.classList.add('fade-in');
            console.log(`Berhasil menampilkan view: ${viewId}`);
        } else {
            console.error(`View dengan ID "${viewId}" tidak ditemukan.`);
        }
    }

    /**
     * Titik masuk utama aplikasi setelah DOM siap.
     * PERBAIKAN: Logika diubah untuk mempercepat waktu login.
     */
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM Content Loaded. Memulai inisialisasi aplikasi.");
        const initialLoader = document.getElementById('initial-loader');
        const loaderText = initialLoader.querySelector('p');
        const appContainer = document.getElementById('app-container');

        const loggedInUser = sessionStorage.getItem('absenUser');
        const userRole = sessionStorage.getItem('absenRole');

        initParticleAnimation();

        // --- TAHAP 1: Ambil data penting dan tampilkan UI secepat mungkin ---
        loaderText.textContent = 'Menyinkronkan pengaturan...';
        await fetchAppSettings();

        if (!loggedInUser) {
            // Jika belum login, langsung tampilkan halaman login.
            document.body.classList.remove('dashboard-active');
            const employeeList = getEmployeeList();
            renderLoginPage(employeeList);
            initialLoader.style.opacity = '0';
            setTimeout(() => {
                initialLoader.style.display = 'none';
                if (appContainer) {
                    appContainer.style.visibility = 'visible';
                    appContainer.style.opacity = '1';
                }
            }, 500);
        } else {
            // Jika sudah login, dashboard akan ditampilkan setelah model AI dimuat.
            document.body.classList.add('dashboard-active');
            const loginPage = document.getElementById('login-page');
            if (loginPage) loginPage.remove();
        }

        // --- TAHAP 2: Muat model AI yang berat di latar belakang ---
        const modelsToLoad = [
            { name: 'Detektor Wajah', task: faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL) },
            { name: 'Penanda Wajah', task: faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL) },
            { name: 'Pengenalan Wajah', task: faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL) },
            { name: 'Model SSD Mobilenet', task: faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL) }
        ];

        const loadModels = async () => {
            for (let i = 0; i < modelsToLoad.length; i++) {
                if (loggedInUser) { // Hanya update loader text jika sedang menunggu dashboard
                    loaderText.textContent = `Memuat model AI (${i + 1}/${modelsToLoad.length}): ${modelsToLoad[i].name}...`;
                }
                await modelsToLoad[i].task;
            }
        };

        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Waktu memuat model habis (>30 dtk). Periksa koneksi internet Anda.')), 30000);
        });

        // --- TAHAP 3: Tampilkan dashboard (jika sudah login) setelah model siap ---
        const renderDashboardIfNeeded = () => {
            if (loggedInUser) {
                if (userRole === "Pengawas") {
                    renderSupervisorPage();
                } else if (userRole === "Pengunjung") {
                    renderVisitorPage();
                } else {
                    renderAttendancePage(loggedInUser);
                }
                
                initialLoader.style.opacity = '0';
                 setTimeout(() => {
                    initialLoader.style.display = 'none';
                     if (appContainer) {
                        appContainer.style.visibility = 'visible';
                        appContainer.style.opacity = '1';
                    }
                }, 500);
            }
        };

        try {
            await Promise.race([loadModels(), timeoutPromise]);
            console.log("Semua model face-api berhasil dimuat.");
            renderDashboardIfNeeded();

        } catch (e) {
            console.error("Gagal memuat model face-api:", e);
            window.faceApiFailed = true; // Tandai bahwa API gagal
            
            if (loggedInUser) { // Jika sudah login tapi model gagal, tampilkan dashboard dengan peringatan
                alert("Gagal memuat komponen AI. Fitur validasi wajah otomatis akan dinonaktifkan.");
                renderDashboardIfNeeded();
            } else { // Jika di halaman login, tampilkan tombol untuk lanjut
                 initialLoader.innerHTML = `
                    <div class="p-4 text-center">
                        <h3 class="text-xl font-bold text-danger-color mb-3">Gagal Memuat Komponen AI</h3>
                        <p class="text-text-secondary mb-4">Tidak dapat mengunduh model deteksi wajah. Ini biasanya disebabkan oleh koneksi internet yang lambat atau terputus.</p>
                        <p class="text-text-secondary mb-4">Anda tetap bisa melanjutkan tanpa fitur validasi wajah otomatis.</p>
                    </div>`;
                // Tombol tidak diperlukan karena login page sudah terlihat di belakang loader
            }
        }
    });

    /**
     * Merender halaman Absensi untuk Pegawai.
     */
    function renderAttendancePage(loggedInUser) {
        const pageContainer = document.getElementById('attendance-page-wrapper');
        pageContainer.innerHTML = `
        <header class="sticky top-0 z-50 glass-card !rounded-none shadow-xl p-4 flex items-center justify-between transition-all duration-300">
            <div class="flex items-center">
                <img src="Logo MS Str.png" alt="Logo" class="logo-img w-12 h-12 mr-4">
                <div><h1 class="text-xl font-bold text-text-primary">Absensi Kebersihan</h1><p class="text-sm text-text-secondary">Mahkamah Syar'iyah Simpang Tiga Redelong</p></div>
            </div>
            <button id="logout-btn-attendance" class="btn btn-danger !py-2 !px-4 text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </header>
        <main class="relative z-10 flex items-center justify-center p-4 py-12">
            <div class="glass-card w-full max-w-3xl slide-in-up">
                <div class="card-header text-center p-8"><h1 class="text-3xl md:text-4xl font-extrabold text-text-primary">Absensi Piket</h1><p class="text-md text-text-secondary mt-2">Pastikan semua data diisi dengan benar.</p></div>
                <form id="attendance-form" class="p-8 space-y-8">
                    <div class="form-section form-section-card" style="animation-delay: 100ms;">
                        <h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-4">Data Diri & Waktu</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nama" class="block text-sm font-medium mb-2 text-text-secondary">Nama Lengkap</label>
                                <input type="text" id="nama" name="nama" value="${loggedInUser}" readonly class="form-input w-full"/>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="ruang" class="block text-sm font-medium text-text-secondary">Pilih Ruangan (Bisa lebih dari 1)</label>
                                    <button type="button" id="fill-my-rooms-btn" class="btn btn-secondary !py-1 !px-2 text-xs">Isi Sesuai Tugas</button>
                                </div>
                                <select id="ruang" name="nama_ruang" multiple></select>
                            </div>
                            <div>
                                <label for="tanggal" class="block text-sm font-medium mb-2 text-text-secondary">Tanggal</label>
                                <input type="date" id="tanggal" name="tanggal" class="form-input w-full"/>
                            </div>
                            <div>
                                <label for="waktu" class="block text-sm font-medium mb-2 text-text-secondary">Waktu</label>
                                <input type="time" id="waktu" name="waktu" class="form-input w-full"/>
                            </div>
                        </div>
                    </div>
                    <div class="form-section form-section-card" style="animation-delay: 200ms;"><h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-4">Lokasi & Bukti Foto</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="p-4 rounded-xl"><label for="gps" class="block text-sm font-medium mb-2 text-text-secondary">Lokasi GPS</label><input type="text" id="gps" name="gps" readonly class="form-input w-full mb-2" /><div id="map" class="w-full h-48 rounded-lg shadow-inner mt-2 border border-border-primary"></div><div id="gps-status" class="status-badge text-center font-bold text-sm mt-2 transition-colors duration-300">Memeriksa lokasi...</div></div><div class="p-4 rounded-xl"><label class="block text-sm font-medium mb-2 text-text-secondary">Ambil Foto</label><div class="relative w-full aspect-video rounded-lg overflow-hidden bg-black shadow-inner border border-border-primary"><video id="video" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video><img id="photo-preview" class="hidden w-full h-full object-cover"/><div id="face-validation-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white font-bold text-lg opacity-0 transition-opacity duration-300">Deteksi Wajah Gagal</div></div><canvas id="canvas" class="hidden"></canvas><input type="hidden" id="photo-data" name="foto"/><div class="flex flex-col gap-4 mt-3"><button type="button" id="snap-button" class="btn btn-primary !py-2 !px-4" disabled><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.89-1.78A2 2 0 0110.46 5H13.54a2 2 0 011.664.89l.89 1.78A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Ambil Foto</button><button type="button" id="retake-button" class="btn btn-secondary !py-2 !px-4 flex-grow hidden"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.418 0h.582m-19 0a2 2 0 002 2h1.582m14.418 0a2 2 0 012-2h.582m0 0a2 2 0 012 2v11a2 2 0 01-2 2H2a2 2 0 01-2-2V7a2 2 0 012 2h2.582m14.418 0a2 2 0 002-2V3a2 2 0 00-2-2H2a2 2 0 00-2 2v2a2 2 0 002 2h2.582z"></path></svg>Ulangi</button><div id="face-status" class="status-badge text-center font-bold text-sm">Menunggu deteksi wajah...</div></div></div></div></div>
                    <div class="form-section form-section-card" style="animation-delay: 300ms;"><h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-4">Catatan & Aksi</h3><div><label for="catatan" class="block text-sm font-medium mb-2 text-text-secondary">Catatan (Opsional)</label><textarea id="catatan" name="catatan" rows="4" class="form-input w-full" placeholder="Ketik catatan tambahan jika ada..."></textarea></div>
                    <div class="mt-6 text-center">
                        <div id="time-window-status" class="status-badge info mx-auto !mb-4 hidden"></div>
                        <button type="submit" id="submit-button" class="btn btn-primary w-full md:w-auto !py-3 !px-8 mx-auto" disabled>
                            <span id="submit-btn-text">Kirim ke Pengawas</span>
                            <div id="submit-loader" class="loader hidden"></div>
                        </button>
                        <div id="submit-status" class="text-warning-color text-sm mt-2 font-medium" style="color: var(--warning-color);"></div>
                    </div>
                </div>
                </form>
            </div>
        </main>
        <footer class="text-center text-text-secondary py-4 text-sm bg-black bg-opacity-30"><p class="font-bold">WAJIB DIISI DENGAN LENGKAP DAN JUJUR!</p><p>Mahkamah Syar'iyah Simpang Tiga Redelong</p></footer>
        `;
        showView('attendance-page-wrapper');
        populateRoomOptions();
        runAttendanceScript();
    }

    /**
     * Merender halaman Dashboard untuk Pengawas.
     */
    function renderSupervisorPage() {
        const pageContainer = document.getElementById('supervisor-page-wrapper');
        pageContainer.innerHTML = `
        <div id="supervisor-dashboard-layout">
            <div id="sidebar-overlay"></div>
            <aside id="supervisor-sidebar">
                <div class="sidebar-header flex items-center gap-3">
                    <img src="Logo MS Str.png" alt="Logo" class="logo-img w-12 h-12">
                    <div>
                        <h1 class="text-lg font-bold text-text-primary">Dashboard</h1>
                        <p class="text-sm text-text-secondary">Pengawas</p>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <a class="sidebar-nav-item active" data-tab="laporan">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3V9h2a4 4 0 004-4V3l5 4-5 4zm10 0v-2a4 4 0 00-4-4h-2V9h2a4 4 0 004-4V3l5 4-5 4z"></path></svg>
                        <span class="nav-text">Laporan Absensi</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="proses">
                         <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="nav-text">Rekapan Proses</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="manajemen">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        <span class="nav-text">Manajemen Data</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="gps">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="nav-text">Area GPS</span>
                    </a>
                     <a class="sidebar-nav-item" data-tab="pengingat">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span class="nav-text">Pengingat</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="pengaturan">
                         <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="nav-text">Monitoring Waktu</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="keamanan">
                         <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.944a11.955 11.955 0 0118 0c.001-.06.003-.12.003-.182A12.02 12.02 0 0021.618 5.984z"></path></svg>
                        <span class="nav-text">Keamanan</span>
                    </a>
                    <a class="sidebar-nav-item" data-tab="diagnostik">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3m6-9h3m-18 0h3m12 5.333a8.001 8.001 0 01-14.666 0M12 12a4 4 0 110-8 4 4 0 010 8z"></path></svg>
                        <span class="nav-text">Diagnostik Sistem</span>
                    </a>
                </nav>

                <div class="sidebar-footer mt-auto">
                     <button id="logout-btn-supervisor" class="btn btn-danger w-full !justify-start !py-2 !px-4 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </aside>
            <div class="flex flex-col flex-grow">
                <header id="mobile-header">
                     <button id="hamburger-btn" class="btn btn-secondary !p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <img src="Logo MS Str.png" alt="Logo" class="logo-img w-8 h-8">
                        <h1 class="text-md font-bold text-text-primary">Dashboard</h1>
                    </div>
                </header>
                <main id="supervisor-content">
                    <div id="tab-laporan" class="tab-pane active">
                    <h2 class="text-3xl font-bold mb-6 text-text-primary">Laporan Absensi</h2>
                        <div class="form-section-card !p-4 mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-center">Filter Laporan</h3>
                            <div class="flex flex-col md:flex-row items-center justify-center gap-4 flex-wrap">
                                <input type="date" id="start-date" class="form-input">
                                <span class="text-gray-400">hingga</span>
                                <input type="date" id="end-date" class="form-input">
                                <button id="filter-btn" class="btn btn-primary !py-2.5">Filter</button>
                            </div>
                        </div>
                        <div id="bulk-action-panel" class="hidden form-section-card !p-3 mb-4 flex items-center justify-between gap-4">
                            <span id="selection-count" class="font-bold"></span>
                            <div class="flex items-center gap-2">
                               <select id="bulk-assessment-select" class="assessment-select !w-auto">
                                    <option value="">-- Beri Nilai Massal --</option>
                                    <option value="Baik">Baik</option>
                                    <option value="Cukup Baik">Cukup Baik</option>
                                    <option value="Kurang Baik">Kurang Baik</option>
                                </select>
                                <button id="apply-bulk-action-btn" class="btn btn-primary !py-1.5 !px-3 text-sm">Terapkan</button>
                                <button id="apply-bulk-delete-btn" class="btn btn-danger !py-1.5 !px-3 text-sm">Hapus Terpilih</button>
                            </div>
                        </div>
                        <div class="text-center mb-6 flex flex-col md:flex-row justify-center items-center gap-4">
                           <button id="print-pdf-btn" class="btn btn-info !py-2 !px-4 text-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm-3-9V5a2 2 0 012-2h4a2 2 0 012 2v3m-4 5a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                                Unduh Laporan (PDF)
                            </button>
                            <a href="https://docs.google.com/spreadsheets/d/1qSoV6UrqNMiKB07cLxPTR86PGNBWpnGahFFs6qrbEa4/edit?usp=sharing" target="_blank" class="btn btn-success !py-2 !px-4 text-sm">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM4 8h5v2H4V8zm0 3h5v2H4v-2z" clip-rule="evenodd"></path></svg>
                                Buka Spreadsheet
                            </a>
                        </div>
                        <div id="attendance-records-container" class="overflow-x-auto"></div>
                    </div>

                    <div id="tab-proses" class="tab-pane p-6 space-y-8">
                    <h2 class="text-3xl font-bold mb-6 text-text-primary">Rekapan Proses & Tugas</h2>
                        <div class="form-section-card">
                             <h2 class="text-2xl font-bold text-text-primary mb-4">Manajemen Pembagian Tugas</h2>
                             <p class="text-text-secondary text-sm mb-4">Klik pada sel nama atau ruangan untuk mengeditnya. Perubahan harus disimpan.</p>
                             <div id="job-allocation-top-scrollbar-wrapper" style="overflow-x: auto; overflow-y: hidden;">
                                <div style="height: 1px;"></div>
                             </div>
                             <div id="job-allocation-container"></div>
                             <div class="flex justify-between items-center mt-4">
                                 <button id="add-allocation-row-btn" class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Tambah Baris
                                 </button>
                                 <button id="save-allocations-btn" class="btn btn-success">
                                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                     Simpan Perubahan
                                 </button>
                             </div>
                        </div>
                        <div class="form-section-card">
                            <h2 class="text-2xl font-bold text-text-primary mb-4">Laporan Rekapan Pekerjaan Harian</h2>
                             <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-4 flex-wrap">
                                <label for="progress-report-start-date" class="text-text-secondary">Mulai Tanggal:</label>
                                <input type="date" id="progress-report-start-date" class="form-input !w-auto">
                                <label for="progress-report-end-date" class="text-text-secondary">Sampai Tanggal:</label>
                                <input type="date" id="progress-report-end-date" class="form-input !w-auto">
                                <button id="generate-progress-report-btn" class="btn btn-primary">Tampilkan</button>
                            </div>
                            <div id="top-scrollbar-wrapper" style="overflow-x: auto; overflow-y: hidden;">
                                <div style="height: 1px;"></div>
                            </div>
                            <div id="progress-report-container"></div>
                        </div>
                    </div>
                    <div id="tab-manajemen" class="tab-pane p-6">
                    <h2 class="text-3xl font-bold mb-6 text-text-primary">Manajemen Data</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="form-section-card">
                                <h2 class="text-2xl font-bold text-text-primary mb-4">Manajemen Pegawai</h2>
                                <div class="flex gap-4 mb-4">
                                    <input type="text" id="new-employee-name" class="form-input w-full" placeholder="Contoh: Budi Santoso">
                                    <button id="add-employee-btn" class="btn btn-primary whitespace-nowrap">Tambah</button>
                                </div>
                                <div id="employee-list-container" class="space-y-3 max-h-80 overflow-y-auto pr-2 mt-6"></div>
                            </div>
                            <div class="form-section-card">
                                <h2 class="text-2xl font-bold text-text-primary mb-4">Manajemen Ruangan & Lantai</h2>
                                <div id="floor-management-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-gps" class="tab-pane p-6">
                        <h2 class="text-3xl font-bold mb-6 text-text-primary">Pengaturan Area GPS</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1 space-y-6">
                                 <div class="form-section-card">
                                    <h2 class="text-2xl font-bold text-text-primary mb-4">Pengaturan Area Absensi</h2>
                                    
                                    <div class="grid grid-cols-2 gap-2 mb-6">
                                        <label class="block text-center p-2 rounded-lg border border-border-primary cursor-pointer has-[:checked]:bg-accent-secondary has-[:checked]:border-accent-primary">
                                            <input type="radio" name="gps_mode" value="center_size" class="hidden" checked> Pusat & Ukuran
                                        </label>
                                        <label class="block text-center p-2 rounded-lg border border-border-primary cursor-pointer has-[:checked]:bg-accent-secondary has-[:checked]:border-accent-primary">
                                            <input type="radio" name="gps_mode" value="manual" class="hidden"> 4 Titik Manual
                                        </label>
                                    </div>

                                    <div id="center-size-mode-container" class="space-y-4">
                                        <p class="text-text-secondary text-sm">Tentukan titik pusat dan jangkauan area. Area akan berbentuk persegi.</p>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-text-secondary">Titik Tengah Latitude</label>
                                            <input type="number" step="any" id="center-lat-input" class="form-input w-full" placeholder="Contoh: 4.72728">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-text-secondary">Titik Tengah Longitude</label>
                                            <input type="number" step="any" id="center-lon-input" class="form-input w-full" placeholder="Contoh: 96.83355">
                                        </div>
                                        <hr class="border-border-primary">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-text-secondary">Panjang Sisi Area</label>
                                            <div class="flex gap-2">
                                                <input type="number" id="area-size-input" class="form-input w-full" value="100">
                                                <select id="area-unit-select" class="form-input">
                                                    <option value="m" selected>meter (m)</option>
                                                    <option value="km">kilometer (km)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button id="geolocate-btn" class="btn btn-secondary w-full text-sm">Gunakan Lokasi Saya Saat Ini</button>
                                    </div>
                                    
                                    <div id="manual-mode-container" class="space-y-4 hidden">
                                         <p class="text-text-secondary text-sm">Geser 4 penanda di peta atau isi koordinat secara manual.</p>
                                         <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                             ${[1,2,3,4].map(i => `
                                                <div class="col-span-2 font-bold text-accent-primary border-b border-border-primary pb-1">Titik ${i}</div>
                                                <div>
                                                    <label class="block text-xs font-medium mb-1 text-text-secondary">Latitude ${i}</label>
                                                    <input type="number" step="any" id="manual-lat-${i}" class="form-input w-full !py-1.5 !text-sm manual-coord-input" data-index="${i-1}" data-coord="lat">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium mb-1 text-text-secondary">Longitude ${i}</label>
                                                    <input type="number" step="any" id="manual-lon-${i}" class="form-input w-full !py-1.5 !text-sm manual-coord-input" data-index="${i-1}" data-coord="lon">
                                                </div>
                                             `).join('')}
                                         </div>
                                    </div>

                                    <button id="generate-area-btn" class="btn btn-primary w-full mt-6">
                                        Terapkan & Simpan Area Aktif
                                    </button>
                                </div>
                            </div>

                            <div class="lg:col-span-2 space-y-6">
                                <div class="text-center">
                                    <p class="text-text-secondary">Peta visualisasi area absensi. Geser penanda untuk mengubah area.</p>
                                    <div id="active-preset-status" class="status-badge success mx-auto mt-2">Area Aktif Telah Diterapkan</div>
                                </div>
                                <div id="gps-editor-map" class="w-full h-80 rounded-lg shadow-inner border border-border-primary z-10"></div>
                                <div class="form-section-card !p-4">
                                    <h3 class="text-lg font-bold text-text-primary mb-4">Simpan & Muat Pengaturan Area</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="new-preset-name" class="block text-sm font-medium mb-1 text-text-secondary">Nama Pengaturan Baru</label>
                                            <div class="flex gap-2">
                                                <input type="text" id="new-preset-name" class="form-input w-full" placeholder="Contoh: Area Belakang Kantor">
                                                <button id="save-preset-btn" class="btn btn-success whitespace-nowrap">Simpan</button>
                                            </div>
                                        </div>
                                        <hr class="border-border-primary">
                                        <div>
                                            <label for="gps-preset-select" class="block text-sm font-medium mb-1 text-text-secondary">Pengaturan Tersimpan</label>
                                            <div class="flex gap-2">
                                                <select id="gps-preset-select" class="form-input w-full"></select>
                                                <button id="load-preset-btn" class="btn btn-primary whitespace-nowrap">Muat</button>
                                                <button id="delete-preset-btn" class="btn btn-danger whitespace-nowrap">Hapus</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-pengaturan" class="tab-pane p-6">
                    <h2 class="text-3xl font-bold mb-6 text-text-primary">Pengaturan Waktu</h2>
                        <div class="form-section-card max-w-3xl mx-auto space-y-8">
                            <div>
                                <h2 class="text-2xl font-bold text-text-primary mb-2">Mode Absensi Pegawai</h2>
                                <p class="text-text-secondary mb-6">Pilih salah satu mode di bawah ini. Mode yang aktif akan diterapkan untuk semua pegawai saat melakukan absensi.</p>
                                
                                <div class="space-y-4">
                                    <div class="bg-black/20 p-4 rounded-lg border border-border-primary has-[:checked]:border-accent-primary has-[:checked]:bg-accent-primary/10 transition-all">
                                        <label for="mode-manual" class="flex items-center cursor-pointer">
                                            <input type="radio" id="mode-manual" name="attendance_mode" value="manual" class="mr-4">
                                            <div>
                                                <p class="font-semibold text-text-primary">Mode Manual (Fleksibel)</p>
                                                <p class="text-sm text-text-secondary mt-1">Pegawai dapat <span class="font-bold text-warning-color">mengatur sendiri</span> tanggal dan waktu absensi. Cocok untuk absensi susulan.</p>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="bg-black/20 p-4 rounded-lg border border-border-primary has-[:checked]:border-accent-primary has-[:checked]:bg-accent-primary/10 transition-all">
                                        <label for="mode-realtime" class="flex items-center cursor-pointer">
                                            <input type="radio" id="mode-realtime" name="attendance_mode" value="realtime" class="mr-4">
                                            <div>
                                                <p class="font-semibold text-text-primary">Mode Waktu Otomatis (Real-time)</p>
                                                <p class="text-sm text-text-secondary mt-1">Tanggal & waktu absensi akan <span class="font-bold text-success-color">terkunci otomatis</span> sesuai waktu saat ini. Pegawai tidak bisa mengubahnya.</p>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="bg-black/20 p-4 rounded-lg border border-border-primary has-[:checked]:border-accent-primary has-[:checked]:bg-accent-primary/10 transition-all">
                                        <label for="mode-window" class="flex items-start cursor-pointer">
                                            <input type="radio" id="mode-window" name="attendance_mode" value="window" class="mr-4 mt-1">
                                            <div>
                                                <p class="font-semibold text-text-primary">Mode Jendela Waktu Wajib</p>
                                                <p class="text-sm text-text-secondary mt-1">Pegawai hanya bisa absen pada <span class="font-bold text-danger-color">hari ini</span> dan dalam <span class="font-bold text-danger-color">rentang waktu yang ditentukan</span>.</p>
                                                <div id="time-window-inputs" class="mt-4 grid grid-cols-2 gap-4 transition-opacity duration-300">
                                                    <div>
                                                        <label for="start-time-setting" class="block text-xs font-medium mb-1 text-text-secondary">Jam Mulai</label>
                                                        <input type="time" id="start-time-setting" class="form-input w-full">
                                                    </div>
                                                    <div>
                                                        <label for="end-time-setting" class="block text-xs font-medium mb-1 text-text-secondary">Jam Selesai</label>
                                                        <input type="time" id="end-time-setting" class="form-input w-full">
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                             <div class="text-center pt-6 border-t border-border-primary">
                                <button id="save-attendance-settings-btn" class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Simpan Pengaturan Absensi
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-pengingat" class="tab-pane p-6">
                        <h2 class="text-3xl font-bold mb-6 text-text-primary">Notifikasi Pengingat</h2>
                        <div class="form-section-card max-w-4xl mx-auto space-y-8">
                            <div>
                                <h2 class="text-2xl font-bold text-text-primary mb-2">Pengaturan Notifikasi Pengingat</h2>
                                <p class="text-text-secondary mb-6">Sistem akan secara otomatis memeriksa pekerjaan yang belum selesai dan menampilkan notifikasi di pojok layar untuk Anda kirimkan via WhatsApp.</p>
                            </div>
                            <div class="pt-6 border-t border-border-primary">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Nomor WhatsApp Pengawas (Penerima Notifikasi)</h3>
                                <p class="text-text-secondary text-sm mb-4">Notifikasi akan disiapkan untuk dikirim ke nomor-nomor di bawah ini. Gunakan format negara, contoh: 6281234567890.</p>
                                <div class="flex gap-4 mb-4">
                                    <input type="number" id="new-whatsapp-number" class="form-input w-full" placeholder="Contoh: 6282260732612">
                                    <button id="add-whatsapp-number-btn" class="btn btn-primary whitespace-nowrap">Tambah Nomor</button>
                                </div>
                                <div id="whatsapp-list-container" class="space-y-3 max-h-48 overflow-y-auto pr-2 mt-6"></div>
                            </div>
                            <div class="pt-6 border-t border-border-primary">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Jadwal Pengecekan Otomatis</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="reminder-interval" class="block text-sm font-medium mb-2 text-text-secondary">Ingatkan Saya Setiap</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="reminder-interval" class="form-input w-full" value="2">
                                            <select id="reminder-unit" class="form-input">
                                                <option value="hours">Jam</option>
                                                <option value="minutes">Menit</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="reminder-start-time" class="block text-sm font-medium mb-2 text-text-secondary">Hanya Aktif Antara Jam</label>
                                        <div class="flex items-center gap-2">
                                            <input type="time" id="reminder-start-time" class="form-input w-full" value="08:00">
                                            <span class="text-text-secondary">-</span>
                                            <input type="time" id="reminder-end-time" class="form-input w-full" value="17:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium mb-2 text-text-secondary">Hanya Aktif Pada Hari</label>
                                    <div id="reminder-days" class="flex flex-wrap gap-2">
                                        <button data-day="1" class="day-toggle-btn active">Sen</button>
                                        <button data-day="2" class="day-toggle-btn active">Sel</button>
                                        <button data-day="3" class="day-toggle-btn active">Rab</button>
                                        <button data-day="4" class="day-toggle-btn active">Kam</button>
                                        <button data-day="5" class="day-toggle-btn active">Jum</button>
                                        <button data-day="6" class="day-toggle-btn">Sab</button>
                                        <button data-day="0" class="day-toggle-btn">Min</button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center pt-6 border-t border-border-primary">
                                <button id="save-reminder-settings-btn" class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Simpan & Aktifkan Pengingat
                                </button>
                                <div class="mt-4 text-sm text-text-secondary" id="reminder-status-log">Status: Pengingat belum aktif. Simpan untuk memulai.</div>
                            </div>
                        </div>
                        <div id="reminder-notification" class="hidden fixed bottom-5 right-5 w-96 glass-card p-4 shadow-xl z-50 fade-in space-y-3">
                            <div class="flex justify-between items-center">
                                <h4 class="font-bold text-lg text-accent-primary">🔔 Pengingat Tugas!</h4>
                                <button id="close-notification-btn" class="text-text-secondary hover:text-white">×</button>
                            </div>
                            <p id="notification-message" class="text-sm text-text-primary">Beberapa pegawai belum menyelesaikan tugasnya hari ini.</p>
                            <div id="notification-whatsapp-buttons" class="max-h-32 overflow-y-auto space-y-2"></div>
                        </div>
                    </div>

                    <div id="tab-keamanan" class="tab-pane p-6">
                        <h2 class="text-3xl font-bold mb-6 text-text-primary">Keamanan Akun</h2>
                        <div class="form-section-card max-w-3xl mx-auto space-y-8 mt-8">
                            <div>
                                <h2 class="text-2xl font-bold text-text-primary mb-2">Manajemen Akses & Password</h2>
                                <p class="text-text-secondary mb-6">Aktifkan atau nonaktifkan kewajiban password untuk setiap peran.</p>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg border border-border-primary">
                                        <div>
                                            <p class="font-semibold text-text-primary">Password Akun Pengawas</p>
                                            <p id="password-toggle-status-pengawas" class="text-sm text-text-secondary mt-1">Status: Memuat...</p>
                                        </div>
                                        <label for="toggle-pengawas" class="toggle-with-text">
                                            <input type="checkbox" id="toggle-pengawas" class="sr-only toggle-input" data-role="pengawas">
                                            <div class="toggle-track">
                                                <div class="toggle-thumb"></div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg border border-border-primary">
                                        <div>
                                            <p class="font-semibold text-text-primary">Password Akun Pegawai</p>
                                            <p id="password-toggle-status-pegawai" class="text-sm text-text-secondary mt-1">Status: Memuat...</p>
                                        </div>
                                        <label for="toggle-pegawai" class="toggle-with-text">
                                            <input type="checkbox" id="toggle-pegawai" class="sr-only toggle-input" data-role="pegawai">
                                            <div class="toggle-track">
                                                <div class="toggle-thumb"></div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg border border-border-primary">
                                        <div>
                                            <p class="font-semibold text-text-primary">Password Akun Pengunjung</p>
                                            <p id="password-toggle-status-pengunjung" class="text-sm text-text-secondary mt-1">Status: Memuat...</p>
                                        </div>
                                        <label for="toggle-pengunjung" class="toggle-with-text">
                                            <input type="checkbox" id="toggle-pengunjung" class="sr-only toggle-input" data-role="pengunjung">
                                            <div class="toggle-track">
                                                <div class="toggle-thumb"></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-6 border-t border-border-primary space-y-4">
                                    <h3 class="text-lg font-semibold text-text-primary">Ganti Password</h3>
                                    <div>
                                        <label for="pengawas-password" class="block mb-2 text-sm font-medium text-text-secondary">Password Pengawas Baru</label>
                                        <div class="relative flex items-center">
                                            <input type="password" id="pengawas-password" class="form-input w-full pr-12" placeholder="Biarkan kosong jika tidak diubah">
                                            <button type="button" class="password-visibility-toggle absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-text-primary">
                                                <svg class="h-6 w-6 eye-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                                <svg class="h-6 w-6 eye-slash-icon hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.664 1.373-3.16 2.458-4.425L13.875 18.825z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.125 10.125L3.175 3.175m17.65 17.65l-7.075-7.075M12 5c.58 0 1.154.067 1.706.196M21.542 12c-.527 1.664-1.373-3.16-2.458-4.425" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.175 3.175L20.825 20.825" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="pegawai-password" class="block mb-2 text-sm font-medium text-text-secondary">Password Pegawai Baru</label>
                                        <div class="relative flex items-center">
                                            <input type="password" id="pegawai-password" class="form-input w-full pr-12" placeholder="Biarkan kosong jika tidak diubah">
                                            <button type="button" class="password-visibility-toggle absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-text-primary">
                                                 <svg class="h-6 w-6 eye-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                                <svg class="h-6 w-6 eye-slash-icon hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.664 1.373-3.16 2.458-4.425L13.875 18.825z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.125 10.125L3.175 3.175m17.65 17.65l-7.075-7.075M12 5c.58 0 1.154.067 1.706.196M21.542 12c-.527 1.664-1.373-3.16-2.458-4.425" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.175 3.175L20.825 20.825" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="pengunjung-password" class="block mb-2 text-sm font-medium text-text-secondary">Password Pengunjung Baru</label>
                                        <div class="relative flex items-center">
                                        <input type="password" id="pengunjung-password" class="form-input w-full pr-12" placeholder="Biarkan kosong jika tidak diubah">
                                            <button type="button" class="password-visibility-toggle absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-text-primary">
                                                 <svg class="h-6 w-6 eye-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                                <svg class="h-6 w-6 eye-slash-icon hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.664 1.373-3.16 2.458-4.425L13.875 18.825z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.125 10.125L3.175 3.175m17.65 17.65l-7.075-7.075M12 5c.58 0 1.154.067 1.706.196M21.542 12c-.527 1.664-1.373-3.16-2.458-4.425" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.175 3.175L20.825 20.825" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center pt-6 border-t border-border-primary">
                                <button id="save-access-settings-btn" class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Simpan Pengaturan Akses
                                </button>
                            </div>
                        </div>

                        <div class="form-section-card max-w-3xl mx-auto space-y-6">
                            <div>
                                <h2 class="text-2xl font-bold text-text-primary mb-2">Manajemen Email Pemulihan</h2>
                                <p class="text-text-secondary">Email ini akan digunakan untuk simulasi pemulihan password akun Pengawas. Anda dapat menambahkan lebih dari satu.</p>
                            </div>
                            <div class="pt-6 border-t border-border-primary">
                                <label for="new-recovery-email-input" class="block text-sm font-medium mb-2 text-text-secondary">Tambah Email Pemulihan Baru</label>
                                <div class="flex gap-4 mb-4">
                                    <input type="email" id="new-recovery-email-input" class="form-input w-full" placeholder="contoh@email.com">
                                    <button id="add-recovery-email-btn" class="btn btn-primary whitespace-nowrap">Tambah</button>
                                </div>
                                <div id="recovery-email-list-container" class="space-y-3 max-h-48 overflow-y-auto pr-2 mt-6"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-diagnostik" class="tab-pane p-6">
                        <h2 class="text-3xl font-bold mb-6 text-text-primary">Diagnostik & Perbaikan Sistem</h2>
                        <div class="form-section-card max-w-4xl mx-auto">
                            <p class="text-text-secondary mb-6">Sistem ini akan memeriksa kesehatan aplikasi secara otomatis. Jika ditemukan masalah (error), sistem akan memberikan evaluasi dan rekomendasi tindakan perbaikan yang bisa Anda jalankan.</p>
                            <div class="text-center">
                                <button id="run-diagnostics-btn" class="btn btn-primary !py-3 !px-8">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3m6-9h3m-18 0h3m12 5.333a8.001 8.001 0 01-14.666 0M12 12a4 4 0 110-8 4 4 0 010 8z"></path></svg>
                                    <span>Jalankan Pengecekan Sistem</span>
                                </button>
                            </div>
                            <div id="diagnostics-results-container" class="mt-8">
                                </div>
                            <div id="diagnostic-fix-container" class="text-center mt-8 pt-6 border-t border-border-primary hidden">
                                <h3 class="text-xl font-bold text-warning-color mb-3">Evaluator: Ditemukan Masalah</h3>
                                <p class="text-text-secondary mb-4">Sistem mendeteksi adanya data lokal yang mungkin rusak atau tidak konsisten. Menjalankan perbaikan akan mengembalikan semua konfigurasi ke kondisi default yang aman. Data absensi Anda di Google Sheets akan tetap utuh.</p>
                                <button id="fix-system-btn" class="btn btn-danger">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    Auto-Action: Jalankan Perbaikan (Reset Data Lokal)
                                </button>
                            </div>
                        </div>
                    </div>

                </main>
                 <footer class="text-center text-text-secondary py-4 px-4 text-sm bg-black bg-opacity-30 flex flex-col md:flex-row items-center justify-center gap-4 mt-auto">
                    <a href="https://drive.google.com/drive/folders/19p00R003mu1NYaezUPpoG1KwI3iAVBWA?usp=sharing" target="_blank" class="btn btn-secondary !py-2 !px-4 text-sm">
                         <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2-2H4a2 2 0 01-2-2V6z"></path></svg>
                        Buka Folder Google Drive
                    </a>
                    <div class="text-left">
                        <p class="font-bold">Penyimpanan Foto: Cek manual (Total 15 GB)</p>
                        <p class="text-xs text-warning-color">**Peringatan:** Jika penyimpanan mendekati 14 GB, harap hapus file foto lama.</p>
                    </div>
                </footer>
            </div>
        </div>
        `;
        showView('supervisor-page-wrapper');
        runSupervisorScript();
    }
    
    /**
     * Merender halaman read-only untuk Pengunjung.
     */
    function renderVisitorPage() {
        const pageContainer = document.getElementById('visitor-page-wrapper');
        pageContainer.innerHTML = `
        <header class="sticky top-0 z-50 glass-card !rounded-none shadow-xl p-4 flex items-center justify-between">
            <div class="flex items-center">
                <img src="Logo MS Str.png" alt="Logo" class="logo-img w-12 h-12 mr-4">
                <div><h1 class="text-xl font-bold text-text-primary">Laporan Absensi</h1><p class="text-sm text-text-secondary">Mahkamah Syar'iyah Simpang Tiga Redelong</p></div>
            </div>
            <button id="logout-btn-visitor" class="btn btn-danger !py-2 !px-4 text-sm">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </header>
        <main class="relative z-10 p-4 md:p-8">
            <div class="w-full max-w-7xl mx-auto glass-card">
                 <div class="card-header text-center p-6"><h2 class="text-2xl font-bold text-text-primary">Rekapan Absensi Petugas</h2></div>
                 <div class="p-6"><div id="attendance-records-container" class="overflow-x-auto"></div></div>
            </div>
        </main>
        <footer class="text-center text-text-secondary py-4 text-sm bg-black bg-opacity-30"><p>Mode Pengunjung - Hanya Lihat</p></footer>`;
        showView('visitor-page-wrapper');
        fetchAttendanceData(true);
        setupLogout('logout-btn-visitor');
    }

    /**
     * Menjalankan semua skrip dan event listener untuk Halaman Login.
     * Menerima employeeList sebagai parameter untuk mempercepat render.
     */
    function renderLoginPage(employeeList = []) {
        showView('login-page');

        const roleSelect = document.getElementById('login-role');
        const usernameSelectContainer = document.getElementById('pegawai-selection-container');
        const usernameSelect = document.getElementById('login-username');
        const passwordContainer = document.getElementById('password-container');
        const passwordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const togglePasswordBtn = document.getElementById('toggle-password-btn');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const passwordStatusText = document.getElementById('password-status-text');
        const exitLoginBtn = document.getElementById('exit-login-btn');
        
        // Gunakan employeeList dari parameter, bukan memanggil getEmployeeList() lagi
        if (employeeList.length > 0) {
            usernameSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama Anda --</option>' + 
                                   employeeList.map(name => `<option value="${name}">${name}</option>`).join('');
        } else {
            usernameSelect.innerHTML = '<option value="" disabled selected>-- Tidak ada data pegawai --</option>';
            const pegawaiOption = roleSelect.querySelector('option[value="Pegawai"]');
            if (pegawaiOption) {
                pegawaiOption.disabled = true;
                pegawaiOption.textContent = 'Pegawai (Tidak ada data)';
            }
        }

        roleSelect.addEventListener('change', () => {
            const role = roleSelect.value;
            const credentials = getCredentials();
            const isPasswordRequired = role ? credentials.passwordStates[role.toLowerCase()] : false;

            usernameSelectContainer.classList.toggle('hidden', role !== 'Pegawai');
            passwordContainer.classList.toggle('hidden', !isPasswordRequired);
            
            if (role === 'Pengawas') {
                forgotPasswordLink.classList.remove('hidden');
            } else {
                forgotPasswordLink.classList.add('hidden');
            }

             exitLoginBtn.classList.toggle('hidden', !role);
            
            let isReadyToLogin = false;
            if (role === 'Pengawas' || role === 'Pengunjung') {
                isReadyToLogin = true;
            } else if (role === 'Pegawai') {
                isReadyToLogin = !!usernameSelect.value && employeeList.length > 0;
            }
            loginBtn.disabled = !isReadyToLogin;
        });

        usernameSelect.addEventListener('change', () => {
            if (usernameSelect.value && roleSelect.value === 'Pegawai') {
                loginBtn.disabled = false;
            }
        });

        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            document.getElementById('eye-icon').classList.toggle('hidden', isPassword);
            document.getElementById('eye-slash-icon').classList.toggle('hidden', !isPassword);
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const role = roleSelect.value;
            const username = usernameSelect.value;
            const password = passwordInput.value;
            const credentials = getCredentials();

            let isAuthenticated = false;
            let userToLog = '';
            
            const isPasswordRequired = role ? credentials.passwordStates[role.toLowerCase()] : false;

            if (role === 'Pengawas') {
                if (!isPasswordRequired || password === credentials.pengawasPassword) {
                    isAuthenticated = true;
                    userToLog = 'Pengawas';
                }
            } else if (role === 'Pegawai') {
                 if (!username) {
                    alert('Silakan pilih nama pegawai.');
                    return;
                }
                if (!isPasswordRequired || password === credentials.pegawaiPassword) {
                    isAuthenticated = true;
                    userToLog = username;
                }
            } else if (role === 'Pengunjung') {
                if (!isPasswordRequired || password === credentials.pengunjungPassword) {
                    isAuthenticated = true;
                    userToLog = 'Pengunjung';
                }
            }

            if (isAuthenticated) {
                sessionStorage.setItem('absenUser', userToLog);
                sessionStorage.setItem('absenRole', role);
                window.location.reload();
            } else {
                alert('Password salah!');
                passwordStatusText.textContent = 'Password yang Anda masukkan salah.';
                passwordStatusText.classList.remove('hidden');
            }
        });
        
    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();

        const credentials = getCredentials();
        const recoveryEmails = credentials.recoveryEmails.map(email => email.toLowerCase());

        if (!recoveryEmails || recoveryEmails.length === 0) {
            alert("Fitur pemulihan password belum diatur oleh administrator.");
            return;
        }

        const enteredEmail = prompt("-- PEMULIHAN PASSWORD --\n\nMasukkan salah satu email pemulihan Anda untuk verifikasi:");

        if (enteredEmail === null) {
            return;
        }

        if (recoveryEmails.includes(enteredEmail.toLowerCase().trim())) {
            alert(`Verifikasi Berhasil!\n\nPassword Pengawas Anda adalah: ${credentials.pengawasPassword}`);
        } else {
            alert("Verifikasi Gagal!\n\nEmail yang Anda masukkan tidak terdaftar sebagai email pemulihan.");
        }
    });

    exitLoginBtn.addEventListener('click', () => {
        roleSelect.value = "";
        usernameSelectContainer.classList.add('hidden');
        passwordContainer.classList.add('hidden');
        forgotPasswordLink.classList.add('hidden');
        exitLoginBtn.classList.add('hidden');
        loginBtn.disabled = true;
    });
    }
    
    // --- ================================== ---
    // ---     LOGIKA INTI & SKRIP HALAMAN      ---
    // --- ================================== ---

    /**
     * Mengatur input tanggal dan waktu ke waktu saat ini.
     */
    function setDateTimeToNow() {
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localDate = new Date(now - timezoneOffset);
        
        const dateInput = document.getElementById('tanggal');
        if (dateInput) {
            dateInput.value = localDate.toISOString().split('T')[0];
        }
        
        const timeInput = document.getElementById('waktu');
        if (timeInput) {
            timeInput.value = localDate.toISOString().split('T')[1].substring(0, 5);
        }
    }
    /**
     * Mengisi dropdown pilihan ruangan dengan data dari localStorage.
     */
    function populateRoomOptions() {
        const roomSelect = document.getElementById('ruang');
        if (!roomSelect) return;

        const roomData = getRoomData();
        const choicesArray = [];

        for (const floor in roomData) {
            choicesArray.push({
                label: floor,
                id: floor,
                disabled: true,
            });
            roomData[floor].forEach(room => {
                choicesArray.push({ value: room, label: room, group: floor });
            });
        }
        
        if (roomChoicesInstance) {
            roomChoicesInstance.destroy();
        }
        
        roomChoicesInstance = new Choices(roomSelect, {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Pilih ruangan...',
        });
        roomChoicesInstance.setChoices(choicesArray, 'value', 'label', true);
    }
    
    // --- PENINGKATAN: Fungsi baru untuk memulai deteksi wajah agar bisa dipanggil ulang.
    function startFaceDetection() {
        const video = document.getElementById('video');
        const snapButton = document.getElementById('snap-button');
        const faceStatusDiv = document.getElementById('face-status');
        
        // Hentikan interval lama jika ada
        if (detectionInterval) {
            clearInterval(detectionInterval);
        }
        
        // Jangan jalankan jika video tidak ada
        if (!video || !snapButton || !faceStatusDiv) return;

        // Jangan jalankan jika face-api gagal dimuat
        if (window.faceApiFailed === true) {
            snapButton.disabled = false;
            faceStatusDiv.innerHTML = "⚠️ Deteksi wajah gagal dimuat. Mode manual.";
            faceStatusDiv.className = `status-badge warning`;
            return;
        }

        detectionInterval = setInterval(async () => {
            const isPhotoTaken = !!document.getElementById('photo-data').value;
            if (isPhotoTaken) return; // Jangan deteksi jika foto sudah diambil
            
            if (typeof faceapi === 'undefined') {
                snapButton.disabled = false;
                faceStatusDiv.innerHTML = "⚠️ Deteksi wajah gagal dimuat. Bypass diaktifkan.";
                faceStatusDiv.className = `status-badge warning`;
                clearInterval(detectionInterval);
                detectionInterval = null;
                return;
            }

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            snapButton.disabled = detections.length === 0;
            faceStatusDiv.innerHTML = detections.length > 0 ? "✅ Wajah terdeteksi, siap mengambil foto." : "❌ Tidak ada wajah terdeteksi.";
            faceStatusDiv.className = `status-badge ${detections.length > 0 ? 'success' : 'danger'}`;
        }, 800); // Interval sedikit diperlambat untuk performa
    }
    /**
     * Menjalankan semua skrip yang diperlukan untuk halaman absensi pegawai.
     */
    function runAttendanceScript() {
        const form = document.getElementById('attendance-form'), video = document.getElementById('video'), canvas = document.getElementById('canvas'),
                photoPreview = document.getElementById('photo-preview'), snapButton = document.getElementById('snap-button'), retakeButton = document.getElementById('retake-button'),
                photoDataInput = document.getElementById('photo-data'), faceStatusDiv = document.getElementById('face-status'),
                faceOverlay = document.getElementById('face-validation-overlay'), gpsInput = document.getElementById('gps'),
                gpsStatusDiv = document.getElementById('gps-status'), submitButton = document.getElementById('submit-button'),
                submitStatus = document.getElementById('submit-status'), timeWindowStatusDiv = document.getElementById('time-window-status');

        const attendanceSettings = getDataFromCache('attendanceSettings', { mode: 'manual' });
        const dateInput = document.getElementById('tanggal');
        const timeInput = document.getElementById('waktu');

        if (attendanceSettings.mode === 'realtime' || attendanceSettings.mode === 'window') {
            dateInput.readOnly = true;
            timeInput.readOnly = true;
            dateInput.title = "Tanggal & waktu diatur otomatis oleh pengawas.";
            timeInput.title = "Tanggal & waktu diatur otomatis oleh pengawas.";
            setDateTimeToNow();
        }

        if (attendanceSettings.mode === 'window') {
            const { startTime, endTime } = attendanceSettings;
            if (startTime && endTime) {
                timeWindowStatusDiv.textContent = `Absensi hanya bisa dilakukan antara jam ${startTime} - ${endTime}.`;
                timeWindowStatusDiv.classList.remove('hidden');
            }
        }
        
        const fillMyRoomsBtn = document.getElementById('fill-my-rooms-btn');
        if (fillMyRoomsBtn) {
            fillMyRoomsBtn.onclick = () => {
                const loggedInUser = document.getElementById('nama').value;
                const allocations = getJobAllocations();
                const userAllocation = allocations.find(alloc => alloc.name === loggedInUser);

                if (userAllocation) {
                    const roomsLantai1 = (userAllocation.roomsLantai1 || '').split(',').map(r => r.trim()).filter(Boolean);
                    const roomsLantai2 = (userAllocation.roomsLantai2 || '').split(',').map(r => r.trim()).filter(Boolean);
                    const allMyRooms = [...roomsLantai1, ...roomsLantai2];

                    if (allMyRooms.length > 0 && roomChoicesInstance) {
                        roomChoicesInstance.setValue(allMyRooms);
                        alert('Ruangan telah diisi sesuai dengan pembagian tugas Anda.');
                    } else {
                        alert('Tidak ada ruangan yang ditugaskan untuk Anda dalam data pembagian tugas.');
                    }
                } else {
                    alert('Pembagian tugas untuk Anda tidak ditemukan.');
                }
            };
        }

        let map = null;

        const isInside = (point, polygon) => {
            const x = point[0], y = point[1]; let isInside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1], xj = polygon[j][0], yj = polygon[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) isInside = !isInside;
            }
            return isInside;
        };
        
        const initMap = (userLocation) => {
            const officePolygonCoords = getActivePolygon();
            if (!map) {
                map = L.map('map').setView(userLocation, 18);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri'
                }).addTo(map);
            } else { map.setView(userLocation, 18); }

            if (isInside(userLocation, officePolygonCoords)) {
                L.polygon(officePolygonCoords, {color: 'var(--success-color)'}).addTo(map);
                L.marker(userLocation).addTo(map).bindPopup('Lokasi Anda').openPopup();
                gpsStatusDiv.innerHTML = "✅ Anda berada di dalam area kantor"; gpsStatusDiv.className = 'status-badge success';
            } else {
                L.polygon(officePolygonCoords, {color: 'var(--danger-color)'}).addTo(map);
                L.marker(userLocation).addTo(map).bindPopup('Posisi Anda Saat Ini.').openPopup();
                gpsStatusDiv.innerHTML = "⛔️ Anda di luar jangkauan area kantor"; gpsStatusDiv.className = 'status-badge danger';
            }
            checkConditionsAndEnableSubmit();
        };

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const userLocation = [pos.coords.latitude, pos.coords.longitude];
                gpsInput.value = `${userLocation[0]}, ${userLocation[1]}`;
                if (window.L) { initMap(userLocation); }
            },
            (err) => {
                gpsInput.value = 'GPS gagal: ' + err.message;
                gpsStatusDiv.innerHTML = "❌ Gagal mendapatkan lokasi GPS"; gpsStatusDiv.className = 'status-badge danger';
                checkConditionsAndEnableSubmit();
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
        
        function initializeCamera() {
             navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(s => {
                stream = s; 
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    startFaceDetection();
                };
            }).catch(err => {
                alert('Kamera gagal diakses: ' + err.message);
                faceStatusDiv.innerHTML = "❌ Kamera tidak dapat diakses."; 
                faceStatusDiv.className = 'status-badge danger';
                if(detectionInterval) clearInterval(detectionInterval);
            });
        }
        
        initializeCamera();
        
        snapButton.addEventListener('click', async () => {
            if (window.faceApiFailed !== true && typeof faceapi !== 'undefined') {
                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
                if (!detections) {
                    faceOverlay.style.opacity = '1'; faceOverlay.innerText = "Wajah tidak terdeteksi. Coba lagi.";
                    setTimeout(() => { faceOverlay.style.opacity = '0'; }, 3000);
                    return;
                }
            }
            
            if(detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            const MAX_WIDTH = 640;
            const scale = MAX_WIDTH / video.videoWidth;
            canvas.width = MAX_WIDTH;
            canvas.height = video.videoHeight * scale;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
            photoPreview.src = dataUrl; photoDataInput.value = dataUrl.split(',')[1];
            video.classList.add('hidden'); photoPreview.classList.remove('hidden');
            snapButton.classList.add('hidden'); retakeButton.classList.remove('hidden');
            faceStatusDiv.innerHTML = "✅ Foto berhasil diambil!"; faceStatusDiv.className = 'status-badge success';
            checkConditionsAndEnableSubmit();
        });

        retakeButton.addEventListener('click', () => {
            photoPreview.classList.add('hidden'); video.classList.remove('hidden');
            snapButton.classList.remove('hidden'); retakeButton.classList.add('hidden');
            photoDataInput.value = ''; 
            faceStatusDiv.innerHTML = "Menunggu deteksi wajah..."; faceStatusDiv.className = 'status-badge warning';
            
            startFaceDetection();
            
            checkConditionsAndEnableSubmit();
        });

        function checkConditionsAndEnableSubmit() {
            const isGpsValid = gpsStatusDiv.classList.contains('success');
            const isPhotoPresent = photoDataInput.value !== '';
            let isTimeValid = true;
            let timeStatusText = '';

            const attendanceSettings = getDataFromCache('attendanceSettings', { mode: 'manual' });
            if (attendanceSettings.mode === 'window') {
                const { startTime, endTime } = attendanceSettings;
                if (startTime && endTime) {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5);
                    if (currentTime < startTime || currentTime > endTime) {
                        isTimeValid = false;
                        timeStatusText = `Di luar jam absen wajib (${startTime} - ${endTime})`;
                    }
                }
            }

            if (isGpsValid && isPhotoPresent && isTimeValid) {
                submitButton.disabled = false;
                submitStatus.innerText = "";
                document.getElementById('submit-btn-text').innerText = "Kirim ke Pengawas";
            } else {
                submitButton.disabled = true;
                let statusText = [];
                if (!isGpsValid) statusText.push("Lokasi GPS belum valid");
                if (!isPhotoPresent) statusText.push("Foto belum diambil");
                if (!isTimeValid) statusText.push(timeStatusText);
                submitStatus.innerText = "Tombol nonaktif: " + statusText.join(' & ');
                document.getElementById('submit-btn-text').innerText = "Lengkapi Data";
            }
        }
        checkConditionsAndEnableSubmit();

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(form);
            
            if (roomChoicesInstance) {
                formData.set('nama_ruang', roomChoicesInstance.getValue(true).join(', '));
            }
            
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - timezoneOffset).toISOString(); // Dibuat lebih presisi dengan milidetik

// BUAT ID YANG DIJAMIN UNIK dengan menambahkan angka acak di akhir
const uniqueId = `${localISOTime}-${Math.random().toString(36).substring(2, 9)}`;
formData.set('timestamp', uniqueId); // Kirim ID unik ini sebagai timestamp
            const tanggalInput = document.getElementById('tanggal').value;
            const waktuInput = document.getElementById('waktu').value;
            if (!tanggalInput || !waktuInput) {
                alert('Tanggal dan Waktu wajib diisi!');
                return;
            }
            const dateParts = tanggalInput.split('-');
            const dateObj = new Date(Date.UTC(dateParts[0], parseInt(dateParts[1], 10) - 1, dateParts[2]));
            const formattedDate = dateObj.toLocaleString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
            formData.set('tanggal', formattedDate);
            formData.set('waktu', `${waktuInput} WIB`);

            if (!photoDataInput.value) { alert('Anda harus mengambil foto terlebih dahulu!'); return; }
            const submitBtnText = document.getElementById('submit-btn-text');
            const submitLoader = document.getElementById('submit-loader');
            submitButton.disabled = true; submitBtnText.classList.add('hidden'); submitLoader.classList.remove('hidden');
            submitStatus.innerText = 'Mengirim data dan foto, mohon tunggu...';
            submitStatus.style.color = 'var(--accent-primary)';

            try {
                const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.result === 'success') {
                    alert('Absensi berhasil dikirim!');
                    submitStatus.innerText = 'Berhasil dikirim! Anda bisa absen lagi.';
                    submitStatus.style.color = 'var(--success-color)';
                    form.reset();
                    if (roomChoicesInstance) {
                        roomChoicesInstance.clearStore();
                        roomChoicesInstance.clearInput();
                    }
                    if(retakeButton) retakeButton.click(); 
                    
                    const attendanceSettings = getDataFromCache('attendanceSettings', { mode: 'manual' });
                    if(attendanceSettings.mode === 'realtime' || attendanceSettings.mode === 'window') {
                        setDateTimeToNow();
                    }
                    checkConditionsAndEnableSubmit();
                } else { 
                    alert('Gagal mengirim: ' + (JSON.stringify(result.error) || 'Unknown error')); 
                    submitStatus.innerText = 'Gagal mengirim data.';
                    submitStatus.style.color = 'var(--danger-color)';
                }
            } catch (err) {
                alert('Terjadi error: ' + err.message);
                submitStatus.innerText = 'Terjadi error jaringan. Pastikan Anda menjalankan file ini dari web server.';
                submitStatus.style.color = 'var(--danger-color)';
            } finally {
                if(submitStatus.style.color !== 'var(--success-color)') {
                     checkConditionsAndEnableSubmit();
                }
                submitBtnText.classList.remove('hidden'); 
                submitLoader.classList.add('hidden');
                setTimeout(() => { if(submitStatus) submitStatus.innerText = ''; }, 5000);
            }
        });
        setupLogout('logout-btn-attendance');
    }
    
    function initGpsEditor() {
        let map, polygon, centerMarker, cornerMarkers = [];
        const modeRadios = document.querySelectorAll('input[name="gps_mode"]');
        const centerSizeModeContainer = document.getElementById('center-size-mode-container');
        const manualModeContainer = document.getElementById('manual-mode-container');
        const generateAreaBtn = document.getElementById('generate-area-btn');
        const presetNameInput = document.getElementById('new-preset-name');
        const savePresetBtn = document.getElementById('save-preset-btn');
        const presetSelect = document.getElementById('gps-preset-select');
        const loadPresetBtn = document.getElementById('load-preset-btn');
        const deletePresetBtn = document.getElementById('delete-preset-btn');

        function initializeMap(center) {
            if (map) return;
            map = L.map('gps-editor-map').setView([center.lat, center.lon], 18);
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' });
            const baseMaps = { "Satelit": satelliteLayer, "Peta Jalan": osmLayer };
            L.control.layers(baseMaps).addTo(map);
            satelliteLayer.addTo(map);
        }

        const unitFactors = { km: 1000, m: 1 };
        const degreesToRadians = (d) => d * Math.PI / 180;
        const radiansToDegrees = (r) => r * 180 / Math.PI;

        function calculateBoundingBox(centerLat, centerLon, sideLengthMeters) {
            const R = 6378137;
            const latRad = degreesToRadians(centerLat);
            const halfSide = sideLengthMeters / 2;
            const latDelta = radiansToDegrees(halfSide / R);
            const lonDelta = radiansToDegrees(halfSide / (R * Math.cos(latRad)));
            return [
                [centerLat + latDelta, centerLon - lonDelta],
                [centerLat + latDelta, centerLon + lonDelta],
                [centerLat - latDelta, centerLon + lonDelta],
                [centerLat - latDelta, centerLon - lonDelta]
            ];
        }

        function updatePolygonOnMap(coords) {
            if (!polygon) {
                polygon = L.polygon(coords, { color: 'var(--accent-primary)' }).addTo(map);
            } else {
                polygon.setLatLngs(coords);
            }
            map.fitBounds(polygon.getBounds(), { padding: [20, 20] });
        }
        
        function updateFormInputsFromCoords(coords) {
            for (let i = 0; i < 4; i++) {
                document.getElementById(`manual-lat-${i+1}`).value = coords[i][0].toFixed(8);
                document.getElementById(`manual-lon-${i+1}`).value = coords[i][1].toFixed(8);
            }
            const centerLat = (coords[0][0] + coords[3][0]) / 2;
            const centerLon = (coords[0][1] + coords[1][1]) / 2;
            document.getElementById('center-lat-input').value = centerLat.toFixed(8);
            document.getElementById('center-lon-input').value = centerLon.toFixed(8);
        }

        /**
         * PERBAIKAN: Fungsi ini sekarang menyimpan ke Google Sheet juga
         */
        async function saveAndNotify(coords) {
            generateAreaBtn.disabled = true;
            generateAreaBtn.innerHTML = `<div class="loader inline-loader"></div> Menyimpan...`;
            try {
                // Panggil fungsi untuk update ke local storage DAN Google Sheet
                await updateAndSaveData('activeGpsCoords', coords);
                document.getElementById('active-preset-status').textContent = 'Area Aktif Telah Diterapkan';
                alert('Area absensi baru berhasil diterapkan dan disimpan di server!');
            } catch (error) {
                console.error("Gagal menyimpan area GPS ke server:", error);
                alert("Gagal menyimpan area GPS ke server. Perubahan hanya tersimpan sementara di perangkat ini.");
            } finally {
                generateAreaBtn.disabled = false;
                generateAreaBtn.textContent = 'Terapkan & Simpan Area Aktif';
            }
        }
        
        function renderPresetOptions() {
            const presets = getGpsPresets();
            presetSelect.innerHTML = presets.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        }

        async function handleSavePreset() {
            const name = presetNameInput.value;
            if (!name.trim()) {
                alert("Silakan masukkan nama untuk preset area ini.");
                return;
            }
            const currentCoords = polygon.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
            if (await addGpsPreset(name, currentCoords)) {
                alert(`Preset '${name}' berhasil disimpan!`);
                renderPresetOptions();
                presetSelect.value = name;
                presetNameInput.value = '';
            }
        }

        function handleLoadPreset() {
            const selectedName = presetSelect.value;
            const presets = getGpsPresets();
            const selectedPreset = presets.find(p => p.name === selectedName);
            if (selectedPreset) {
                updatePolygonOnMap(selectedPreset.coords);
                updateFormInputsFromCoords(selectedPreset.coords);
                alert(`Preset '${selectedName}' berhasil dimuat. Tekan "Terapkan & Simpan" untuk menjadikannya area aktif.`);
            }
        }

        async function handleDeletePreset() {
            const selectedName = presetSelect.value;
            if (selectedName === "Area Kantor MS Redelong (Default)") {
                 alert("Preset default tidak dapat dihapus."); return;
            }
            if (confirm(`Anda yakin ingin menghapus preset '${selectedName}'?`)) {
                await removeGpsPreset(selectedName);
                renderPresetOptions();
                alert(`Preset '${selectedName}' telah dihapus.`);
            }
        }
        
        function setupCenterSizeMode() {
            centerSizeModeContainer.classList.remove('hidden');
            manualModeContainer.classList.add('hidden');
            cornerMarkers.forEach(m => m.remove());
            cornerMarkers = [];
            const centerIcon = L.divIcon({ className: 'center-marker-icon', html: `<b>C</b>` });
            const coords = polygon.getCenter();
            if (centerMarker) centerMarker.remove();
            centerMarker = L.marker(coords, { draggable: true, icon: centerIcon }).addTo(map);
            centerMarker.on('dragend', () => {
                const newCenter = centerMarker.getLatLng();
                document.getElementById('center-lat-input').value = newCenter.lat.toFixed(8);
                document.getElementById('center-lon-input').value = newCenter.lng.toFixed(8);
            });
        }
        
        function setupManualMode() {
            manualModeContainer.classList.remove('hidden');
            centerSizeModeContainer.classList.add('hidden');
            if (centerMarker) centerMarker.remove();
            const currentCoords = polygon.getLatLngs()[0];
            cornerMarkers.forEach(m => m.remove());
            cornerMarkers = [];
            for (let i = 0; i < 4; i++) {
                const markerIcon = L.divIcon({ className: 'corner-marker-icon', html: `<b>${i+1}</b>` });
                const marker = L.marker(currentCoords[i], { draggable: true, icon: markerIcon }).addTo(map);
                marker.on('drag', () => {
                    const latlng = marker.getLatLng();
                    document.getElementById(`manual-lat-${i+1}`).value = latlng.lat.toFixed(8);
                    document.getElementById(`manual-lon-${i+1}`).value = latlng.lng.toFixed(8);
                    const newCoords = cornerMarkers.map(m => m.getLatLng());
                    if (polygon) {
                        polygon.setLatLngs(newCoords);
                    }
                });
                cornerMarkers.push(marker);
            }
        }

        modeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            const activeMode = e.target.value;
            if (activeMode === 'center_size') setupCenterSizeMode();
            else setupManualMode();
        }));
        
        generateAreaBtn.addEventListener('click', () => {
            const activeMode = document.querySelector('input[name="gps_mode"]:checked').value;
            let newCoords;
            if (activeMode === 'center_size') {
                const centerLat = parseFloat(document.getElementById('center-lat-input').value);
                const centerLon = parseFloat(document.getElementById('center-lon-input').value);
                const size = parseFloat(document.getElementById('area-size-input').value);
                const unit = document.getElementById('area-unit-select').value;
                if (isNaN(centerLat) || isNaN(centerLon) || isNaN(size)) {
                    alert('Pastikan Latitude, Longitude, dan Ukuran Area diisi angka valid.'); return;
                }
                newCoords = calculateBoundingBox(centerLat, centerLon, size * unitFactors[unit]);
            } else {
                newCoords = [];
                for(let i=0; i<4; i++){
                    const lat = parseFloat(document.getElementById(`manual-lat-${i+1}`).value);
                    const lon = parseFloat(document.getElementById(`manual-lon-${i+1}`).value);
                    if (isNaN(lat) || isNaN(lon)) {
                         alert(`Koordinat Titik ${i+1} tidak valid.`); return;
                    }
                    newCoords.push([lat, lon]);
                }
            }
            updatePolygonOnMap(newCoords);
            saveAndNotify(newCoords); // Panggil fungsi yang sudah diperbaiki
        });

        document.getElementById('geolocate-btn').addEventListener('click', (e) => {
            if (!navigator.geolocation) return alert('Browser tidak mendukung geolokasi.');
            const btn = e.currentTarget;
            btn.innerHTML = `<div class="loader inline-loader !w-4 !h-4 !border-2"></div> Mencari...`;
            btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('center-lat-input').value = pos.coords.latitude.toFixed(8);
                    document.getElementById('center-lon-input').value = pos.coords.longitude.toFixed(8);
                    btn.innerHTML = 'Gunakan Lokasi Saya Saat Ini';
                    btn.disabled = false;
                },
                () => {
                    alert('Gagal mendapatkan lokasi Anda.');
                    btn.innerHTML = 'Gunakan Lokasi Saya Saat Ini';
                    btn.disabled = false;
                }
            );
        });
        
        document.querySelectorAll('.manual-coord-input').forEach(input => {
            input.addEventListener('change', () => {
                const newCoords = [];
                for(let i=0; i<4; i++){
                    const lat = parseFloat(document.getElementById(`manual-lat-${i+1}`).value);
                    const lon = parseFloat(document.getElementById(`manual-lon-${i+1}`).value);
                    if (!isNaN(lat) && !isNaN(lon)) newCoords.push([lat, lon]); else return;
                }
                updatePolygonOnMap(newCoords);
            });
        });
        
        savePresetBtn.addEventListener('click', handleSavePreset);
        loadPresetBtn.addEventListener('click', handleLoadPreset);
        deletePresetBtn.addEventListener('click', handleDeletePreset);

        const savedCoords = getActivePolygon();
        initializeMap(defaultOfficeCenter);
        updatePolygonOnMap(savedCoords);
        updateFormInputsFromCoords(savedCoords);
        setupCenterSizeMode();
        renderPresetOptions();
        return map;
    }
    
    function formatDateForDisplay(dateObj) {
        if (!dateObj || isNaN(new Date(dateObj).getTime())) {
            return 'Format Salah';
        }
        const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
        return new Date(dateObj).toLocaleDateString('id-ID', options);
    }
    
    async function fetchAttendanceData(isReadOnly = false) {
        const container = document.getElementById('attendance-records-container');
        if (!container) return;

        container.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 text-center" style="min-height: 300px;">
                <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p class="text-text-secondary text-lg font-medium">Memuat data absensi...</p>
                <p class="text-text-secondary text-sm">Mohon tunggu sebentar, proses ini mungkin memakan waktu beberapa saat.</p>
            </div>`;

        try {
            const response = await fetch(`${SPREADSHEET_URL}?t=${new Date().getTime()}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gagal mengambil data dari server (Status: ${response.status}). Pesan: ${errorText}`);
            }
            
            const responseData = await response.json();
            if (responseData.result === 'error') {
                throw new Error(responseData.error || "Terjadi error di server Apps Script.");
            }

            if (!Array.isArray(responseData)) {
                throw new Error("Format data yang diterima dari server tidak valid (bukan array).");
            }
            
            fullAttendanceData = responseData.map(row => {
                const parsedDate = new Date(row.timestamp);
                return {
                    ...row,
                    parsedDate: !isNaN(parsedDate.getTime()) ? parsedDate : null
                };
            }).sort((a, b) => {
                const dateA = a.parsedDate ? a.parsedDate.getTime() : 0;
                const dateB = b.parsedDate ? b.parsedDate.getTime() : 0;
                return dateB - dateA;
            });

            renderTable(fullAttendanceData, isReadOnly);

        } catch (error) {
            console.error('Error fetching attendance data:', error);
            container.innerHTML = `
                <div class="form-section-card !bg-danger-color/10 border-danger-color/50 !p-6 text-center">
                    <h3 class="text-2xl font-bold text-danger-color mb-3">Gagal Memuat Data Absensi</h3>
                    <p class="text-text-secondary mb-4">Terjadi masalah saat mencoba mengambil data dari Google Sheet. Halaman tidak bisa ditampilkan.</p>
                    <div class="text-left text-sm bg-black/20 p-4 rounded-lg mb-4">
                        <strong>Detail Error:</strong>
                        <pre class="whitespace-pre-wrap text-warning-color mt-1">${error.message}</pre>
                    </div>
                    <strong class="text-text-primary">Langkah yang bisa dicoba:</strong>
                    <ul class="list-disc list-inside text-left text-text-secondary mt-2 space-y-1">
                        <li>Pastikan Anda terhubung ke internet.</li>
                        <li>Coba muat ulang (refresh) halaman ini.</li>
                        <li>Pastikan Google Apps Script sudah di-deploy ulang dengan benar (Akses: "Anyone").</li>
                        <li>Pastikan Anda menjalankan file HTML ini dari Web Server (contoh: ekstensi Live Server di VS Code), bukan dibuka langsung sebagai file.</li>
                    </ul>
                </div>`;
        }
    }
    
    function renderTable(data, isReadOnly = false) {
        const container = document.getElementById('attendance-records-container');
        if (!container) return;
        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-text-secondary py-8">Tidak ada data absensi ditemukan untuk filter ini.</p>';
            return;
        }

        const tableHTML = `
            <table class="report-table" id="report-table-screen">
                <thead>
                    <tr>
                        ${!isReadOnly ? '<th><input type="checkbox" id="select-all-checkbox" title="Pilih Semua"></th>' : ''}
                        <th>Nama</th><th class="w-1/4">Ruangan</th><th>Tanggal</th><th>Waktu</th>
                        <th>GPS</th><th>Penilaian</th>
                        ${!isReadOnly ? '<th>Aksi</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => {
                        const formattedDate = row.tanggal || (row.parsedDate ? formatDateForDisplay(row.parsedDate) : 'N/A');
                        const formattedTime = row.waktu || (row.parsedDate ? row.parsedDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' }) + ' WIB' : '');
                        const gpsLink = row.gps ? `https://www.google.com/maps?q=${row.gps}` : '#';
                        
                        return `
                        <tr data-timestamp="${row.timestamp || ''}">
                            ${!isReadOnly ? `<td><input type="checkbox" class="row-checkbox" data-timestamp="${row.timestamp}"></td>` : ''}
                            <td>${row.nama || ''}</td>
                            <td class="room-cell">${row.nama_ruang || ''}</td>
                            <td id="date-cell-${row.timestamp}">${formattedDate}</td>
                            <td id="time-cell-${row.timestamp}">${formattedTime}</td>
                            <td><a href="${gpsLink}" target="_blank" class="text-accent-primary hover:underline">${(row.gps || '').substring(0,20)}...</a></td>
                            <td id="assessment-cell-${row.timestamp}">
                                ${isReadOnly ? (row.penilaian || '<em>Belum dinilai</em>') : `
                                <div class="flex items-center">
                                <select class="assessment-select" onchange="handleAssessmentChange('${row.timestamp}', this)">
                                    <option value="">-- Beri Nilai --</option>
                                    <option value="Baik" ${row.penilaian === 'Baik' ? 'selected' : ''}>Baik</option>
                                    <option value="Cukup Baik" ${row.penilaian === 'Cukup Baik' ? 'selected' : ''}>Cukup Baik</option>
                                    <option value="Kurang Baik" ${row.penilaian === 'Kurang Baik' ? 'selected' : ''}>Kurang Baik</option>
                                </select>
                                <span id="status-${row.timestamp}" class="ml-2"></span>
                                </div>
                                `}
                            </td>
                            ${!isReadOnly ? `<td id="action-cell-${row.timestamp}">
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary !py-1 !px-2 text-xs" onclick="editRecord('${row.timestamp}')" title="Edit Tanggal/Waktu"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>Edit</button>
                                    <button class="btn btn-danger !py-1 !px-2 text-xs" onclick="deleteRecord('${row.timestamp}')" title="Hapus Data"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Hapus</button>
                                </div>
                                </td>` : ''}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
        container.innerHTML = tableHTML;
        if (!isReadOnly) setupBulkActions();
    }
    
    function editRecord(timestamp) {
        if (editingState.timestamp && editingState.timestamp !== timestamp) {
            cancelEdit(editingState.timestamp);
        }
        const dateCell = document.getElementById(`date-cell-${timestamp}`);
        const timeCell = document.getElementById(`time-cell-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        if (!dateCell || !timeCell || !actionCell) return;

        const originalRowData = fullAttendanceData.find(row => row.timestamp === timestamp);
        if (!originalRowData || !originalRowData.parsedDate) {
            alert("Data tanggal asli tidak valid, tidak bisa mengedit.");
            return;
        }

        editingState = {
            timestamp: timestamp,
            originalDateHTML: dateCell.innerHTML,
            originalTimeHTML: timeCell.innerHTML
        };
        
        const dateForInput = new Date(originalRowData.parsedDate.getTime() - (originalRowData.parsedDate.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        const timeValue = originalRowData.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        dateCell.innerHTML = `<input type="date" id="date-input-${timestamp}" class="date-time-input" value="${dateForInput}">`;
        timeCell.innerHTML = `<input type="time" id="time-input-${timestamp}" class="date-time-input" value="${timeValue}">`;
        actionCell.innerHTML = `
            <div class="flex gap-2">
                <button class="btn btn-success !p-2 text-xs icon-only" onclick="saveRecord('${timestamp}')" title="Simpan"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                <button class="btn btn-secondary !p-2 text-xs icon-only" onclick="cancelEdit('${timestamp}')" title="Batal"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
        `;
    }

    function cancelEdit(timestamp) {
        const dateCell = document.getElementById(`date-cell-${timestamp}`);
        const timeCell = document.getElementById(`time-cell-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        if (editingState.timestamp === timestamp) {
            dateCell.innerHTML = editingState.originalDateHTML;
            timeCell.innerHTML = editingState.originalTimeHTML;
             actionCell.innerHTML = `
                <div class="flex gap-2">
                    <button class="btn btn-secondary !py-1 !px-2 text-xs" onclick="editRecord('${timestamp}')" title="Edit"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>Edit</button>
                    <button class="btn btn-danger !py-1 !px-2 text-xs" onclick="deleteRecord('${timestamp}')" title="Hapus"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Hapus</button>
                </div>`;
            editingState = {}; 
        }
    }

    async function saveRecord(timestamp) {
        const newDateInput = document.getElementById(`date-input-${timestamp}`);
        const newTimeInput = document.getElementById(`time-input-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        if (!newDateInput.value || !newTimeInput.value) {
            alert('Tanggal dan waktu tidak boleh kosong!'); return;
        }
        actionCell.innerHTML = `<div class="loader !w-6 !h-6 mx-auto"></div>`;
        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('timestamp', timestamp);
        formData.append('newDate', newDateInput.value);
        formData.append('newTime', newTimeInput.value);
        try {
            const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            const result = await res.json();
            if (result.result === 'success') {
                alert('Data berhasil diperbarui! Memuat ulang data...');
                await fetchAttendanceData(false); 
            } else { throw new Error(result.error || 'Gagal memperbarui data di server.'); }
        } catch (error) {
            alert(`Gagal menyimpan perubahan: ${error.message}`);
            cancelEdit(timestamp);
        }
    }
    
    async function handleAssessmentChange(timestamp, selectElement) {
        const value = selectElement.value;
        const statusSpan = document.getElementById(`status-${timestamp}`);
        if (!statusSpan) return;
        statusSpan.innerHTML = `<div class="loader inline-loader"></div>`;
        selectElement.disabled = true;
        try {
            await updateAssessment(timestamp, value);
            statusSpan.innerHTML = `✅`;
        } catch (error) {
            statusSpan.innerHTML = `❌`;
            alert(`Gagal menyimpan penilaian. Coba lagi.\nError: ${error.reason}`);
            const originalData = fullAttendanceData.find(d => d.timestamp === timestamp);
            if (originalData) selectElement.value = originalData.penilaian || "";
        } finally {
            selectElement.disabled = false;
            setTimeout(() => { statusSpan.innerHTML = ''; }, 3000);
        }
    }

    async function updateAssessment(timestamp, value) {
        if (!timestamp) {
            return Promise.reject(new Error("Timestamp tidak valid."));
        }
        const formData = new FormData();
        formData.append('action', 'updateAssessment');
        formData.append('timestamp', timestamp);
        formData.append('penilaian', value);
        try {
            const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            if (!res.ok) { throw new Error(`Network response was not ok: ${res.statusText}`); }
            const result = await res.json();
            if (result.result !== 'success') {
                throw new Error(result.error || 'Server error during assessment update');
            }
            const dataIndex = fullAttendanceData.findIndex(d => d.timestamp === timestamp);
            if(dataIndex > -1) fullAttendanceData[dataIndex].penilaian = value;
            return { status: 'fulfilled', timestamp };
        } catch (error) {
            console.error(`Error saat memperbarui penilaian untuk ${timestamp}:`, error);
            return Promise.reject({ status: 'rejected', timestamp, reason: error.message });
        }
    }
    
    function setupBulkActions() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkActionPanel = document.getElementById('bulk-action-panel');
        const selectionCount = document.getElementById('selection-count');
        const applyBtn = document.getElementById('apply-bulk-action-btn');
        const bulkSelect = document.getElementById('bulk-assessment-select');
        const bulkDeleteBtn = document.getElementById('apply-bulk-delete-btn');
        if (!selectAllCheckbox) return;

        function updatePanelVisibility() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (checkedCount > 0) {
                bulkActionPanel.classList.remove('hidden');
                selectionCount.textContent = `${checkedCount} data terpilih`;
            } else {
                bulkActionPanel.classList.add('hidden');
            }
            selectAllCheckbox.checked = checkedCount > 0 && checkedCount === rowCheckboxes.length;
        }

        selectAllCheckbox.addEventListener('change', () => {
            rowCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updatePanelVisibility();
        });
        rowCheckboxes.forEach(cb => cb.addEventListener('change', updatePanelVisibility));

        applyBtn.addEventListener('click', async () => {
            const valueToApply = bulkSelect.value;
            if (!valueToApply) {
                alert('Pilih nilai yang akan diterapkan!'); return;
            }
            const checkedBoxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            const timestampsToUpdate = checkedBoxes.map(cb => cb.dataset.timestamp).filter(Boolean);
            if (timestampsToUpdate.length === 0) return;
            
            applyBtn.disabled = true;
            applyBtn.innerHTML = `<div class="loader !w-4 !h-4"></div>`;
            
            const results = await Promise.allSettled(timestampsToUpdate.map(ts => updateAssessment(ts, valueToApply)));
            
            let successCount = 0;
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    successCount++;
                    const row = document.querySelector(`tr[data-timestamp="${result.value.timestamp}"]`);
                    if (row) {
                        const assessmentSelect = row.querySelector('.assessment-select');
                        if (assessmentSelect) assessmentSelect.value = valueToApply;
                        row.classList.add('flash-success');
                        setTimeout(() => row.classList.remove('flash-success'), 1500);
                    }
                }
            });

            applyBtn.disabled = false;
            applyBtn.innerHTML = 'Terapkan';

            let alertMessage = `Operasi selesai. ${successCount} dari ${timestampsToUpdate.length} data berhasil diperbarui.`;
            const failureCount = timestampsToUpdate.length - successCount;
            if (failureCount > 0) {
                alertMessage += `\n${failureCount} data GAGAL diperbarui karena masalah jaringan atau server.`;
            }
            alert(alertMessage);
            
            checkedBoxes.forEach(cb => cb.checked = false);
            updatePanelVisibility();
        });
        
        bulkDeleteBtn.addEventListener('click', async () => {
            const checkedBoxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            const timestampsToDelete = checkedBoxes.map(cb => cb.dataset.timestamp).filter(Boolean);
            if (timestampsToDelete.length === 0) return;
            if (!confirm(`Yakin ingin menghapus ${timestampsToDelete.length} data terpilih secara permanen?`)) return;
            bulkDeleteBtn.disabled = true;
            bulkDeleteBtn.innerHTML = `<div class="loader !w-4 !h-4"></div>`;
            const results = await Promise.allSettled(timestampsToDelete.map(ts => deleteRecord(ts, false)));
            let successCount = 0;
            results.forEach(result => { if (result.status === 'fulfilled') successCount++; });
            let alertMessage = `${successCount} dari ${timestampsToDelete.length} data berhasil dihapus. Memuat ulang...`;
            if (successCount < timestampsToDelete.length) {
                alertMessage += `\n${timestampsToDelete.length - successCount} data gagal dihapus.`;
            }
            alert(alertMessage);
            await fetchAttendanceData(false);
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = 'Hapus Terpilih';
            updatePanelVisibility();
        });
    }
    
    async function deleteRecord(timestamp, showConfirmation = true) {
        if (!timestamp) return Promise.reject(new Error('ID rekaman tidak valid.')); 
        const performDelete = async () => {
            const rowToDelete = document.querySelector(`tr[data-timestamp="${timestamp}"]`);
            try {
                if (rowToDelete) rowToDelete.style.opacity = '0.5';
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('timestamp', timestamp);
                const response = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
                if (!response.ok) { throw new Error(`Network error: ${response.statusText}`); }
                const result = await response.json();
                if (result.result === 'success') {
                    if (rowToDelete) rowToDelete.remove();
                    fullAttendanceData = fullAttendanceData.filter(row => row.timestamp !== timestamp);
                    return Promise.resolve({ timestamp });
                } else { throw new Error(result.error || 'Gagal menghapus di server.'); }
            } catch (error) {
                if (showConfirmation) alert(`Gagal menghapus: ${error.message}`);
                if (rowToDelete) rowToDelete.style.opacity = '1';
                return Promise.reject({ timestamp, reason: error.message });
            }
        };
        if (showConfirmation) {
            if (confirm('Yakin ingin menghapus rekapan ini secara permanen?')) {
                await performDelete();
                alert('Rekapan berhasil dihapus.');
            }
        } else {
            return await performDelete();
        }
    }
    
    function generatePdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });

        const startDateVal = document.getElementById('start-date').value;
        const endDateVal = document.getElementById('end-date').value;
        let dateRangeText = "Seluruh Periode";
        let dataToPrint = fullAttendanceData;

        if (startDateVal && endDateVal) {
            const startDate = new Date(startDateVal + 'T00:00:00Z');
            const endDate = new Date(endDateVal + 'T23:59:59Z');
            dataToPrint = fullAttendanceData.filter(row => row.parsedDate && row.parsedDate >= startDate && row.parsedDate <= endDate);
            
            const start = new Date(startDateVal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
            const end = new Date(endDateVal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
            dateRangeText = `Periode ${start} - ${end}`;
        }
        
        if (dataToPrint.length === 0) {
            alert("Tidak ada data untuk dicetak pada rentang tanggal ini.");
            return;
        }

        doc.setFontSize(18);
        doc.text("Laporan Absensi Kebersihan", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.text("Mahkamah Syar'iyah Simpang Tiga Redelong", doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 35, { align: 'center' });

        doc.autoTable({
            startY: 45,
            head: [['Nama', 'Ruangan', 'Tanggal', 'Waktu', 'GPS', 'Penilaian']],
            body: dataToPrint.map(row => [
                row.nama || '',
                row.nama_ruang || '',
                row.tanggal || 'N/A',
                (row.waktu || '').replace('WIB', '').trim(),
                row.gps || '',
                row.penilaian || 'Belum dinilai'
            ]),
            theme: 'grid',
            headStyles: { fillColor: [40, 50, 60] },
            styles: { fontSize: 8, cellPadding: 4 },
            columnStyles: { 1: { cellWidth: 150 } }, 
            didDrawPage: function(data) {
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text('Halaman ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.getHeight() - 10);
            }
        });

        doc.save(`Laporan-Absensi-${new Date().toISOString().slice(0, 10)}.pdf`);
    }

    function renderJobAllocationTable() {
        const container = document.getElementById('job-allocation-container');
        const allocations = getJobAllocations();
        const table = document.createElement('table');
        table.className = 'report-table job-table';
        table.id = 'job-allocation-table';
        table.innerHTML = `
            <thead><tr><th>Nama</th><th>Ruang Lantai 1</th><th>Ruang Lantai 2</th><th>Aksi</th></tr></thead>
            <tbody>
                ${allocations.map((alloc, index) => `
                    <tr data-index="${index}">
                        <td contenteditable="true">${alloc.name}</td>
                        <td contenteditable="true">${alloc.roomsLantai1}</td>
                        <td contenteditable="true">${alloc.roomsLantai2}</td>
                        <td><button class="btn btn-danger !py-1 !px-2 text-xs remove-allocation-row-btn" title="Hapus Baris"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Hapus</button></td>
                    </tr>`).join('')}
            </tbody>`;
        container.innerHTML = '';
        container.appendChild(table);
    }

    function setupAllocationListeners() {
        document.getElementById('save-allocations-btn').addEventListener('click', async () => {
            const table = document.getElementById('job-allocation-table');
            const newAllocations = [];
            table.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                newAllocations.push({
                    name: cells[0].innerText.trim(),
                    roomsLantai1: cells[1].innerText.trim(),
                    roomsLantai2: cells[2].innerText.trim(),
                });
            });
            await saveJobAllocations(newAllocations);
            alert('Pembagian tugas berhasil disimpan!');
            const roomData = getRoomData();
            const allLantai1Rooms = new Set(roomData["Lantai 1"] || []);
            const allLantai2Rooms = new Set(roomData["Lantai 2"] || []);
            let roomsWereAdded = false;
            newAllocations.forEach(alloc => {
                const rooms1 = (alloc.roomsLantai1 || '').split(',').map(r => r.trim()).filter(Boolean);
                const rooms2 = (alloc.roomsLantai2 || '').split(',').map(r => r.trim()).filter(Boolean);
                rooms1.forEach(room => { if (!allLantai1Rooms.has(room)) { allLantai1Rooms.add(room); roomsWereAdded = true; } });
                rooms2.forEach(room => { if (!allLantai2Rooms.has(room)) { allLantai2Rooms.add(room); roomsWereAdded = true; } });
            });
            if (roomsWereAdded) {
                roomData["Lantai 1"] = Array.from(allLantai1Rooms).sort();
                roomData["Lantai 2"] = Array.from(allLantai2Rooms).sort();
                await saveRoomData(roomData);
                renderFloorManagement(); 
                alert('Ruangan baru dari tabel tugas telah ditambahkan ke Manajemen Ruangan.');
            }
            renderProgressReport();
        });
        document.getElementById('add-allocation-row-btn').addEventListener('click', () => {
             const table = document.getElementById('job-allocation-table').querySelector('tbody');
             const newRow = table.insertRow();
             newRow.innerHTML = `<td contenteditable="true">Nama Baru</td><td contenteditable="true">Ruang Lt. 1</td><td contenteditable="true">Ruang Lt. 2</td><td><button class="btn btn-danger !py-1 !px-2 text-xs remove-allocation-row-btn" title="Hapus Baris"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Hapus</button></td>`;
        });
        document.getElementById('job-allocation-container').addEventListener('click', e => {
            if (e.target.closest('.remove-allocation-row-btn')) {
                if (confirm('Yakin ingin menghapus baris ini?')) { e.target.closest('tr').remove(); }
            }
        });
        document.getElementById('generate-progress-report-btn').addEventListener('click', renderProgressReport);
    }
    
    function renderProgressReport() {
        const container = document.getElementById('progress-report-container');
        const startDateInput = document.getElementById('progress-report-start-date');
        const endDateInput = document.getElementById('progress-report-end-date');

        if (!startDateInput.value || !endDateInput.value) {
            container.innerHTML = `<p class="text-center text-text-secondary py-8">Pilih rentang tanggal untuk menampilkan laporan.</p>`;
            return;
        }

        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate > endDate) {
            container.innerHTML = `<p class="text-center text-danger-color py-8">Tanggal mulai tidak boleh lebih besar dari tanggal selesai.</p>`;
            return;
        }

        const datesInRange = [];
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            datesInRange.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const reminderSettings = getDataFromCache('reminderSettings', { activeDays: [1, 2, 3, 4, 5] });
        const workingDays = new Set(reminderSettings.activeDays);
        
        const allocations = getJobAllocations();
        const cleanedData = new Map();
        fullAttendanceData.forEach(record => {
            if (!record.parsedDate) return;
            const recordDate = new Date(record.parsedDate);
            const dateKey = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}-${String(recordDate.getDate()).padStart(2, '0')}`;
            const mapKey = `${record.nama}-${dateKey}`;
            if (!cleanedData.has(mapKey)) cleanedData.set(mapKey, new Set());
            const cleanedRooms = (record.nama_ruang || '').split(',').map(r => r.trim()).filter(Boolean);
            cleanedRooms.forEach(room => cleanedData.get(mapKey).add(room));
        });

        const tableHead = `
            <thead>
                <tr>
                    <th>Nama Pegawai</th>
                    ${datesInRange.map(date => {
                        const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                        const dateString = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                        return `<th>${dayName}<br>${dateString}</th>`;
                    }).join('')}
                </tr>
            </thead>`;

        const tableBody = `
            <tbody>
                ${allocations.map(alloc => {
                    const assignedRooms = new Set((alloc.roomsLantai1 + ", " + alloc.roomsLantai2).split(',').map(r => r.trim()).filter(Boolean));
                    if (assignedRooms.size === 0) return '';
                    
                    return `
                        <tr>
                            <td>${alloc.name}</td>
                            ${datesInRange.map(date => {
                                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                const mapKey = `${alloc.name}-${dateKey}`;
                                const cleanedRoomsToday = cleanedData.get(mapKey) || new Set();
                                const isWorkDay = workingDays.has(date.getDay());
                                
                                if (!isWorkDay) {
                                    return `<td class="is-off-day">Libur</td>`;
                                }

                                const unfinishedRooms = [...assignedRooms].filter(room => !cleanedRoomsToday.has(room));
                                
                                let cellContent = '';
                                if (cleanedRoomsToday.size > 0) {
                                    cellContent += `<div class="recap-complete">Selesai: <ul>${[...cleanedRoomsToday].map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                                }
                                if (unfinishedRooms.length > 0) {
                                    cellContent += `<div class="recap-incomplete mt-2">Belum: <ul>${unfinishedRooms.map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                                    cellContent += `<button class="btn btn-secondary recap-action-btn" onclick="markDayAsComplete('${alloc.name}', '${dateKey}', '${unfinishedRooms.join(',')}')">Tandai Selesai</button>`;
                                }
                                
                                if (cellContent === '' && assignedRooms.size > 0) {
                                    cellContent = `<em>Tidak Ada Laporan</em><button class="btn btn-secondary recap-action-btn" onclick="markDayAsComplete('${alloc.name}', '${dateKey}', '${[...assignedRooms].join(',')}')">Tandai Selesai</button>`;
                                } else if (cellContent !== '' && unfinishedRooms.length === 0) {
                                     cellContent += `<div class="recap-complete mt-2"><strong>✅ Semua Selesai</strong></div>`;
                                }


                                return `<td>${cellContent}</td>`;
                            }).join('')}
                        </tr>`;
                }).join('')}
            </tbody>`;

        container.innerHTML = `<table class="daily-recap-table">${tableHead}${tableBody}</table>`;
        setupDualScrollbars('progress-report-container', 'top-scrollbar-wrapper');
    }

    async function markDayAsComplete(name, dateKey, unfinishedRooms) {
        if (!confirm(`Anda akan membuat absensi manual untuk ${name} pada tanggal ${dateKey} untuk ruangan:\n\n${unfinishedRooms.replace(/,/g, '\n')}\n\nLanjutkan?`)) return;

        const container = document.getElementById('progress-report-container');
        container.style.opacity = '0.5'; 
        
        try {
            // --- MULAI BLOK KODE BARU ---

// 1. Buat menit & detik secara acak (0-59)
const randomMinute = Math.floor(Math.random() * 60);
const randomSecond = Math.floor(Math.random() * 60);

// 2. Format menit & detik agar selalu 2 digit (contoh: 05, 23, 59)
const minuteString = String(randomMinute).padStart(2, '0');
const secondString = String(randomSecond).padStart(2, '0');

// 3. Gabungkan menjadi format waktu dengan jam 07 dan zona waktu WIB (+07:00)
// Ini cara paling akurat untuk menentukan tanggal dan waktu dengan timezone
const randomTimeString = `07:${minuteString}:${secondString}`;
const targetDate = new Date(`${dateKey}T${randomTimeString}+07:00`);

// 4. Siapkan data, sekarang semuanya otomatis berdasarkan waktu acak di atas
const timestamp = targetDate.toISOString(); // .toISOString() sudah dalam format UTC yang benar
const formattedDate = targetDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
const formattedTime = targetDate.toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' }) + ' WIB';

// --- SELESAI BLOK KODE BARU ---

            const centerGps = getPolygonCenter();
            
            const formData = new FormData();
            formData.append('nama', name);
            formData.append('nama_ruang', unfinishedRooms);
            formData.append('timestamp', timestamp);
            formData.append('tanggal', formattedDate);
            formData.append('waktu', formattedTime);
            formData.append('gps', centerGps);
            formData.append('catatan', `Entri dibuat manual oleh Pengawas pada ${new Date().toLocaleString('id-ID')}`);
            formData.append('foto', '');

            const response = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            const result = await response.json();

            if (result.result !== 'success') throw new Error(JSON.stringify(result.error));

            alert(`Absensi untuk ${name} pada ${dateKey} berhasil dikirim.`);
            
            const newRecord = {
                nama: name,
                nama_ruang: unfinishedRooms,
                timestamp: timestamp,
                parsedDate: targetDate,
                tanggal: formattedDate,
                waktu: formattedTime,
                gps: centerGps,
                catatan: `Entri dibuat manual oleh Pengawas pada ${new Date().toLocaleString('id-ID')}`,
                foto: ''
            };
            fullAttendanceData.unshift(newRecord);
            renderProgressReport();

        } catch (error) {
            console.error(`Gagal mengirim data untuk ${name}:`, error);
            alert(`Gagal mengirim data. Error: ${error.message}`);
        } finally {
            container.style.opacity = '1';
        }
    }
    function getPolygonCenter() {
        const coords = getActivePolygon();
        if (!coords || coords.length === 0) return '0,0';
        let latSum = 0, lonSum = 0;
        coords.forEach(c => { latSum += c[0]; lonSum += c[1]; });
        return `${(latSum / coords.length).toFixed(7)}, ${(lonSum / coords.length).toFixed(7)}`;
    }

    function setupAttendanceSettings() {
        const modeRadios = document.querySelectorAll('input[name="attendance_mode"]');
        const startTimeInput = document.getElementById('start-time-setting');
        const endTimeInput = document.getElementById('end-time-setting');
        const timeWindowInputsDiv = document.getElementById('time-window-inputs');
        const saveBtn = document.getElementById('save-attendance-settings-btn');
        if (!modeRadios.length) return;

        function toggleTimeInputs(isWindowMode) {
            if (isWindowMode) {
                timeWindowInputsDiv.style.opacity = '1';
                startTimeInput.disabled = false;
                endTimeInput.disabled = false;
            } else {
                timeWindowInputsDiv.style.opacity = '0.5';
                startTimeInput.disabled = true;
                endTimeInput.disabled = true;
            }
        }
        
        const currentSettings = getDataFromCache('attendanceSettings', { mode: 'manual', startTime: '08:00', endTime: '17:00' });
        
        document.querySelector(`input[name="attendance_mode"][value="${currentSettings.mode}"]`).checked = true;
        startTimeInput.value = currentSettings.startTime || '08:00';
        endTimeInput.value = currentSettings.endTime || '17:00';
        toggleTimeInputs(currentSettings.mode === 'window');

        modeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                toggleTimeInputs(radio.value === 'window');
            });
        });

        saveBtn.addEventListener('click', async () => {
            const selectedMode = document.querySelector('input[name="attendance_mode"]:checked').value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            if (selectedMode === 'window' && (!startTime || !endTime)) {
                alert('Untuk Mode Jendela Waktu, jam mulai dan selesai wajib diisi.');
                return;
            }

            const newSettings = {
                mode: selectedMode,
                startTime: startTime,
                endTime: endTime
            };

            await updateAndSaveData('attendanceSettings', newSettings);
            alert(`Pengaturan absensi berhasil disimpan. Mode aktif: ${selectedMode.toUpperCase()}.`);
        });
    }

    function setupAccessManagement() {
        const toggleInputs = document.querySelectorAll('.toggle-input');
        const pengawasInput = document.getElementById('pengawas-password');
        const pegawaiInput = document.getElementById('pegawai-password');
        const pengunjungInput = document.getElementById('pengunjung-password');
        const saveBtn = document.getElementById('save-access-settings-btn');
        const visibilityToggles = document.querySelectorAll('.password-visibility-toggle');

        function loadSettingsToUI() {
            const credentials = getCredentials();
            toggleInputs.forEach(input => {
                const role = input.dataset.role;
                input.checked = credentials.passwordStates[role];
                updateVisualState(role, input.checked);
            });
            pengawasInput.value = '';
            pegawaiInput.value = '';
            pengunjungInput.value = '';
        }

        function updateVisualState(role, isEnabled) {
            const statusEl = document.getElementById(`password-toggle-status-${role}`);
            if (isEnabled) {
                statusEl.textContent = "Status: Aktif (Password Diperlukan)";
                statusEl.style.color = 'var(--success-color)';
            } else {
                statusEl.textContent = "Status: Nonaktif (Login Tanpa Password)";
                statusEl.style.color = 'var(--warning-color)';
            }
        }

        toggleInputs.forEach(input => {
            input.addEventListener('change', () => {
                const role = input.dataset.role;
                updateVisualState(role, input.checked);
            });
        });

        saveBtn.addEventListener('click', async () => {
            let credentials = getCredentials();
            
            toggleInputs.forEach(input => {
                const role = input.dataset.role;
                credentials.passwordStates[role] = input.checked;
            });
            
            if (pengawasInput.value) credentials.pengawasPassword = pengawasInput.value;
            if (pegawaiInput.value) credentials.pegawaiPassword = pegawaiInput.value;
            if (pengunjungInput.value) credentials.pengunjungPassword = pengunjungInput.value;

            await saveCredentials(credentials);
            alert('Pengaturan akses berhasil disimpan!');
            loadSettingsToUI();
        });
        
        visibilityToggles.forEach(toggle => {
            const input = toggle.previousElementSibling;
            toggle.addEventListener('click', () => {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                toggle.querySelector('.eye-icon').classList.toggle('hidden', isPassword);
                toggle.querySelector('.eye-slash-icon').classList.toggle('hidden', !isPassword);
            });
        });

        loadSettingsToUI();
    }
    
    let reminderIntervalId = null; 

    function setupReminderTab() {
        const whatsAppListContainer = document.getElementById('whatsapp-list-container');
        const addWhatsAppBtn = document.getElementById('add-whatsapp-number-btn');
        const newWhatsAppInput = document.getElementById('new-whatsapp-number');
        const saveSettingsBtn = document.getElementById('save-reminder-settings-btn');
        const dayToggleButtons = document.querySelectorAll('.day-toggle-btn');
        const statusLog = document.getElementById('reminder-status-log');

        const settingsKey = 'reminderSettings';

        const getDefaultSettings = () => ({
            numbers: [],
            interval: 2,
            unit: 'hours',
            startTime: '08:00',
            endTime: '17:00',
            activeDays: [1, 2, 3, 4, 5]
        });

        let currentSettings = getDataFromCache(settingsKey, getDefaultSettings());

        function renderWhatsAppNumbers() {
            whatsAppListContainer.innerHTML = currentSettings.numbers.map(num => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="font-mono">${num}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-whatsapp-btn" data-number="${num}">Hapus</button>
                </div>
            `).join('') || `<p class="text-text-secondary text-center">Belum ada nomor WhatsApp.</p>`;
        }

        function updateDayButtonsUI() {
            dayToggleButtons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (currentSettings.activeDays.includes(day)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function loadSettingsToUI() {
            renderWhatsAppNumbers();
            document.getElementById('reminder-interval').value = currentSettings.interval;
            document.getElementById('reminder-unit').value = currentSettings.unit;
            document.getElementById('reminder-start-time').value = currentSettings.startTime;
            document.getElementById('reminder-end-time').value = currentSettings.endTime;
            updateDayButtonsUI();
        }

        addWhatsAppBtn.addEventListener('click', () => {
            const number = newWhatsAppInput.value.trim();
            if (!number || !/^\d+$/.test(number)) {
                alert('Masukkan nomor WhatsApp yang valid (hanya angka), contoh: 6281234567890.');
                return;
            }
            if (currentSettings.numbers.includes(number)) {
                alert('Nomor ini sudah ada dalam daftar.');
                return;
            }
            currentSettings.numbers.push(number);
            newWhatsAppInput.value = '';
            renderWhatsAppNumbers();
        });

        whatsAppListContainer.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-whatsapp-btn');
            if (removeBtn) {
                const numberToRemove = removeBtn.dataset.number;
                currentSettings.numbers = currentSettings.numbers.filter(n => n !== numberToRemove);
                renderWhatsAppNumbers();
            }
        });

        dayToggleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const day = parseInt(btn.dataset.day);
                const index = currentSettings.activeDays.indexOf(day);
                if (index > -1) {
                    currentSettings.activeDays.splice(index, 1);
                } else {
                    currentSettings.activeDays.push(day);
                }
            });
        });

        saveSettingsBtn.addEventListener('click', async () => {
            currentSettings.interval = parseInt(document.getElementById('reminder-interval').value) || 2;
            currentSettings.unit = document.getElementById('reminder-unit').value;
            currentSettings.startTime = document.getElementById('reminder-start-time').value;
            currentSettings.endTime = document.getElementById('reminder-end-time').value;

            await updateAndSaveData(settingsKey, currentSettings);
            alert('Pengaturan pengingat berhasil disimpan dan diaktifkan!');
            statusLog.textContent = `Status: Aktif. Pengecekan setiap ${currentSettings.interval} ${currentSettings.unit}.`;

            startReminderService();
        });

        loadSettingsToUI();
        if (localStorage.getItem(settingsKey)) {
            statusLog.textContent = `Status: Aktif. Pengecekan setiap ${currentSettings.interval} ${currentSettings.unit}.`;
            startReminderService();
        }
    }

    function startReminderService() {
        if (reminderIntervalId) {
            clearInterval(reminderIntervalId); 
        }

        const settings = getDataFromCache('reminderSettings', null);
        if (!settings || settings.numbers.length === 0) {
            console.log("Layanan Pengingat dihentikan: tidak ada nomor tujuan.");
            return;
        }

        const checkIntervalMs = settings.unit === 'hours' 
            ? settings.interval * 60 * 60 * 1000 
            : settings.interval * 60 * 1000;

        reminderIntervalId = setInterval(async () => {
            const now = new Date();
            const currentDay = now.getDay(); 
            const currentTime = now.toTimeString().slice(0, 5);

            if (!settings.activeDays.includes(currentDay) || currentTime < settings.startTime || currentTime > settings.endTime) {
                console.log("Di luar jadwal pengingat. Pengecekan dilewati.");
                return;
            }

            console.log("Menjalankan pengecekan tugas...");

            const allocations = getJobAllocations();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const attendanceForToday = fullAttendanceData.filter(record => {
                if (!record.parsedDate) return false;
                const recordDate = new Date(record.parsedDate);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate.getTime() === today.getTime();
            });

            const unfinishedEmployees = [];
            allocations.forEach(alloc => {
                const assignedRooms = (alloc.roomsLantai1 + ", " + alloc.roomsLantai2).split(',').map(r => r.trim()).filter(Boolean);
                if (assignedRooms.length === 0) return;

                const employeeAttendance = attendanceForToday.filter(rec => rec.nama === alloc.name);
                let completedRooms = [];
                employeeAttendance.forEach(rec => {
                    const rooms = (rec.nama_ruang || '').split(',').map(r => r.trim()).filter(Boolean);
                    completedRooms.push(...rooms);
                });
                const uniqueCompletedRooms = [...new Set(completedRooms)];
                const unfinishedRooms = assignedRooms.filter(room => !uniqueCompletedRooms.includes(room));

                if (unfinishedRooms.length > 0) {
                    unfinishedEmployees.push({
                        name: alloc.name,
                        rooms: unfinishedRooms.join(', ')
                    });
                }
            });

            if (unfinishedEmployees.length > 0) {
                console.log("Pegawai yang belum selesai ditemukan:", unfinishedEmployees);
                showReminderNotification(unfinishedEmployees, settings.numbers);
            } else {
                console.log("Semua pekerjaan hari ini sudah selesai.");
            }

        }, checkIntervalMs);
    }
    function showReminderNotification(employees, numbers) {
        const notification = document.getElementById('reminder-notification');
        const messageEl = document.getElementById('notification-message');
        const buttonsContainer = document.getElementById('notification-whatsapp-buttons');
        const closeBtn = document.getElementById('close-notification-btn');

        let employeeList = employees.map(e => `\n- *${e.name}*: ${e.rooms}`).join('');
        const fullMessage = `*PENGINGAT KEBERSIHAN* ⚠️\n\nMohon perhatian, beberapa tugas kebersihan hari ini belum tercatat di sistem:\n${employeeList}\n\nHarap segera diselesaikan dan dilakukan absensinya. Terima kasih.`;

        messageEl.innerText = `Ditemukan ${employees.length} pegawai yang belum menyelesaikan tugas: ${employees.map(e => e.name).join(', ')}.`;

        buttonsContainer.innerHTML = '';
        numbers.forEach(num => {
            const encodedMessage = encodeURIComponent(fullMessage);
            const waLink = `https://wa.me/${num}?text=${encodedMessage}`;
            const button = document.createElement('a');
            button.href = waLink;
            button.target = '_blank';
            button.className = 'btn btn-success w-full';
            button.innerHTML = `
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.908 6.161l.217.324-1.283 4.657 4.758-1.249.352.215z"/></svg>
                <span>Kirim Pengingat ke ${num}</span>`;
            buttonsContainer.appendChild(button);
        });

        notification.classList.remove('hidden');

        closeBtn.onclick = () => {
            notification.classList.add('hidden');
        };
    }
    
    function setupRecoveryTab() {
        const container = document.getElementById('recovery-email-list-container');
        const addBtn = document.getElementById('add-recovery-email-btn');
        const input = document.getElementById('new-recovery-email-input');

        function renderEmailList() {
            const credentials = getCredentials();
            const emails = credentials.recoveryEmails || [];
            container.innerHTML = emails.map(email => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="truncate pr-2 font-mono">${email}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-email-btn" data-email="${email}">Hapus</button>
                </div>
            `).join('') || `<p class="text-text-secondary text-center">Belum ada email pemulihan.</p>`;
        }
        
        container.addEventListener('click', async e => {
            if (e.target.closest('.remove-email-btn')) {
                const emailToRemove = e.target.closest('.remove-email-btn').dataset.email;
                if(confirm(`Yakin ingin menghapus email "${emailToRemove}"?`)){
                    let credentials = getCredentials();
                    credentials.recoveryEmails = credentials.recoveryEmails.filter(e => e !== emailToRemove);
                    await saveCredentials(credentials);
                    renderEmailList();
                    alert("Email berhasil dihapus.");
                }
            }
        });

        addBtn.addEventListener('click', async () => {
            const newEmail = input.value.trim();
            if (!newEmail.includes('@') || !newEmail.includes('.')) {
                alert('Silakan masukkan alamat email yang valid.');
                return;
            }
            let credentials = getCredentials();
            if (credentials.recoveryEmails.includes(newEmail)) {
                 alert('Email ini sudah ada dalam daftar.');
                 return;
            }
            credentials.recoveryEmails.push(newEmail);
            await saveCredentials(credentials);
            renderEmailList();
            input.value = '';
            alert(`Email ${newEmail} berhasil ditambahkan.`);
        });

        renderEmailList();
    }

    function runSupervisorScript() {
        const sidebarItems = document.querySelectorAll('.sidebar-nav-item');
        const panes = document.querySelectorAll('.tab-pane');
        const sidebar = document.getElementById('supervisor-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const gpsMap = initGpsEditor();

        function switchTab(tabName) {
            sidebarItems.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            const activeItem = document.querySelector(`.sidebar-nav-item[data-tab="${tabName}"]`);
            if (activeItem) activeItem.classList.add('active');
            const activePane = document.getElementById(`tab-${tabName}`);
            if (activePane) activePane.classList.add('active');

            if (tabName === 'gps' && gpsMap) {
                setTimeout(() => {
                    gpsMap.invalidateSize(true);
                    const activeCoords = getActivePolygon();
                    if (activeCoords && activeCoords.length > 0) {
                        gpsMap.fitBounds(activeCoords, { padding: [20, 20] });
                    }
                }, 150);
            }
            
            if (tabName === 'proses') {
                setupDualScrollbars('job-allocation-container', 'job-allocation-top-scrollbar-wrapper');
                setupDualScrollbars('progress-report-container', 'top-scrollbar-wrapper');
            }
        }
        
        function toggleSidebar(forceClose = false) {
             if (forceClose || sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('visible');
             } else {
                sidebar.classList.add('open');
                overlay.classList.add('visible');
             }
        }

        sidebarItems.forEach(item => {
            item.addEventListener('click', () => {
                switchTab(item.dataset.tab);
                if (window.innerWidth <= 1024) {
                    toggleSidebar(true);
                }
            });
        });
        
        hamburgerBtn.addEventListener('click', () => toggleSidebar());
        overlay.addEventListener('click', () => toggleSidebar(true));
        
        setupReminderTab(); 
        setupRecoveryTab(); 

        setupManagementInterface('pegawai', {
            inputEl: document.getElementById('new-employee-name'), addBtnEl: document.getElementById('add-employee-btn'),
            containerEl: document.getElementById('employee-list-container'), getListFunc: getEmployeeList,
            addFunc: addEmployee, removeFunc: removeEmployee
        });
        renderFloorManagement();
        
        document.getElementById('filter-btn').addEventListener('click', () => {
            const startVal = document.getElementById('start-date').value;
            const endVal = document.getElementById('end-date').value;

            if (!startVal || !endVal) {
                renderTable(fullAttendanceData, false);
                return;
            }

            try {
                const startDate = new Date(startVal + 'T00:00:00Z');
                const endDate = new Date(endVal + 'T23:59:59Z');

                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error("Format tanggal tidak valid.");
                }

                const filteredData = fullAttendanceData.filter(item => {
                     return item.parsedDate && item.parsedDate >= startDate && item.parsedDate <= endDate;
                });
                
                renderTable(filteredData, false);

            } catch(e) {
                alert("Terjadi kesalahan pada filter tanggal: " + e.message);
                console.error(e);
            }
        });

        document.getElementById('print-pdf-btn').addEventListener('click', generatePdf);

        fetchAttendanceData(false).then(() => {
            const container = document.getElementById('attendance-records-container');
            if (container && !container.querySelector('.text-danger-color')) {
                renderJobAllocationTable();
                setupAllocationListeners();
                
                const today = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(today.getDate() - 7);
                document.getElementById('progress-report-start-date').valueAsDate = sevenDaysAgo;
                document.getElementById('progress-report-end-date').valueAsDate = today;
                renderProgressReport();
            }
        });
        setupLogout('logout-btn-supervisor');
        setupAttendanceSettings();
        setupAccessManagement();
        setupDiagnostics();
    }
    function setupManagementInterface(type, config) {
        const { inputEl, addBtnEl, containerEl, getListFunc, addFunc, removeFunc } = config;
        function renderList() {
            const items = getListFunc();
            containerEl.innerHTML = items.map(name => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="truncate pr-2">${name}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-btn" data-name="${name}">Hapus</button>
                </div>`).join('') || `<p class="text-text-secondary">Belum ada data ${type}.</p>`;
            containerEl.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    const name = e.target.dataset.name;
                    await removeFunc(name); 
                    renderList(); 
                });
            });
        }
        addBtnEl.addEventListener('click', async () => { await addFunc(inputEl.value); inputEl.value = ''; renderList(); });
        renderList();
    }
    
    function renderFloorManagement() {
        const container = document.getElementById('floor-management-container');
        const roomData = getRoomData();
        const floors = Object.keys(roomData);
        let floorOptions = floors.map(floor => `<option value="${floor}">${floor}</option>`).join('');
        container.innerHTML = `
            <div class="form-section-card !p-4 mb-6"><h3 class="text-lg font-semibold mb-3">Tambah Lantai Baru</h3><div class="flex gap-4"><input type="text" id="new-floor-name" class="form-input w-full" placeholder="Contoh: Lantai 3"><button id="add-floor-btn" class="btn btn-primary whitespace-nowrap">Tambah</button></div></div>
            <div class="form-section-card !p-4"><h3 class="text-lg font-semibold mb-3">Tambah Ruangan Baru</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="new-room-name" class="form-input w-full" placeholder="Nama Ruangan Baru"><select id="floor-select" class="form-input">${floorOptions}</select></div><button id="add-room-btn" class="btn btn-primary w-full mt-4">Tambah Ruangan</button></div>
            <div id="room-list-by-floor" class="space-y-6 mt-6 max-h-[40vh] overflow-y-auto pr-2"></div>`;
        renderRoomListByFloor();
        document.getElementById('add-floor-btn').addEventListener('click', addFloor);
        document.getElementById('add-room-btn').addEventListener('click', addRoomToFloor);
    }
    
    function renderRoomListByFloor() {
        const container = document.getElementById('room-list-by-floor');
        const roomData = getRoomData();
        container.innerHTML = '';
        for (const floor in roomData) {
            const floorSection = document.createElement('div');
            let roomListHTML = roomData[floor].map(room => `<div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg"><span class="truncate pr-2">${room}</span><button class="btn btn-danger !py-1 !px-2 text-xs" onclick="removeRoomFromFloor('${floor}', '${room}')">Hapus</button></div>`).join('');
            if (roomData[floor].length === 0) roomListHTML = '<p class="text-text-secondary text-sm italic p-3">Belum ada ruangan.</p>';
            floorSection.innerHTML = `<div class="flex justify-between items-center mb-2"><h4 class="text-xl font-bold text-accent-primary">${floor}</h4><button class="btn btn-danger !py-1 !px-2 text-xs" onclick="removeFloor('${floor}')">Hapus Lantai</button></div><div class="space-y-2">${roomListHTML}</div>`;
            container.appendChild(floorSection);
        }
    }

    async function addFloor() {
        const input = document.getElementById('new-floor-name');
        const newFloorName = input.value.trim();
        if (!newFloorName) { alert('Nama lantai tidak boleh kosong!'); return; }
        const roomData = getRoomData();
        if (roomData[newFloorName]) { alert('Nama lantai sudah ada!'); return; }
        roomData[newFloorName] = [];
        await saveRoomData(roomData);
        renderFloorManagement();
        input.value = '';
    }

    async function removeFloor(floorName) {
        if (confirm(`Yakin ingin menghapus lantai "${floorName}" dan SEMUA ruangan di dalamnya?`)) {
            const roomData = getRoomData();
            delete roomData[floorName];
            await saveRoomData(roomData);
            renderFloorManagement();
        }
    }
    
    async function addRoomToFloor() {
        const roomInput = document.getElementById('new-room-name');
        const floorSelect = document.getElementById('floor-select');
        const newRoomName = roomInput.value.trim();
        const selectedFloor = floorSelect.value;
        if (!newRoomName || !selectedFloor) { alert('Nama ruangan dan lantai tidak boleh kosong!'); return; }
        const roomData = getRoomData();
        if (roomData[selectedFloor].includes(newRoomName)) { alert(`Ruangan "${newRoomName}" sudah ada.`); return; }
        roomData[selectedFloor].push(newRoomName);
        await saveRoomData(roomData);
        renderRoomListByFloor();
        roomInput.value = '';
    }

    async function removeRoomFromFloor(floorName, roomName) {
         if (confirm(`Yakin ingin menghapus ruangan "${roomName}" dari ${floorName}?`)) {
            const roomData = getRoomData();
            roomData[floorName] = roomData[floorName].filter(room => room !== roomName);
            await saveRoomData(roomData);
            renderRoomListByFloor();
        }
    }

    function setupDualScrollbars(bottomScrollerId, topScrollerId) {
        const topScroller = document.getElementById(topScrollerId);
        const bottomScroller = document.getElementById(bottomScrollerId);
        if (!topScroller || !bottomScroller) return;
        
        const topScrollContent = topScroller.querySelector('div');
        const table = bottomScroller.querySelector('table');

        if (!table || !topScrollContent) {
            topScroller.style.display = 'none';
            return;
        }

        let isSyncing = false;

        const updateWidths = () => {
            requestAnimationFrame(() => {
                const tableWidth = table.offsetWidth;
                topScrollContent.style.width = `${tableWidth}px`;
                topScroller.style.display = tableWidth > bottomScroller.clientWidth ? 'block' : 'none';
            });
        };
        
        updateWidths();
        new ResizeObserver(updateWidths).observe(bottomScroller);
        new ResizeObserver(updateWidths).observe(table);


        const syncScroll = (source, target) => {
            if (isSyncing) return;
            isSyncing = true;
            target.scrollLeft = source.scrollLeft;
            requestAnimationFrame(() => { isSyncing = false; });
        };
        
        topScroller.onscroll = () => syncScroll(topScroller, bottomScroller);
        bottomScroller.onscroll = () => syncScroll(bottomScroller, topScroller);
    }

    function setupDiagnostics() {
        const runBtn = document.getElementById('run-diagnostics-btn');
        const fixBtn = document.getElementById('fix-system-btn');
        const resultsContainer = document.getElementById('diagnostics-results-container');
        const fixContainer = document.getElementById('diagnostic-fix-container');

        const createResultItem = (status, title, message) => `
            <li class="status-${status}">
                <span class="status-icon">${status === 'ok' ? '✅' : (status === 'error' ? '❌' : '⚠️')}</span>
                <div class="status-text">
                    <p class="status-title">${title}</p>
                    <p class="status-message">${message}</p>
                </div>
            </li>`;
        
        const createCategory = (title) => `<h3 class="diagnostic-category">${title}</h3>`;

        const runAllChecks = async () => {
            let resultsHTML = '<ul id="diagnostic-results-list">';
            let hasCorruption = false;
            
            resultsHTML += createCategory('Sensor: Konektivitas & Dependensi');
            try {
                const response = await fetch(`${SPREADSHEET_URL}?action=ping&t=${new Date().getTime()}`);
                if (response.ok) {
                    resultsHTML += createResultItem('ok', 'Konektivitas Google Sheets', 'Berhasil terhubung ke server spreadsheet.');
                } else {
                    resultsHTML += createResultItem('error', 'Konektivitas Google Sheets', 'Gagal terhubung. Pastikan URL benar, skrip telah di-deploy (akses "Anyone"), dan ada koneksi internet.');
                }
            } catch (e) {
                resultsHTML += createResultItem('error', 'Konektivitas Google Sheets', `Gagal melakukan request jaringan. Cek koneksi internet dan pastikan file dijalankan dari web server. Error: ${e.message}`);
            }

            const libs = { 'Face-API (Deteksi Wajah)': 'faceapi', 'Leaflet (Peta)': 'L', 'Choices (Dropdown)': 'Choices', 'jsPDF (Cetak PDF)': 'jspdf' };
            for (const [name, lib] of Object.entries(libs)) {
                if (typeof window[lib] !== 'undefined') {
                    resultsHTML += createResultItem('ok', `Pustaka ${name}`, 'Berhasil dimuat dan siap digunakan.');
                } else {
                    resultsHTML += createResultItem('error', `Pustaka ${name}`, 'Gagal dimuat. Beberapa fitur mungkin tidak berfungsi. Periksa koneksi internet.');
                }
            }
            
            resultsHTML += createCategory('Sensor: Integritas Data Lokal');
            const localDataKeys = ['employeeList', 'roomData', 'jobAllocations', 'gpsPresetList', 'loginCredentials', 'attendanceSettings', 'reminderSettings', 'activeGpsCoords'];
            let dataOk = true;
            localDataKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        JSON.parse(data);
                    } catch (e) {
                        resultsHTML += createResultItem('error', `Data Lokal: ${key}`, `Data untuk kunci '${key}' rusak (corrupt) dan tidak bisa dibaca.`);
                        dataOk = false;
                        hasCorruption = true;
                    }
                }
            });
            if (dataOk) {
                resultsHTML += createResultItem('ok', 'Integritas Data Lokal', 'Semua data konfigurasi di browser dalam kondisi baik.');
            }

            resultsHTML += createCategory('Sensor: Konsistensi Akun & Tugas Pegawai');
            try {
                const employeeList = getEmployeeList();
                const jobAllocations = getJobAllocations();
                const employeeSet = new Set(employeeList);
                const allocatedEmployees = new Set(jobAllocations.map(j => j.name));
                let inconsistenciesFound = false;

                jobAllocations.forEach(job => {
                    if (!employeeSet.has(job.name)) {
                        resultsHTML += createResultItem('warning', 'Inkonsistensi Tugas', `Pegawai bernama "${job.name}" memiliki tugas, tetapi tidak terdaftar di daftar utama pegawai.`);
                        inconsistenciesFound = true;
                        hasCorruption = true;
                    }
                });

                employeeList.forEach(employee => {
                    if (!allocatedEmployees.has(employee)) {
                        resultsHTML += createResultItem('warning', 'Tugas Belum Diatur', `Pegawai "${employee}" terdaftar, tetapi belum memiliki pembagian tugas di tab "Rekapan Proses".`);
                        inconsistenciesFound = true;
                    }
                });

                if (!inconsistenciesFound) {
                     resultsHTML += createResultItem('ok', 'Konsistensi Data Pegawai', 'Data daftar pegawai dan pembagian tugas sudah sinkron.');
                }

            } catch(e) {
                 resultsHTML += createResultItem('error', 'Pemeriksaan Pegawai', 'Gagal melakukan pemeriksaan konsistensi data pegawai.');
            }


            resultsHTML += createCategory('Sensor: Izin Browser');
            try {
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                resultsHTML += createResultItem(
                    cameraPermission.state === 'granted' ? 'ok' : 'warning',
                    'Izin Kamera', `Status: ${cameraPermission.state}. Jika 'prompt' atau 'denied', pengguna harus mengizinkan akses saat diminta.`
                );
                const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
                resultsHTML += createResultItem(
                    geoPermission.state === 'granted' ? 'ok' : 'warning',
                    'Izin Lokasi (GPS)', `Status: ${geoPermission.state}. Jika 'prompt' atau 'denied', pengguna harus mengizinkan akses saat diminta.`
                );
            } catch(e) {
                 resultsHTML += createResultItem('warning', 'Izin Browser', 'Pengecekan izin otomatis tidak didukung di browser ini. Izin akan diminta saat fitur digunakan.');
            }

            resultsHTML += '</ul>';
            resultsContainer.innerHTML = resultsHTML;

            if (hasCorruption) {
                fixContainer.classList.remove('hidden');
            } else {
                fixContainer.classList.add('hidden');
            }
        };

        const fixSystem = () => {
            if (confirm("ANDA YAKIN?\n\nIni adalah tindakan perbaikan otomatis (self-repair).\n\nIni akan menghapus semua pengaturan lokal (daftar pegawai, ruangan, tugas, GPS, dll.) dan mengembalikannya ke kondisi default. Data absensi di Google Sheets TIDAK akan terhapus.\n\nAksi ini disarankan jika ada error pada data lokal atau inkonsistensi.\n\nLanjutkan?")) {
                const keysToRemove = ['employeeList', 'roomData', 'jobAllocations', 'gpsPresetList', 'loginCredentials', 'activeGpsCoords', 'attendanceSettings', 'reminderSettings'];
                keysToRemove.forEach(key => localStorage.removeItem(key));
                alert('Log: Perbaikan berhasil dijalankan. Data lokal telah direset! Aplikasi akan dimuat ulang untuk menerapkan konfigurasi default.');
                window.location.reload();
            }
        };

        runBtn.addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const originalText = btn.querySelector('span').textContent;
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Mengecek...';
            resultsContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div><p class="ml-4">Sensor sedang memeriksa kesehatan sistem...</p></div>`;
            fixContainer.classList.add('hidden');

            await runAllChecks();

            btn.disabled = false;
            btn.querySelector('span').textContent = originalText;
        });

        fixBtn.addEventListener('click', fixSystem);
    }

    function setupLogout(buttonId) {
        const logoutBtn = document.getElementById(buttonId);
        if(logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (roomChoicesInstance) {
                    roomChoicesInstance.destroy();
                    roomChoicesInstance = null;
                }
                sessionStorage.clear();
                window.location.reload();
            });
        }
    }
</script>
</body>
</html>
