<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Kebersihan Kantor Modern</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="Logo MS Str.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <style>
        /* --- ================================== --- */
        /* ---    VARIABEL WARNA & GAYA GLOBAL    --- */
        /* --- ================================== --- */
        :root {
            /* Palette Warna Utama (Tema Gelap ala GitHub) */
            --bg-primary: #161b22;      /* Latar belakang utama aplikasi */
            --bg-secondary: #0d1117;    /* Latar belakang sekunder, sedikit lebih gelap */
            --bg-tertiary: #21262d;     /* Latar belakang untuk elemen seperti header tabel */
            --sidebar-bg: rgba(13, 17, 23, 0.9); /* Latar sidebar dengan sedikit transparansi */
            --border-primary: #30363d;  /* Warna border utama */
            --text-primary: #c9d1d9;    /* Warna teks utama, mudah dibaca */
            --text-secondary: #8b949e;  /* Warna teks sekunder untuk label, placeholder */
            
            /* Warna Aksen & Status */
            --accent-primary: #58a6ff;   /* Biru terang untuk fokus, link, dan tombol aktif */
            --accent-secondary: #1f6feb; /* Biru lebih gelap untuk hover */
            --danger-color: #f85149;     /* Merah untuk error, hapus, status negatif */
            --success-color: #3fb950;    /* Hijau untuk sukses, validasi berhasil */
            --warning-color: #d29922;    /* Kuning/Oranye untuk peringatan, status menunggu */
        }

        /* --- Global & Reset --- */
        html { 
            scroll-behavior: smooth; 
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Mencegah scroll horizontal yang tidak diinginkan */
        }

        body {
            background-color: var(--bg-primary);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            position: relative;
            display: flex;
            flex-direction: column;
            /* PERFORMA: Transisi diatur di sini untuk perubahan background saat beralih ke dashboard */
            transition: background-image 0.8s ease-in-out;
        }
        
        #app-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 100vh;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- ================================== --- */
        /* ---  LATAR BELAKANG & ANIMASI KUNCI   --- */
        /* --- ================================== --- */
        
        /* Lapisan gambar latar belakang dengan efek Ken Burns */
        body::before {
            content: ''; 
            position: fixed; 
            inset: 0; 
            z-index: -2;
            background-image: url('gedung fix.jpg'); 
            background-size: cover; 
            background-position: center center;
            /* PERFORMA: Animasi zoom lambat untuk efek visual tanpa terlalu membebani GPU */
            animation: kenBurnsEffect 40s ease-in-out infinite alternate;
            /* PERFORMA: Memberi tahu browser bahwa properti transform akan berubah, memungkinkan optimisasi */
            will-change: transform;
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }

        @keyframes kenBurnsEffect {
            from { transform: scale(1.0); }
            to { transform: scale(1.15); }
        }
        
        /* Lapisan gradien gelap di atas gambar untuk meningkatkan keterbacaan teks */
        .bg-gradient-overlay {
            position: fixed; 
            inset: 0; 
            z-index: -1;
            background: linear-gradient(135deg, rgba(13, 17, 23, 0.65), rgba(22, 27, 34, 0.75));
            transition: opacity 0.8s ease-in-out;
            opacity: 1;
        }

        /* PERFORMA: Saat masuk dashboard, gambar & gradien di-fade out, diganti dengan pattern SVG ringan */
        body.dashboard-active {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%2358a6ff' fill-opacity='0.06'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        body.dashboard-active::before,
        body.dashboard-active .bg-gradient-overlay {
            opacity: 0;
        }

        /* Wrapper untuk animasi partikel */
        #animation-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            overflow: hidden; z-index: 0; pointer-events: none;
        }
        
        .particle {
            position: absolute; 
            background-color: rgba(88, 166, 255, 0.1);
            border-radius: 50%; 
            animation: floatUp ease-in-out infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            10%, 90% { opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }
        
        /* --- ================================== --- */
        /* ---      LOADER & UTILITAS UMUM       --- */
        /* --- ================================== --- */
        
        /* Loader awal yang menutupi seluruh layar saat aplikasi pertama kali dimuat */
        #initial-loader {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1rem; 
            transition: opacity 0.5s ease-out;
        }
        
        /* Pengaturan untuk logo agar renderingnya optimal */
        .logo-img { 
            image-rendering: auto; 
        }

        /* Kustomisasi Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        
        /* Class untuk menyembunyikan elemen secara visual namun tetap bisa diakses oleh screen reader */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* Kontainer utama untuk setiap 'halaman' (login, absensi, supervisor) */
        .main-view {
            display: none; /* Defaultnya disembunyikan, diatur oleh JS */
            flex-direction: column;
            flex-grow: 1;
        }

        body.dashboard-active #login-page {
            display: none !important;
        }

        /* --- ================================== --- */
        /* --- GAYA KARTU, FORM, INPUT & CHOICES --- */
        /* --- ================================== --- */
        
        /* Kartu dengan efek 'glassmorphism' */
        .glass-card {
            background: rgba(22, 27, 34, 0.85); /* Sedikit lebih solid untuk keterbacaan */
            /* PERFORMA: Radius blur dikurangi sedikit untuk performa lebih baik di perangkat mobile */
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-primary); 
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
        }
        .card-header {
            background: rgba(0, 0, 0, 0.2); 
            border-bottom: 1px solid var(--border-primary);
            border-radius: 1rem 1rem 0 0;
        }
        
        /* Kartu khusus untuk membungkus section dalam form */
        .form-section-card {
            background-color: rgba(13, 17, 23, 0.5); 
            padding: 2rem; 
            border-radius: 1rem;
            border: 1px solid var(--border-primary); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease-in-out;
        }
        .form-section-card:hover { 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 0 15px rgba(88, 166, 255, 0.1); 
        }
        
        /* Styling khusus untuk input tanggal dan waktu */
        input[type="date"], input[type="time"] {
            background-color: var(--bg-secondary); 
            color: white; 
            border: 1px solid var(--border-primary);
        }
        input[type="date"]::-webkit-calendar-picker-indicator, 
        input[type="time"]::-webkit-calendar-picker-indicator { 
            filter: invert(1); /* Membuat ikon kalender menjadi putih */
            cursor: pointer;
        }

        /* Gaya dasar untuk input form dan dropdown Choices.js */
        .form-input, .choices__inner, .date-time-input {
            background-color: var(--bg-secondary) !important; 
            color: var(--text-primary) !important;
            border: 1px solid var(--border-primary) !important; 
            border-radius: 0.5rem !important;
            padding: 0.75rem 1rem !important; 
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
            background-image: none !important; /* Menghilangkan ikon default Choices.js */
        }
        .form-input::placeholder { 
            color: var(--text-secondary) !important; 
            opacity: 0.7; 
        }
        .form-input:focus, .choices__inner.is-focused, .date-time-input:focus {
            outline: none !important; 
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3), inset 0 1px 2px rgba(0,0,0,0.2) !important;
        }
        .form-input[readonly] { 
            background-color: var(--bg-tertiary) !important; 
            cursor: not-allowed; 
        }
        
        /* Kustomisasi Dropdown Choices.js */
        .choices__list--dropdown {
            background-color: var(--bg-secondary) !important; 
            border-radius: 0.5rem !important;
            border-color: var(--border-primary) !important; 
            max-height: 200px !important; 
            overflow-y: auto !important;
        }
        .choices__list--dropdown .choices__item { color: var(--text-primary) !important; }
        .choices__list--dropdown .choices__item--selectable.is-highlighted { 
            background-color: var(--accent-primary) !important; 
            color: var(--bg-primary) !important; 
        }
        .choices__list--multiple .choices__item { 
            background-color: var(--accent-secondary) !important; 
            border-color: var(--accent-primary) !important; 
        }
        .choices__placeholder { 
            color: var(--text-secondary) !important; 
            opacity: 0.7; 
        }
        .choices__optgroup-heading { 
            font-weight: 600; 
            color: var(--accent-primary) !important; 
        }
        
        /* --- ================================== --- */
        /* ---      GAYA TOMBOL & BADGE          --- */
        /* --- ================================== --- */
        .btn {
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600;
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            border: 1px solid transparent;
            -webkit-tap-highlight-color: transparent; /* Mencegah flash biru di mobile saat di-tap */
            cursor: pointer;
        }
        .btn svg { margin-right: 0.5rem; }
        .btn.icon-only svg { margin-right: 0; }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            filter: brightness(1.15); 
        }
        .btn:active { 
            transform: translateY(0px); 
            filter: brightness(1); 
        }
        .btn-primary {   
            background-color: rgba(88, 166, 255, 0.1); 
            border: 1px solid rgba(88, 166, 255, 0.5);
            color: rgba(255, 255, 255, 0.8);
        }
        .btn-secondary { 
            background-color: var(--bg-tertiary); 
            color: var(--text-primary); 
            border-color: var(--border-primary); 
        }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { 
            background-image: linear-gradient(to right, #03a9f4 0%, #0288d1 100%); 
            color: white; 
        }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        
        /* Animasi spinner/loader */
        .loader {
            border: 4px solid rgba(255,255,255,0.2); 
            border-radius: 50%;
            border-top: 4px solid var(--text-primary); 
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
         .inline-loader {
            width: 16px; height: 16px; 
            border-width: 2px;
            display: inline-block; 
            vertical-align: middle; 
            margin-left: 8px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Badge untuk menampilkan status (GPS, Wajah, dll) */
        .status-badge {
            display: inline-flex; 
            align-items: center; 
            padding: 0.5rem 1rem;
            border-radius: 9999px; 
            font-weight: 500; 
            margin-top: 1rem;
        }
        .status-badge.success { background-color: rgba(63, 185, 80, 0.2); color: var(--success-color); border: 1px solid rgba(63, 185, 80, 0.4); }
        .status-badge.danger { background-color: rgba(248, 81, 73, 0.2); color: var(--danger-color); border: 1px solid rgba(248, 81, 73, 0.4); }
        .status-badge.warning { background-color: rgba(210, 153, 34, 0.2); color: var(--warning-color); border: 1px solid rgba(210, 153, 34, 0.4); }
        .status-badge.info { background-color: rgba(88, 166, 255, 0.2); color: var(--accent-primary); border: 1px solid rgba(88, 166, 255, 0.4); }

        /* Tombol toggle untuk pemilihan hari di tab Reminder */
        .day-toggle-btn {
            padding: 0.5rem 1rem; 
            border: 1px solid var(--border-primary); 
            border-radius: 0.5rem;
            cursor: pointer; 
            transition: all 0.2s ease;
            background-color: var(--bg-tertiary); 
            color: var(--text-secondary);
        }
        .day-toggle-btn:hover { 
            background-color: var(--bg-secondary); 
            border-color: var(--accent-secondary); 
        }
        .day-toggle-btn.active {
            background-color: var(--accent-primary); 
            color: var(--bg-primary);
            border-color: var(--accent-primary); 
            font-weight: 600;
        }

        /* --- ================================== --- */
        /* ---    KEYFRAMES & EFEK TRANSISI      --- */
        /* --- ================================== --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0); } 
        }
        @keyframes flash-success-anim { 
            from { background-color: rgba(63, 185, 80, 0.4); } 
            to { background-color: transparent; } 
        }
        
        .flash-success { animation: flash-success-anim 1.5s ease-out forwards; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.8s ease-out forwards; }
        
        /* Animasi berurutan untuk setiap section di form */
        .form-section > * { 
            opacity: 0; 
            animation: slideInUp 0.6s ease-out forwards; 
        }

        /* --- ================================== --- */
        /* ---      GAYA PETA LEAFLET & MAP       --- */
        /* --- ================================== --- */
        .center-marker-icon, .corner-marker-icon {
            background-color: var(--accent-primary); 
            border: 3px solid white; 
            border-radius: 50%;
            width: 38px; height: 38px; 
            display: flex; align-items: center; justify-content: center;
            color: var(--bg-primary); 
            font-size: 16px; 
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
            cursor: grab;
            transition: transform 0.2s ease-in-out;
        }
        .center-marker-icon:active, .corner-marker-icon:active { 
            cursor: grabbing; 
            transform: scale(1.25); 
        }
        
        .leaflet-control-layers {
            background: rgba(22, 27, 34, 0.95) !important; /* Dibuat lebih solid */
            backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid var(--border-primary) !important; 
            border-radius: 0.5rem !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            color: var(--text-primary) !important;
        }
        .leaflet-control-layers-base label { font-weight: 500 !important; }
        .leaflet-control-layers-separator { border-top: 1px solid var(--border-primary) !important; }
        
        /* --- ================================== --- */
        /* ---      GAYA TABEL & NAVIGASI TAB    --- */
        /* --- ================================== --- */
        .report-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
            table-layout: fixed; /* Mencegah kolom menjadi terlalu lebar/sempit */
        }
        .report-table th, .report-table td { 
            padding: 1rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border-primary); 
        }
        .report-table th { 
            background-color: var(--bg-tertiary); 
            font-weight: 600; 
            color: var(--text-primary); 
            border-bottom-width: 2px; 
        }
        .report-table td { 
            color: var(--text-secondary); 
            font-size: 0.9rem; 
        }
        .report-table tbody tr { transition: background-color 0.2s ease, opacity 0.3s ease; }
        .report-table tbody tr:hover { background-color: rgba(88, 166, 255, 0.08); }
        .report-table .room-cell { 
            font-style: italic; 
            color: var(--text-primary); 
        }
        
        /* Input dan select di dalam tabel laporan */
        .assessment-select, .assessment-input {
            width: 150px; 
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary); 
            color: var(--text-primary);
            border-radius: 0.5rem; 
            padding: 0.5rem;
        }
        
        /* Navigasi Tab di halaman Supervisor */
        .tab-nav-item {
            padding: 0.75rem 1.5rem; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; 
            font-weight: 600; 
            color: var(--text-secondary); 
            white-space: nowrap;
        }
        .tab-nav-item:hover { color: var(--text-primary); }
        .tab-nav-item.active {
            color: var(--accent-primary); 
            border-bottom-color: var(--accent-primary);
            background-color: rgba(88, 166, 255, 0.05);
        }
        .tab-pane { 
            display: none; 
            animation: fadeIn 0.5s ease; 
        }
        .tab-pane.active { display: block; }
        
        /* Gaya untuk sel tabel yang bisa diedit (contenteditable) */
        .job-table td[contenteditable="true"] {
            background-color: rgba(0, 0, 0, 0.2); 
            outline: none; 
            cursor: text;
            transition: all 0.2s ease; 
            border-radius: 8px;
        }
        .job-table td[contenteditable="true"]:hover { background-color: rgba(88, 166, 255, 0.1); }
        .job-table td[contenteditable="true"]:focus {
            background-color: rgba(88, 166, 255, 0.2); 
            box-shadow: 0 0 0 2px var(--accent-primary);
        }
        
        /* --- ================================== --- */
        /* ---       GAYA TOGGLE SWITCH          --- */
        /* --- ================================== --- */
        .toggle-with-text { display: inline-flex; align-items: center; cursor: pointer; }
        .toggle-track {
            width: 72px; height: 32px; 
            background-color: var(--danger-color); 
            border-radius: 9999px;
            position: relative; 
            transition: background-color 0.3s ease; 
            display: flex;
            align-items: center; 
            font-size: 12px; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .toggle-thumb {
            width: 24px; height: 24px; 
            background-color: white; 
            border-radius: 50%;
            position: absolute; 
            top: 4px; left: 4px; 
            transition: transform 0.3s ease;
        }
        .toggle-track::before, .toggle-track::after { position: absolute; transition: opacity 0.3s ease; }
        .toggle-track::before { content: 'ON'; color: white; left: 10px; opacity: 0; }
        .toggle-track::after { content: 'OFF'; color: white; right: 10px; opacity: 1; }
        .toggle-input:checked + .toggle-track { background-color: var(--success-color); }
        .toggle-input:checked + .toggle-track .toggle-thumb { transform: translateX(40px); }
        .toggle-input:checked + .toggle-track::before { opacity: 1; }
        .toggle-input:checked + .toggle-track::after { opacity: 0; }
  
        /* --- ================================== --- */
        /* ---   LAYOUT DASHBOARD SUPERVISOR     --- */
        /* --- ================================== --- */
        #supervisor-dashboard-layout { 
            display: flex; 
            flex-grow: 1; 
        }
        #supervisor-sidebar {
            width: 260px; 
            background: var(--sidebar-bg); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-primary); 
            padding: 1.5rem 0;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            z-index: 40;
        }
        .sidebar-header { 
            padding: 0 1.5rem 1.5rem 1.5rem; 
            border-bottom: 1px solid var(--border-primary); 
        }
        .sidebar-nav { flex-grow: 1; padding: 1rem 0; }
        .sidebar-nav-item {
            display: flex; align-items: center; 
            padding: 0.8rem 1.5rem;
            margin: 0.25rem 1rem; 
            border-radius: 0.5rem; 
            color: var(--text-secondary);
            font-weight: 500; cursor: pointer; 
            transition: all 0.2s ease; 
            gap: 0.8rem;
        }
        .sidebar-nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .sidebar-nav-item .nav-text { opacity: 1; transition: opacity 0.2s ease; }
        .sidebar-nav-item:hover { 
            background-color: rgba(255, 255, 255, 0.05); 
            color: var(--text-primary); 
        }
        .sidebar-nav-item.active { 
            background-color: var(--accent-primary); 
            color: var(--bg-primary); 
            font-weight: 600; 
        }
        .sidebar-footer { padding: 1rem; text-align: center; }
        #supervisor-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            min-width: 0;
            background-color: var(--bg-primary);
        }
        #mobile-header { display: none; }
        
        /* --- ================================== --- */
        /* ---        GAYA TAB DIAGNOSTIK        --- */
        /* --- ================================== --- */
        #diagnostic-results-list { 
            list-style-type: none; 
            padding: 0; 
            margin-top: 1.5rem; 
            font-family: 'Inter', sans-serif; 
        }
        #diagnostic-results-list li {
            background-color: rgba(0,0,0,0.2); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            margin-bottom: 0.75rem;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 5px solid; 
            transition: all 0.3s ease;
        }
        #diagnostic-results-list .status-icon { font-size: 1.5rem; margin-right: 1rem; }
        #diagnostic-results-list .status-ok { border-left-color: var(--success-color); }
        #diagnostic-results-list .status-ok .status-icon { color: var(--success-color); }
        #diagnostic-results-list .status-error { border-left-color: var(--danger-color); }
        #diagnostic-results-list .status-error .status-icon { color: var(--danger-color); }
        #diagnostic-results-list .status-warning { border-left-color: var(--warning-color); }
        #diagnostic-results-list .status-warning .status-icon { color: var(--warning-color); }
        #diagnostic-results-list .status-text { flex-grow: 1; }
        #diagnostic-results-list .status-title { font-weight: 600; color: var(--text-primary); }
        #diagnostic-results-list .status-message { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .diagnostic-category {
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--accent-primary); 
            margin-top: 2rem;
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem; 
            border-bottom: 2px solid var(--border-primary);
        }

        /* --- ================================== --- */
        /* ---     DESAIN RESPONSIVE (MOBILE)    --- */
        /* --- ================================== --- */
        
        /* Aturan untuk layar yang lebih kecil (tablet & di bawahnya) */
        @media (max-width: 1024px) {
            /* Sembunyikan logo di beberapa tempat untuk menghemat ruang */
            .login-card .logo-img,
            #supervisor-sidebar .logo-img,
            #mobile-header .logo-img,
            #supervisor-content .logo-img {
                display: none !important;
            }

            /* Ubah sidebar menjadi mode 'off-canvas' (tersembunyi di luar layar) */
            #supervisor-sidebar {
                position: fixed; left: 0; top: 0; height: 100%;
                transform: translateX(-100%);
            }
            #supervisor-sidebar.open {
                transform: translateX(0);
                box-shadow: 10px 0 25px rgba(0,0,0,0.3);
            }
            #supervisor-content { padding: 1.5rem; } /* Kurangi padding konten */
            
            /* Tampilkan header mobile yang berisi tombol hamburger */
            #mobile-header {
                display: flex; align-items: center; justify-content: space-between;
                padding: 1rem; background: rgba(22, 27, 34, 0.7);
                backdrop-filter: blur(10px); 
                border-bottom: 1px solid var(--border-primary);
                position: sticky; top: 0; z-index: 30;
            }
            /* Overlay gelap di belakang sidebar saat terbuka */
            #sidebar-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 39;
                opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            }
            #sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        
        /* Aturan khusus untuk layar sangat kecil (smartphone) */
        @media (max-width: 640px) {
            /* Buat kartu login menjadi full-screen agar lebih mudah digunakan */
            .login-card {
                padding: 1.5rem 1rem !important; 
                border: none !important; 
                border-radius: 0 !important;
                height: 100%; width: 100%; max-width: 100%;
                background: transparent; 
                backdrop-filter: none; 
                box-shadow: none;
                display: flex; flex-direction: column; justify-content: center;
            }
             .login-card h2 { font-size: 1.5rem; }
        }
        
        /* Override warna teks default yang mungkin tidak sesuai tema */
        #snap-button, #submit-button { color: white; }
        .card-header h1 { color: white; }
        
        /* --- ================================== --- */
        /* ---      PERBAIKAN SCROLL TABEL       --- */
        /* --- ================================== --- */
        
        /* PERBAIKAN UTAMA: Membuat kontainer tabel bisa di-scroll secara horizontal di mobile */
        #job-allocation-container,
        #progress-report-container,
        #attendance-records-container { /* Ditambahkan juga untuk tabel laporan utama */
             display: block; 
             overflow-x: auto; 
             -webkit-overflow-scrolling: touch; /* Scroll lebih mulus di iOS */
             max-width: 100%;
        }
        
        /* Beri lebar minimum pada tabel agar scroll horizontal aktif jika viewport lebih kecil */
        .report-table,
        .job-table,
        .daily-recap-table {
            min-width: 800px;
        }

        /* --- Gaya Tabel Rekap Harian yang Kompleks --- */
        .daily-recap-table {
            border-collapse: collapse; 
            margin-top: 1rem;
            font-size: 0.8rem;
            min-width: 1800px; /* Lebar minimum besar untuk memicu scroll */
        }

        .daily-recap-table th, 
        .daily-recap-table td {
            border: 1px solid var(--border-primary);
            padding: 0.6rem;
            text-align: left;
            vertical-align: top;
        }

        .daily-recap-table thead th {
            background-color: var(--bg-tertiary); 
            font-weight: 600;
            position: sticky; /* Membuat header tetap terlihat saat scroll ke bawah */
            top: 0;
            z-index: 10;
            white-space: nowrap; /* Mencegah teks header terpotong */
        }

        /* PERBAIKAN UI/UX: Membuat kolom nama pegawai "sticky" saat scroll ke samping */
        .daily-recap-table tbody td:first-child {
            font-weight: 600; 
            background-color: var(--bg-tertiary);
            position: sticky; 
            left: 0;
            z-index: 5;
            width: 150px;
            min-width: 150px;
        }

        .daily-recap-table td.is-off-day {
            background-color: rgba(33, 38, 45, 0.7);
            text-align: center; 
            font-style: italic;
        }

        .daily-recap-table ul { list-style-type: none; padding-left: 0; margin: 0; font-size: 0.75rem; }
        .daily-recap-table ul li { margin-bottom: 2px; }

        .recap-complete { color: var(--success-color); }
        .recap-incomplete { color: var(--danger-color); }

        .recap-action-btn { 
            font-size: 0.7rem; 
            padding: 0.2rem 0.4rem; 
            width: 100%; 
            margin-top: 0.5rem; 
        }

    </style>
    
    <style>*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,li,ol,p,pre,ul{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-meridiem-field,::-webkit-datetime-edit-minute-field,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-second-field,::-webkit-datetime-edit-year-field{padding-bottom:0;padding-top:0}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0}.inset-y-0{top:0;bottom:0}.right-0{right:0}.top-0{top:0}.z-10{z-index:10}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mr-2{margin-right:.5rem}.mr-3{margin-right:.75rem}.mr-4{margin-right:1rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.h-12{height:3rem}.h-28{height:7rem}.h-48{height:12rem}.h-6{height:1.5rem}.h-80{height:20rem}.h-full{height:100%}.w-1\/4{width:25%}.w-12{width:3rem}.w-28{width:7rem}.w-6{width:1.5rem}.w-full{width:100%}.max-w-3xl{max-width:48rem}.max-w-7xl{max-width:80rem}.max-w-lg{max-width:32rem}.flex-grow{flex-grow:1}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-x-\[-1\]{--tw-scale-x:-1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.appearance-none{-webkit-appearance:none;appearance:none}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.items-center{align-items:center}.items-end{align-items:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem * var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-danger-color\/50{border-color:rgb(248 81 73/.5)}.border-accent-primary{--tw-border-opacity:1;border-color:rgb(88 166 255/var(--tw-border-opacity))}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99/var(--tw-border-opacity))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81/var(--tw-border-opacity))}.bg-black\/20{background-color:rgb(0 0 0/.2)}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0/var(--tw-bg-opacity))}.bg-opacity-20{--tw-bg-opacity:.2}.bg-opacity-30{--tw-bg-opacity:.3}.bg-opacity-50{--tw-bg-opacity:.5}.bg-danger-color\/10{background-color:rgb(248 81 73/.1)}.bg-cover{background-size:cover}.bg-fixed{background-position:fixed}.bg-center{background-position:50%}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.pr-2{padding-right:.5rem}.pr-12{padding-right:3rem}.pt-4{padding-top:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.tracking-tight{letter-spacing:-.025em}.whitespace-pre-wrap{white-space:pre-wrap}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.text-danger-color{color:var(--danger-color)}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-text-primary{--tw-text-opacity:1;color:rgb(201 209 217/var(--tw-text-opacity))}.text-text-secondary{--tw-text-opacity:1;color:rgb(139 148 158/var(--tw-text-opacity))}.text-warning-color{color:var(--warning-color)}.opacity-0{opacity:0}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 #0000000d;--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px #0000001a,0 8px 10px -6px #0000001a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.list-disc{list-style-type:disc}.list-inside{list-style-position:inside}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.hover\:scale-110:hover{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:text-text-primary:hover{--tw-text-opacity:1;color:rgb(201 209 217/var(--tw-text-opacity))}.hover\:underline:hover{text-decoration-line:underline}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:opacity-50:disabled{opacity:.5}@media(min-width:768px){.md\:w-auto{width:auto}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:flex-row{flex-direction:row}.md\:p-8{padding:2rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}}@media(min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:col-span-2{grid-column:span 2/span 2}}</style>
</head>
<body>

<div id="initial-loader">
    <div class="loader" style="width: 48px; height: 48px; border-width: 5px;"></div>
    <p id="initial-loader-text" class="text-text-secondary">Mempersiapkan aplikasi...</p>
</div>

<div class="bg-gradient-overlay"></div>
<div id="animation-wrapper"></div>

<div id="app-container" style="visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in-out;">
<div id="app-wrapper">

    <div id="login-page" class="main-view">
        <main class="relative z-10 flex items-center justify-center flex-grow p-4 sm:p-0">
            <div class="login-card glass-card p-6 sm:p-8 md:p-10 w-full max-w-lg text-white slide-in-up">
                
                <header class="text-center mb-8">
                    <img src="Logo MS Str.png" alt="Logo Mahkamah Syar'iyah Simpang Tiga Redelong" class="logo-img mx-auto mb-4 w-28 h-28 transform transition-transform duration-300 hover:scale-110">
                    <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight text-text-primary">Sistem Informasi Kebersihan</h2>
                    <p class="text-text-secondary mt-2">Mahkamah Syar'iyah Simpang Tiga Redelong</p>
                </header>
                
                <form id="login-form" class="space-y-6" novalidate>
                    <div>
                        <label for="login-role" class="block mb-2 text-sm font-medium text-text-secondary">Status</label>
                        <select id="login-role" class="form-input w-full" required>
                            <option value="" disabled selected>-- Pilih Status Anda --</option>
                            <option value="Pengawas">Pengawas</option>
                            <option value="Pegawai">Pegawai</option>
                            <option value="Pengunjung">Pengunjung</option>
                        </select>
                    </div>

                    <div id="pegawai-selection-container" class="hidden">
                        <label for="login-username" class="block mb-2 text-sm font-medium text-text-secondary">Nama Pegawai</label>
                        <select id="login-username" class="form-input w-full">
                            </select>
                    </div>

                    <div id="password-container" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label for="login-password" class="block text-sm font-medium text-text-secondary">Password</label>
                            <a href="#" id="forgot-password-link" class="text-sm text-accent-primary hover:underline hidden">Lupa Kata Sandi?</a>
                        </div>
                        <div class="relative flex items-center">
                            <input type="password" id="login-password" class="form-input w-full pr-12" placeholder="••••••••••••••">
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-text-primary" aria-label="Toggle password visibility">
                                <svg id="eye-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <svg id="eye-slash-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .527-1.664 1.373-3.16 2.458-4.425L13.875 18.825z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.125 10.125L3.175 3.175m17.65 17.65l-7.075-7.075M12 5c.58 0 1.154.067 1.706.196M21.542 12c-.527 1.664-1.373-3.16-2.458-4.425" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.175 3.175L20.825 20.825" /></svg>
                            </button>
                        </div>
                        <p id="password-status-text" class="text-center text-sm text-warning-color mt-2 hidden"></p>
                    </div>

                    <button type="submit" id="login-btn" class="btn btn-primary w-full mt-8 flex items-center justify-center p-4 text-base" disabled>
                        <span id="login-btn-text">Masuk</span>
                        <div id="login-loader" class="loader hidden ml-3"></div>
                    </button>
                    <button type="button" id="exit-login-btn" class="btn btn-secondary w-full mt-3 hidden">
                     <span>Batal / Pilih Status Lain</span>
                    </button>
                </form>
            </div>
        </main>
    </div>
    
    <div id="attendance-page-wrapper" class="main-view"></div>
    <div id="supervisor-page-wrapper" class="main-view"></div>
    <div id="visitor-page-wrapper" class="main-view"></div>

</div> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
// --- ================================== ---
// ---      KONFIGURASI & VARIABEL GLOBAL     ---
// --- ================================== ---

    /**
     * URL endpoint Google Apps Script yang terhubung dengan Google Sheet.
     * Ini adalah jembatan antara aplikasi frontend dan database backend.
     * @type {string}
     */
    const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbzfuRWOTygLrICdhrQ8ASpY5V-4qtA616guVRUF0eyqu7hRxthrtzPQtFo1e-q-y8Uk6Q/exec';
    
    /**
     * URL basis untuk memuat model-model face-api.js.
     * @type {string}
     */
    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
    
    /**
     * Opsi untuk mengaktifkan/menonaktifkan animasi partikel di latar belakang.
     * Bisa diatur ke `false` jika performa di perangkat target kurang baik.
     * @type {boolean}
     */
    const ENABLE_PARTICLES = true;

    // --- Variabel State Aplikasi (untuk menyimpan status aplikasi saat berjalan) ---
    let stream = null; // Menyimpan stream video dari kamera pengguna
    let detectionInterval = null; // Menyimpan ID interval untuk proses deteksi wajah, agar bisa dihentikan
    let fullAttendanceData = []; // Cache untuk menyimpan semua data absensi dari server, mengurangi fetch berulang
    let editingState = {}; // Menyimpan state baris tabel laporan yang sedang diedit (timestamp, HTML asli)
    let roomChoicesInstance = null; // Instance dari library Choices.js untuk dropdown ruangan
    let appSettings = {}; // Variabel untuk menyimpan semua pengaturan dari Google Sheet (source of truth)
    
    // --- PERBAIKAN PERFORMA: State untuk pemuatan model AI ---
    // Variabel ini akan mencegah model dimuat berulang kali.
    let modelsAreLoaded = false;
    let modelsLoadingPromise = null; // Menyimpan promise dari proses loading model


// --- ================================== ---
// ---   MANAJEMEN DATA (SHEET & LOCAL)   ---
// --- ================================== ---
// Bagian ini bertanggung jawab untuk mengambil, menyimpan, dan mengelola semua
// data konfigurasi aplikasi, baik dari Google Sheet (sebagai 'source of truth') 
// maupun dari Local Storage browser (sebagai cache/fallback untuk kecepatan dan mode offline).

    /**
     * Mengambil semua pengaturan aplikasi dari Google Sheet.
     * Pengaturan ini mencakup daftar pegawai, ruangan, password, dll.
     * Jika berhasil, data akan disimpan di `appSettings` dan di-cache ke Local Storage.
     * Jika gagal, aplikasi akan menggunakan data terakhir yang ada di cache.
     * @returns {Promise<boolean>} Mengembalikan `true` jika berhasil, `false` jika gagal.
     */
    async function fetchAppSettings() {
        console.log("Mengambil pengaturan dari Google Sheet...");
        try {
            // Menambahkan timestamp sebagai query parameter untuk mencegah browser menggunakan cache yang sudah usang
            const response = await fetch(`${SPREADSHEET_URL}?action=getSettings&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const data = await response.json();
            
            if (data.result === 'success') {
                appSettings = data.settings;
                // Sinkronkan data dari sheet ke localStorage sebagai cache/fallback.
                // Ini penting agar aplikasi tetap bisa berjalan (mode offline) jika koneksi ke server gagal.
                for (const key in appSettings) {
                    try {
                        // Coba parse sebagai JSON, jika gagal simpan sebagai string biasa
                        const parsedValue = JSON.parse(appSettings[key]);
                        localStorage.setItem(key, JSON.stringify(parsedValue));
                    } catch (e) {
                        localStorage.setItem(key, appSettings[key]);
                    }
                }
                console.log("Pengaturan berhasil diambil dan disinkronkan ke local storage.", appSettings);
                return true;
            } else {
                throw new Error(data.message || "Gagal mengambil pengaturan dari sheet.");
            }
        } catch (error) {
            console.error("Gagal mengambil App Settings dari sheet:", error);
            // Jika gagal, aplikasi akan otomatis menggunakan data dari localStorage
            alert("Gagal mengambil pengaturan terbaru dari server. Aplikasi akan berjalan menggunakan data terakhir yang tersimpan di perangkat ini. Beberapa data mungkin tidak update.");
            return false;
        }
    }
    
    /**
     * Menyimpan satu atau lebih pengaturan ke Google Sheet.
     * @param {object} settingsToSave - Objek berisi key-value yang ingin disimpan. Cth: { employeeList: [...] }
     * @returns {Promise<boolean>} Mengembalikan `true` jika berhasil, `false` jika gagal.
     */
    async function saveAppSettings(settingsToSave) {
        console.log("Menyimpan pengaturan ke Google Sheet:", settingsToSave);
        try {
            const payload = {};
            // Ubah semua nilai objek menjadi string JSON sebelum dikirim
            for (const key in settingsToSave) {
                const value = settingsToSave[key];
                payload[key] = typeof value === 'object' ? JSON.stringify(value) : value;
            }

            const response = await fetch(`${SPREADSHEET_URL}?action=saveSettings`, {
                method: 'POST',
                headers: {
                    // Gunakan text/plain untuk menghindari preflight request CORS yang rumit
                    'Content-Type': 'text/plain;charset=utf-8', 
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.result === 'success') {
                console.log("Pengaturan berhasil disimpan di server.");
                return true;
            } else {
                throw new Error(result.error || "Gagal menyimpan di server.");
            }
        } catch (error) {
            console.error("Gagal menyimpan pengaturan ke sheet:", error);
            alert("Gagal menyimpan pengaturan ke server. Perubahan hanya tersimpan di perangkat ini. Periksa koneksi internet Anda.");
            return false;
        }
    }
    
    /**
     * Membaca data dari cache localStorage dengan aman (menghindari error parsing JSON).
     * @param {string} key - Kunci data di localStorage.
     * @param {*} [defaultData=[]] - Nilai default yang dikembalikan jika data tidak ada atau rusak.
     * @returns {*} Data yang sudah di-parse.
     */
    function getDataFromCache(key, defaultData = []) {
        const storedData = localStorage.getItem(key);
        if (storedData) {
            try {
                // Pengecualian khusus untuk password yang mungkin bukan JSON
                if (key.toLowerCase().includes('password') && !storedData.startsWith('{')) {
                    return storedData;
                }
                return JSON.parse(storedData);
            } catch (e) {
                // Jika data di cache rusak, kembalikan ke default dan perbaiki cache
                console.warn(`Data cache untuk '${key}' rusak. Menggunakan data default.`, e);
                localStorage.setItem(key, JSON.stringify(defaultData));
                return defaultData;
            }
        }
        // Jika tidak ada data, inisialisasi cache dengan data default
        localStorage.setItem(key, JSON.stringify(defaultData));
        return defaultData;
    }

    /**
     * Fungsi helper untuk menyimpan data ke cache (localStorage) dan kemudian ke Sheet.
     * Menyimpan ke local storage terlebih dahulu membuat UI terasa lebih responsif.
     * @param {string} key - Kunci data.
     * @param {*} newData - Data baru yang akan disimpan.
     */
    async function updateAndSaveData(key, newData) {
        // 1. Simpan ke cache lokal terlebih dahulu untuk responsivitas UI
        localStorage.setItem(key, JSON.stringify(newData));
        // 2. Kirim pembaruan ke Google Sheet di latar belakang
        await saveAppSettings({ [key]: newData });
    }

    // --- Manajemen Kredensial (Password & Email) ---
    /**
     * Mengambil data kredensial dari cache, dengan fallback ke data default.
     * @returns {object} Objek berisi password, email pemulihan, dan status password.
     */
    function getCredentials() {
        const defaults = {
            pengawasPassword: "ADMIN", 
            pegawaiPassword: "admin", 
            pengunjungPassword: "admin",
            recoveryEmails: ["mahkamahagungnuril123@gmail.com"],
            passwordStates: { pengawas: true, pegawai: true, pengunjung: true } // Default: semua password aktif
        };
        const cached = getDataFromCache('loginCredentials', defaults);
        // Gabungkan default dengan data dari cache, memastikan semua properti ada
        return { ...defaults, ...cached };
    }

    /**
     * Menyimpan data kredensial baru.
     * @param {object} newCredentials - Objek kredensial baru.
     */
    async function saveCredentials(newCredentials) {
        await updateAndSaveData('loginCredentials', newCredentials);
    }

    // --- Manajemen Pegawai ---
    /**
     * Mengambil daftar nama pegawai dari cache.
     * @returns {string[]} Array nama pegawai.
     */
    const getEmployeeList = () => getDataFromCache('employeeList', ["Suryadi", "Arif Munandar", "Para Pegawai Kesekretariatan", "Para Pegawai Kepaniteraan", "Firda Saputra", "Firda Saputra & Rusdi", "Arif Munandar & Suryadi", "Elfiana", "Pegawai Posyabakum", "Eko Setiawan", "Seri Wahyuni"]);
    
    /**
     * Menambahkan pegawai baru ke dalam daftar.
     * @param {string} name - Nama pegawai baru.
     */
    async function addEmployee(name) {
        if (!name || name.trim() === '') { 
            alert('Nama pegawai tidak boleh kosong!'); 
            return; 
        }
        const employeeList = getEmployeeList();
        // Cek duplikasi tanpa mempedulikan huruf besar/kecil
        if (employeeList.map(e => e.toLowerCase()).includes(name.trim().toLowerCase())) {
            alert('Nama pegawai sudah ada!');
            return;
        }
        employeeList.push(name.trim());
        await updateAndSaveData('employeeList', employeeList);
    }
    
    /**
     * Menghapus pegawai dari daftar dan alokasi tugas terkait.
     * @param {string} name - Nama pegawai yang akan dihapus.
     */
    async function removeEmployee(name) {
        if (confirm(`Anda yakin ingin menghapus "${name}"?\n\nPERINGATAN: Ini juga akan menghapus semua data pembagian tugas yang terkait dengan nama ini.`)) {
            let employeeList = getEmployeeList().filter(e => e !== name);
            await updateAndSaveData('employeeList', employeeList);

            // Hapus juga dari data alokasi pekerjaan untuk menjaga konsistensi data
            let jobAllocations = getJobAllocations().filter(alloc => alloc.name !== name);
            await saveJobAllocations(jobAllocations);
            
            // Render ulang tabel jika sedang ditampilkan
            if (document.getElementById('job-allocation-table')) {
                renderJobAllocationTable();
            }
        }
    }
    
    // --- Manajemen Ruangan ---
    /**
     * Mendapatkan data ruangan default jika tidak ada di cache.
     * @returns {object} Objek data ruangan.
     */
    const getDefaultRoomData = () => ({
        "Lantai 1": ["Halaman Depan & Front Desk", "Ruang Tunggu VIP", "Ruang Kesekretariatan", "Toilet Kesekretariatan", "Ruang Kepaniteraan", "Toilet Kepaniteraan", "Ruang Kasir", "Ruang PTSP Dalam", "Ruang Server", "Ruang PTSP Luar", "Ruang Posyabakum", "Ruang Jaksa/Pengacara", "Ruang Sidang Utama", "Ruang Sidang Utama Belakang", "Ruang Tahanan", "Toilet Tahanan", "Ruang Tunggu Sidang", "Ruang Sidang 1", "Ruang Mediasi", "Toilet Umum Laki-laki (Para Pihak)", "Toilet Umum Perempuan (Para Pihak)", "Tempat Bermain Anak"],
        "Lantai 2": ["Ruang Ketua", "Toilet Ruang Ketua", "Ruang Tunggu Lantai 2 & Tangga", "Ruang Media Center", "Ruang Panitera", "Toilet Panitera", "Ruang Hakim", "Ruang Perpustakaan", "Gudang Kecil", "Ruang Aula & Tangga", "Ruang Wakil Ketua", "Toilet Wakil Ketua", "Ruang Bendahara", "Ruang Sekretaris", "Toilet Sekretaris", "Toilet Pria (Lantai 2)", "Toilet Wanita (Lantai 2)", "Balkon", "Pantri Coffe", "Arsip Dinamis", "Arsip Perkara"]
    });
    const getRoomData = () => getDataFromCache('roomData', getDefaultRoomData());
    async function saveRoomData(newData) { await updateAndSaveData('roomData', newData); }

    // --- Manajemen GPS ---
    const defaultOfficePolygon = [
        [4.727530, 96.833301], [4.727530, 96.833832],
        [4.727048, 96.833832], [4.727048, 96.833301]
    ];
    const defaultOfficeCenter = { lat: 4.72728, lon: 96.83355 };
    const getGpsPresets = () => getDataFromCache('gpsPresetList', [{ name: "Area Kantor MS Redelong (Default)", coords: defaultOfficePolygon }]);
    async function saveGpsPresets(presets) { await updateAndSaveData('gpsPresetList', presets); }
    
    /**
     * Menambahkan atau menimpa preset area GPS.
     * @param {string} name - Nama preset.
     * @param {Array<Array<number>>} coords - Koordinat poligon.
     * @returns {Promise<boolean>} Status keberhasilan.
     */
    async function addGpsPreset(name, coords) {
        if (!name || name.trim() === '') { 
            alert('Nama preset tidak boleh kosong!'); 
            return false; 
        }
        const presets = getGpsPresets();
        const existingPresetIndex = presets.findIndex(p => p.name.trim().toLowerCase() === name.trim().toLowerCase());

        if (existingPresetIndex !== -1) {
             if(confirm(`Preset dengan nama "${name.trim()}" sudah ada. Apakah Anda ingin menimpanya dengan koordinat saat ini?`)){
                presets[existingPresetIndex].coords = coords;
             } else {
                return false;
             }
        } else {
            presets.push({ name: name.trim(), coords });
        }
        await saveGpsPresets(presets);
        return true;
    }

    /**
     * Menghapus preset area GPS.
     * @param {string} name - Nama preset yang akan dihapus.
     */
    async function removeGpsPreset(name) {
        if (name === "Area Kantor MS Redelong (Default)") {
            alert("Preset default tidak dapat dihapus.");
            return;
        }
        let presets = getGpsPresets().filter(p => p.name !== name);
        await saveGpsPresets(presets);
    }

    // --- Manajemen Pembagian Tugas ---
    /**
     * Mendapatkan data pembagian tugas default.
     * @returns {Array<object>} Array objek alokasi tugas.
     */
    const getDefaultJobAllocations = () => ([
        { name: "Suryadi", roomsLantai1: "Halaman Depan & Front Desk, Ruang Tunggu VIP, Ruang Kepaniteraan, Ruang Kasir, Ruang PTSP Dalam, Ruang Server, Toilet Umum Perempuan (Para Pihak)", roomsLantai2: "" },
        { name: "Arif Munandar", roomsLantai1: "Ruang Kesekretariatan, Ruang Sidang 1, Ruang Mediasi, Tempat Bermain Anak, Toilet Umum Perempuan", roomsLantai2: "Balkon" },
        { name: "Firda Saputra", roomsLantai1: "Ruang PTSP Luar, Ruang Tunggu Sidang, Toilet Umum Laki-laki (Para Pihak)", roomsLantai2: "" },
        { name: "Eko Setiawan", roomsLantai1: "Ruang Jaksa/Pengacara, Ruang Sidang Utama, Ruang Sidang Utama Belakang, Ruang Tahanan, Toilet Tahanan", roomsLantai2: "" },
        { name: "Elfiana", roomsLantai1: "", roomsLantai2: "Ruang Ketua, Toilet Ruang Ketua, Ruang Media Center, Ruang Panitera, Toilet Panitera, Ruang Hakim, Ruang Perpustakaan, Gudang Kecil, Ruang Aula & Tangga, Toilet Wanita (Lantai 2)" },
        { name: "Seri Wahyuni", roomsLantai1: "", roomsLantai2: "Ruang Tunggu Lantai 2 & Tangga, Ruang Wakil Ketua, Toilet Wakil Ketua, Ruang Bendahara, Ruang Sekretaris, Toilet Sekretaris, Toilet Pria (Lantai 2), Pantri Coffe, Arsip Dinamis, Arsip Perkara" },
        { name: "Pegawai Posyabakum", roomsLantai1: "Ruang Posyabakum", roomsLantai2: "" },
        { name: "Para Pegawai Kesekretariatan", roomsLantai1: "Toilet Kesekretariatan", roomsLantai2: "" },
        { name: "Para Pegawai Kepaniteraan", roomsLantai1: "Toilet Kepaniteraan", roomsLantai2: "" },
        { name: "Firda Saputra & Rusdi", roomsLantai1: "Toilet Umum Laki-laki (Para Pihak)", roomsLantai2: "" },
        { name: "Arif Munandar & Suryadi", roomsLantai1: "Toilet Umum Perempuan (Para Pihak)", roomsLantai2: "" }
    ]);
    const getJobAllocations = () => getDataFromCache('jobAllocations', getDefaultJobAllocations());
    async function saveJobAllocations(allocations) { await updateAndSaveData('jobAllocations', allocations); }
    // --- ================================== ---
// ---       INSIALISASI APLIKASI         ---
// --- ================================== ---
// Bagian ini berisi logika utama yang berjalan saat aplikasi pertama kali dimuat.
// REVISI UTAMA: Logika dirombak total untuk memprioritaskan kecepatan tampilnya halaman login.
// Model AI yang berat akan dimuat di latar belakang agar tidak memblokir UI.

    /**
     * PERBAIKAN PERFORMA: Fungsi ini memuat model AI (face-api.js) di latar belakang.
     * Tidak akan memblokir tampilan halaman login, sehingga pengguna bisa langsung berinteraksi.
     * @returns {Promise<void>} Sebuah promise yang selesai ketika semua model telah dimuat.
     */
    function loadModelsInBackground() {
        // Jika model sudah dimuat atau sedang dalam proses, jangan jalankan lagi untuk efisiensi.
        if (modelsAreLoaded || modelsLoadingPromise) {
            return modelsLoadingPromise;
        }

        console.log("Memulai pemuatan model AI di latar belakang...");
        const loaderText = document.getElementById('initial-loader-text');
        if(loaderText) loaderText.textContent = 'Memuat model AI...';

        const modelsToLoad = [
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
        ];

        // Simpan promise agar bisa di-await nanti jika diperlukan (misal saat masuk halaman absensi)
        modelsLoadingPromise = Promise.all(modelsToLoad)
            .then(() => {
                modelsAreLoaded = true;
                console.log("Semua model AI berhasil dimuat di latar belakang.");
                // Jika loader awal masih tampil, berikan pesan sukses
                if (loaderText && loaderText.textContent.includes('Memuat model')) {
                    loaderText.textContent = 'Model AI siap!';
                }
            })
            .catch(err => {
                console.error("Gagal memuat model face-api di latar belakang:", err);
                // Tandai kegagalan, agar aplikasi bisa beralih ke mode manual (tanpa deteksi wajah)
                window.faceApiFailed = true; 
                alert("Peringatan: Model AI untuk deteksi wajah gagal dimuat. Fitur validasi wajah otomatis mungkin tidak berfungsi, namun Anda tetap bisa mengambil foto secara manual.");
            });
        
        return modelsLoadingPromise;
    }

    /**
     * Membuat animasi partikel di latar belakang.
     * PERBAIKAN: Jumlah partikel dikurangi untuk meningkatkan performa.
     */
    function initParticleAnimation() {
        if (!ENABLE_PARTICLES) return;
        const wrapper = document.getElementById('animation-wrapper');
        // Jangan buat ulang partikel jika sudah ada
        if (!wrapper || wrapper.children.length > 0) return; 
        
        const particleCount = 25; // Jumlah partikel disesuaikan untuk keseimbangan visual & performa
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            const size = Math.random() * 30 + 10;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.bottom = `-${size}px`;
            const duration = Math.random() * 25 + 20;
            const delay = Math.random() * 20;
            particle.style.animationDuration = `${duration}s`;
            particle.style.animationDelay = `${delay}s`;
            wrapper.appendChild(particle);
        }
    }
    
    /**
     * Menampilkan 'view' (halaman) tertentu dan menyembunyikan yang lain.
     * PERBAIKAN: Otomatis mematikan stream kamera jika meninggalkan halaman absensi untuk menghemat resource.
     * @param {string} viewId - ID dari elemen kontainer halaman yang akan ditampilkan (cth: 'login-page').
     */
    function showView(viewId) {
        console.log(`Mencoba menampilkan view: ${viewId}`);
        document.querySelectorAll('.main-view').forEach(view => {
            // Jika view yang sedang aktif adalah halaman absensi, hentikan kamera saat beralih
            if (view.id === 'attendance-page-wrapper' && view.style.display !== 'none') {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    console.log("Stream kamera dihentikan untuk menghemat baterai & resource.");
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
            }
            view.style.display = 'none';
        });

        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.style.display = 'flex'; 
            // Tambahkan class untuk animasi fade-in
            targetView.classList.remove('fade-out');
            targetView.classList.add('fade-in');
            console.log(`Berhasil menampilkan view: ${viewId}`);
        } else {
            console.error(`View dengan ID "${viewId}" tidak ditemukan.`);
        }
    }

    /**
     * Titik masuk utama aplikasi setelah semua elemen HTML dimuat.
     * FOKUS UTAMA REVISI ADA DI SINI. Logika diubah total untuk mempercepat login.
     */
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM Content Loaded. Memulai inisialisasi aplikasi.");
        const initialLoader = document.getElementById('initial-loader');
        const loaderText = document.getElementById('initial-loader-text');
        const appContainer = document.getElementById('app-container');

        const loggedInUser = sessionStorage.getItem('absenUser');
        const userRole = sessionStorage.getItem('absenRole');

        // Langkah 1: Tampilkan loader dan partikel (jika aktif)
        initParticleAnimation();

        // Langkah 2: Cek apakah pengguna sudah login dari sesi sebelumnya
        if (loggedInUser) {
            // --- ALUR UNTUK PENGGUNA YANG SUDAH LOGIN ---
            document.body.classList.add('dashboard-active');
            loaderText.textContent = 'Menyinkronkan data dari server...';

            // Ambil data terbaru dari server
            await fetchAppSettings(); 
            
            // Hapus halaman login dari DOM untuk menghemat memori
            const loginPage = document.getElementById('login-page');
            if (loginPage) loginPage.remove(); 

            if (userRole === "Pengawas") {
                loaderText.textContent = 'Membangun dashboard pengawas...';
                renderSupervisorPage(); // Akan diimplementasikan di Tahap 3
            } else if (userRole === "Pengunjung") {
                loaderText.textContent = 'Menyiapkan laporan...';
                renderVisitorPage();
            } else { // Role adalah "Pegawai"
                // Hanya untuk pegawai, kita perlu memuat model AI untuk kamera
                loaderText.textContent = 'Memuat model AI untuk kamera...';
                // Kita tunggu (await) pemuatan model di sini karena diperlukan untuk halaman absensi
                await loadModelsInBackground();
                renderAttendancePage(loggedInUser);
            }
        } else {
            // --- ALUR UNTUK PENGGUNA BARU (BELUM LOGIN) ---
            document.body.classList.remove('dashboard-active');
            loaderText.textContent = 'Mengambil data pegawai...';

            // INTI OPTIMISASI: Mulai muat model AI di latar belakang TANPA DITUNGGU (await).
            // Ini adalah kunci utama percepatan login. Halaman login bisa tampil selagi model di-download.
            loadModelsInBackground(); 
            
            // Ambil data penting untuk login (daftar pegawai)
            await fetchAppSettings(); 
            const employeeList = getEmployeeList();
            
            // Segera render halaman login setelah data pegawai didapat.
            renderLoginPage(employeeList);
        }
        
        // Langkah 3: Sembunyikan loader dan tampilkan aplikasi dengan transisi halus
        initialLoader.style.opacity = '0';
        setTimeout(() => {
            initialLoader.style.display = 'none';
            appContainer.style.visibility = 'visible';
            appContainer.style.opacity = '1';
        }, 500); // Waktu harus cocok dengan transisi di CSS
    });
    
    /**
     * Merender halaman Absensi untuk Pegawai.
     * Fungsi ini membangun seluruh struktur HTML untuk halaman absensi secara dinamis.
     * @param {string} loggedInUser - Nama pengguna yang sedang login.
     */
    function renderAttendancePage(loggedInUser) {
        const pageContainer = document.getElementById('attendance-page-wrapper');
        // Konten HTML dibuat menggunakan template literal untuk kemudahan.
        // Class styling diambil dari CSS utility yang sudah ada.
        pageContainer.innerHTML = `
        <header class="sticky top-0 z-50 glass-card !rounded-none shadow-xl p-4 flex items-center justify-between transition-all duration-300">
            <div class="flex items-center">
                <img src="Logo MS Str.png" alt="Logo" class="logo-img w-12 h-12 mr-4">
                <div>
                    <h1 class="text-xl font-bold text-text-primary">Absensi Kebersihan</h1>
                    <p class="text-sm text-text-secondary">Mahkamah Syar'iyah Simpang Tiga Redelong</p>
                </div>
            </div>
            <button id="logout-btn-attendance" class="btn btn-danger !py-2 !px-4 text-sm">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </header>
        <main class="relative z-10 flex items-center justify-center flex-grow p-4 py-12">
            <div class="glass-card w-full max-w-3xl slide-in-up">
                <div class="card-header text-center p-8">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-text-primary">Absensi Piket</h1>
                    <p class="text-md text-text-secondary mt-2">Pastikan semua data diisi dengan benar dan jujur.</p>
                </div>
                <form id="attendance-form" class="p-8 space-y-8">
                    <div class="form-section form-section-card" style="animation-delay: 100ms;">
                        <h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-6">1. Data Diri & Waktu</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nama" class="block text-sm font-medium mb-2 text-text-secondary">Nama Lengkap</label>
                                <input type="text" id="nama" name="nama" value="${loggedInUser}" readonly class="form-input w-full"/>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="ruang" class="block text-sm font-medium text-text-secondary">Pilih Ruangan</label>
                                    <button type="button" id="fill-my-rooms-btn" class="btn btn-secondary !py-1 !px-2 text-xs">Isi Sesuai Tugas</button>
                                </div>
                                <select id="ruang" name="nama_ruang" multiple></select>
                            </div>
                            <div>
                                <label for="tanggal" class="block text-sm font-medium mb-2 text-text-secondary">Tanggal</label>
                                <input type="date" id="tanggal" name="tanggal" required class="form-input w-full"/>
                            </div>
                            <div>
                                <label for="waktu" class="block text-sm font-medium mb-2 text-text-secondary">Waktu</label>
                                <input type="time" id="waktu" name="waktu" required class="form-input w-full"/>
                            </div>
                        </div>
                    </div>
                    <div class="form-section form-section-card" style="animation-delay: 200ms;">
                        <h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-6">2. Lokasi & Bukti Foto</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="flex flex-col">
                                <label for="gps" class="block text-sm font-medium mb-2 text-text-secondary">Lokasi GPS</label>
                                <input type="text" id="gps" name="gps" readonly class="form-input w-full mb-2" placeholder="Mencari lokasi..." />
                                <div id="map" class="w-full h-48 rounded-lg shadow-inner mt-2 border border-border-primary flex-grow"></div>
                                <div id="gps-status" class="status-badge text-center font-bold text-sm mt-4 w-full justify-center">Memeriksa lokasi...</div>
                            </div>
                            <div class="flex flex-col">
                                <label class="block text-sm font-medium mb-2 text-text-secondary">Ambil Foto</label>
                                <div class="relative w-full aspect-video rounded-lg overflow-hidden bg-black shadow-inner border border-border-primary">
                                    <video id="video" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
                                    <img id="photo-preview" class="hidden w-full h-full object-cover"/>
                                    <div id="face-validation-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white font-bold text-lg opacity-0 transition-opacity duration-300 pointer-events-none">Deteksi Wajah Gagal</div>
                                </div>
                                <canvas id="canvas" class="hidden"></canvas>
                                <input type="hidden" id="photo-data" name="foto"/>
                                <div class="flex flex-col gap-4 mt-3">
                                    <button type="button" id="snap-button" class="btn btn-primary !py-3 !px-4" disabled>
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.89-1.78A2 2 0 0110.46 5H13.54a2 2 0 011.664.89l.89 1.78A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        Ambil Foto
                                    </button>
                                    <button type="button" id="retake-button" class="btn btn-secondary !py-3 !px-4 flex-grow hidden">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.418 0h.582m-19 0a2 2 0 002 2h1.582m14.418 0a2 2 0 012-2h.582m0 0a2 2 0 012 2v11a2 2 0 01-2 2H2a2 2 0 01-2-2V7a2 2 0 012 2h2.582m14.418 0a2 2 0 002-2V3a2 2 0 00-2-2H2a2 2 0 00-2 2v2a2 2 0 002 2h2.582z"></path></svg>
                                        Ulangi Foto
                                    </button>
                                    <div id="face-status" class="status-badge text-center font-bold text-sm w-full justify-center">Menunggu deteksi wajah...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section form-section-card" style="animation-delay: 300ms;">
                        <h3 class="text-xl font-bold border-b-2 border-accent-primary pb-2 mb-6">3. Catatan & Kirim Laporan</h3>
                        <div>
                            <label for="catatan" class="block text-sm font-medium mb-2 text-text-secondary">Catatan (Opsional)</label>
                            <textarea id="catatan" name="catatan" rows="4" class="form-input w-full" placeholder="Ketik catatan tambahan jika ada (contoh: sabun habis, lap rusak, dll)"></textarea>
                        </div>
                        <div class="mt-8 text-center">
                            <div id="time-window-status" class="status-badge info mx-auto !mb-4 hidden"></div>
                            <button type="submit" id="submit-button" class="btn btn-primary w-full md:w-auto !py-4 !px-10 text-base" disabled>
                                <span id="submit-btn-text">Kirim ke Pengawas</span>
                                <div id="submit-loader" class="loader hidden"></div>
                            </button>
                            <div id="submit-status" class="text-warning-color text-sm mt-4 font-medium" style="color: var(--warning-color);"></div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
        <footer class="text-center text-text-secondary py-4 text-sm bg-black bg-opacity-30">
            <p class="font-bold">WAJIB DIISI DENGAN LENGKAP DAN JUJUR!</p>
            <p>Mahkamah Syar'iyah Simpang Tiga Redelong</p>
        </footer>
        `;
        showView('attendance-page-wrapper');
        // Panggil skrip spesifik untuk halaman absensi setelah semua elemen HTML dirender
        populateRoomOptions();
        runAttendanceScript();
    }

    /**
     * Merender halaman Dashboard untuk Pengawas.
     * Implementasi lengkap akan ada di Tahap 3.
     */
    function renderSupervisorPage() {
        const pageContainer = document.getElementById('supervisor-page-wrapper');
        // Konten akan ditambahkan pada Tahap 3
        pageContainer.innerHTML = ``; 
        showView('supervisor-page-wrapper');
        // Scriptnya akan kita panggil di Tahap 3
        // runSupervisorScript(); 
    }
    
    /**
     * Merender halaman read-only untuk Pengunjung.
     */
    function renderVisitorPage() {
        const pageContainer = document.getElementById('visitor-page-wrapper');
        pageContainer.innerHTML = `
        <header class="sticky top-0 z-50 glass-card !rounded-none shadow-xl p-4 flex items-center justify-between">
            <div class="flex items-center">
                <img src="Logo MS Str.png" alt="Logo" class="logo-img w-12 h-12 mr-4">
                <div>
                    <h1 class="text-xl font-bold text-text-primary">Laporan Absensi</h1>
                    <p class="text-sm text-text-secondary">Mahkamah Syar'iyah Simpang Tiga Redelong</p>
                </div>
            </div>
            <button id="logout-btn-visitor" class="btn btn-danger !py-2 !px-4 text-sm">
                 <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </header>
        <main class="relative z-10 p-4 md:p-8">
            <div class="w-full max-w-7xl mx-auto glass-card">
                 <div class="card-header text-center p-6">
                    <h2 class="text-2xl font-bold text-text-primary">Rekapan Absensi Petugas Kebersihan</h2>
                </div>
                 <div class="p-6">
                    <div id="attendance-records-container" class="overflow-x-auto">
                        </div>
                </div>
            </div>
        </main>
        <footer class="text-center text-text-secondary py-4 text-sm bg-black bg-opacity-30">
            <p>Mode Pengunjung - Hanya Lihat</p>
        </footer>`;
        showView('visitor-page-wrapper');
        fetchAttendanceData(true); // Memuat data laporan dalam mode read-only
        setupLogout('logout-btn-visitor');
    }

    /**
     * Menjalankan semua skrip dan event listener untuk Halaman Login.
     * @param {string[]} [employeeList=[]] - Daftar nama pegawai untuk dropdown.
     */
    function renderLoginPage(employeeList = []) {
        showView('login-page');

        // Referensi ke elemen-elemen DOM untuk efisiensi
        const roleSelect = document.getElementById('login-role');
        const usernameSelectContainer = document.getElementById('pegawai-selection-container');
        const usernameSelect = document.getElementById('login-username');
        const passwordContainer = document.getElementById('password-container');
        const passwordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const togglePasswordBtn = document.getElementById('toggle-password-btn');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const passwordStatusText = document.getElementById('password-status-text');
        const exitLoginBtn = document.getElementById('exit-login-btn');
        
        // Isi dropdown nama pegawai dari data yang sudah di-fetch
        if (employeeList.length > 0) {
            usernameSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama Anda --</option>' + 
                                   employeeList.map(name => `<option value="${name}">${name}</option>`).join('');
        } else {
            // Kondisi jika data pegawai gagal dimuat
            usernameSelect.innerHTML = '<option value="" disabled selected>-- Tidak ada data pegawai --</option>';
            const pegawaiOption = roleSelect.querySelector('option[value="Pegawai"]');
            if (pegawaiOption) {
                pegawaiOption.disabled = true;
                pegawaiOption.textContent = 'Pegawai (Data tidak tersedia)';
            }
        }

        /**
         * Memperbarui tampilan UI form login berdasarkan role yang dipilih.
         */
        const updateLoginUI = () => {
            const role = roleSelect.value;
            const credentials = getCredentials();
            // Cek apakah password diwajibkan untuk role ini dari pengaturan
            const isPasswordRequired = role ? credentials.passwordStates[role.toLowerCase()] : false;

            usernameSelectContainer.classList.toggle('hidden', role !== 'Pegawai');
            passwordContainer.classList.toggle('hidden', !isPasswordRequired);
            
            forgotPasswordLink.classList.toggle('hidden', role !== 'Pengawas');
            exitLoginBtn.classList.toggle('hidden', !role);
            
            // Logika untuk mengaktifkan tombol login
            let isReadyToLogin = false;
            if (role === 'Pengawas' || role === 'Pengunjung') {
                isReadyToLogin = true;
            } else if (role === 'Pegawai') {
                isReadyToLogin = !!usernameSelect.value && employeeList.length > 0;
            }
            loginBtn.disabled = !isReadyToLogin;
        };
        
        // Event listener saat role/status diubah
        roleSelect.addEventListener('change', updateLoginUI);

        // Event listener saat nama pegawai dipilih
        usernameSelect.addEventListener('change', () => {
            if (usernameSelect.value && roleSelect.value === 'Pegawai') {
                loginBtn.disabled = false;
            }
        });

        // Event listener untuk tombol lihat/sembunyikan password
        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            document.getElementById('eye-icon').classList.toggle('hidden', isPassword);
            document.getElementById('eye-slash-icon').classList.toggle('hidden', !isPassword);
        });

        /**
         * Menangani proses submit form login.
         * @param {Event} e - Event object.
         */
        const handleLoginSubmit = (e) => {
            e.preventDefault();
            const role = roleSelect.value;
            const username = usernameSelect.value;
            const password = passwordInput.value;
            const credentials = getCredentials();

            let isAuthenticated = false;
            let userToLog = '';
            
            const isPasswordRequired = role ? credentials.passwordStates[role.toLowerCase()] : false;

            if (role === 'Pengawas') {
                if (!isPasswordRequired || password === credentials.pengawasPassword) {
                    isAuthenticated = true;
                    userToLog = 'Pengawas';
                }
            } else if (role === 'Pegawai') {
                 if (!username) {
                    alert('Silakan pilih nama pegawai.');
                    return;
                }
                if (!isPasswordRequired || password === credentials.pegawaiPassword) {
                    isAuthenticated = true;
                    userToLog = username;
                }
            } else if (role === 'Pengunjung') {
                if (!isPasswordRequired || password === credentials.pengunjungPassword) {
                    isAuthenticated = true;
                    userToLog = 'Pengunjung';
                }
            }

            if (isAuthenticated) {
                // Simpan sesi di sessionStorage dan reload halaman untuk masuk ke dashboard
                sessionStorage.setItem('absenUser', userToLog);
                sessionStorage.setItem('absenRole', role);
                window.location.reload(); 
            } else {
                alert('Password salah!');
                passwordStatusText.textContent = 'Password yang Anda masukkan salah.';
                passwordStatusText.classList.remove('hidden');
                passwordInput.focus();
            }
        };

        // Event listener untuk submit form login
        loginForm.addEventListener('submit', handleLoginSubmit);
        
        // Event listener untuk link "Lupa Kata Sandi"
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const credentials = getCredentials();
            const recoveryEmails = (credentials.recoveryEmails || []).map(email => email.toLowerCase());

            if (!recoveryEmails || recoveryEmails.length === 0) {
                alert("Fitur pemulihan password belum diatur oleh administrator.");
                return;
            }
            const enteredEmail = prompt("-- PEMULIHAN PASSWORD --\n\nMasukkan salah satu email pemulihan Anda untuk verifikasi:");
            // Jika user menekan cancel
            if (enteredEmail === null) return;
            
            if (recoveryEmails.includes(enteredEmail.toLowerCase().trim())) {
                alert(`Verifikasi Berhasil!\n\nPassword Pengawas Anda adalah: ${credentials.pengawasPassword}`);
            } else {
                alert("Verifikasi Gagal!\n\nEmail yang Anda masukkan tidak terdaftar sebagai email pemulihan.");
            }
        });

        // Event listener untuk tombol "Batal" dari pemilihan role
        exitLoginBtn.addEventListener('click', () => {
            roleSelect.value = "";
            usernameSelectContainer.classList.add('hidden');
            passwordContainer.classList.add('hidden');
            forgotPasswordLink.classList.add('hidden');
            exitLoginBtn.classList.add('hidden');
            loginBtn.disabled = true;
        });
    }
    
// --- ================================== ---
// ---     LOGIKA INTI & SKRIP HALAMAN      ---
// --- ================================== ---

    /**
     * Helper untuk mendapatkan koordinat poligon area kantor yang sedang aktif.
     * @returns {Array<Array<number>>} Koordinat poligon.
     */
    const getActivePolygon = () => getDataFromCache('activeGpsCoords', defaultOfficePolygon);
    
    /**
     * Mengatur input tanggal dan waktu ke waktu saat ini (local time).
     */
    function setDateTimeToNow() {
        const now = new Date();
        // Koreksi timezone offset untuk mendapatkan waktu lokal yang benar untuk input HTML
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localDate = new Date(now - timezoneOffset);
        
        const dateInput = document.getElementById('tanggal');
        if (dateInput) dateInput.value = localDate.toISOString().split('T')[0];
        
        const timeInput = document.getElementById('waktu');
        if (timeInput) timeInput.value = localDate.toISOString().split('T')[1].substring(0, 5);
    }

    /**
     * Mengisi pilihan ruangan pada dropdown menggunakan library Choices.js.
     * Data ruangan diambil dari cache.
     */
    function populateRoomOptions() {
        const roomSelect = document.getElementById('ruang');
        if (!roomSelect) return;

        const roomData = getRoomData();
        const choicesArray = [];

        // Kelompokkan ruangan berdasarkan lantai untuk UX yang lebih baik
        for (const floor in roomData) {
            // Tambahkan judul grup (lantai), dibuat tidak bisa dipilih
            choicesArray.push({ label: floor, id: floor, disabled: true }); 
            roomData[floor].forEach(room => {
                choicesArray.push({ value: room, label: room, group: floor });
            });
        }
        
        // Hancurkan instance lama jika ada untuk mencegah memory leak saat render ulang
        if (roomChoicesInstance) roomChoicesInstance.destroy();
        
        // Inisialisasi instance baru
        roomChoicesInstance = new Choices(roomSelect, {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Pilih satu atau lebih ruangan...',
            classNames: {
                containerOuter: 'choices',
                containerInner: 'choices__inner',
                input: 'choices__input',
                inputCloned: 'choices__input--cloned',
                list: 'choices__list',
                listItems: 'choices__list--multiple',
                listSingle: 'choices__list--single',
                listDropdown: 'choices__list--dropdown',
                item: 'choices__item',
                itemSelectable: 'choices__item--selectable',
                itemDisabled: 'choices__item--disabled',
                itemChoice: 'choices__item--choice',
                placeholder: 'choices__placeholder',
                group: 'choices__group',
                groupHeading: 'choices__heading',
                button: 'choices__button',
                activeState: 'is-active',
                focusState: 'is-focused',
                openState: 'is-open',
                disabledState: 'is-disabled',
                highlightedState: 'is-highlighted',
                selectedState: 'is-selected',
                flippedState: 'is-flipped',
                loadingState: 'is-loading',
                noResults: 'has-no-results',
                noChoices: 'has-no-choices'
            },
        });
        roomChoicesInstance.setChoices(choicesArray, 'value', 'label', true);
    }
    
    /**
     * Memulai interval untuk deteksi wajah secara real-time dari video stream.
     * Ini akan memeriksa keberadaan wajah di depan kamera secara berkala.
     */
    function startFaceDetection() {
        const video = document.getElementById('video');
        const snapButton = document.getElementById('snap-button');
        const faceStatusDiv = document.getElementById('face-status');
        
        if (detectionInterval) clearInterval(detectionInterval);
        if (!video || !snapButton || !faceStatusDiv) return;

        // Jika model AI gagal dimuat, aktifkan mode manual.
        // Ini adalah fallback penting agar user tetap bisa absen meskipun AI gagal.
        if (window.faceApiFailed === true || !modelsAreLoaded) {
            snapButton.disabled = false;
            faceStatusDiv.innerHTML = "⚠️ Mode Manual Aktif";
            faceStatusDiv.className = `status-badge warning justify-center w-full`;
            return;
        }

        detectionInterval = setInterval(async () => {
            const isPhotoTaken = !!document.getElementById('photo-data').value;
            // Hentikan deteksi jika foto sudah diambil atau video tidak aktif
            if (isPhotoTaken || !video.srcObject) return;
            
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            // Aktifkan tombol "Ambil Foto" hanya jika wajah terdeteksi
            if (snapButton) snapButton.disabled = detections.length === 0;

            if (faceStatusDiv) {
                faceStatusDiv.innerHTML = detections.length > 0 ? "✅ Wajah terdeteksi, siap!" : "❌ Arahkan wajah ke kamera";
                faceStatusDiv.className = `status-badge ${detections.length > 0 ? 'success' : 'danger'} justify-center w-full`;
            }
        }, 800); // Deteksi setiap 800ms untuk keseimbangan performa & responsivitas
    }

    /**
     * Menjalankan semua skrip yang diperlukan untuk halaman absensi pegawai.
     * Ini adalah fungsi utama yang mengontrol semua interaksi di halaman absensi,
     * termasuk kamera, GPS, peta, dan pengiriman form.
     */
    function runAttendanceScript() {
        // Cache DOM elements untuk akses lebih cepat
        const form = document.getElementById('attendance-form'), 
              video = document.getElementById('video'), 
              canvas = document.getElementById('canvas'),
              photoPreview = document.getElementById('photo-preview'), 
              snapButton = document.getElementById('snap-button'), 
              retakeButton = document.getElementById('retake-button'),
              photoDataInput = document.getElementById('photo-data'), 
              faceStatusDiv = document.getElementById('face-status'),
              faceOverlay = document.getElementById('face-validation-overlay'), 
              gpsInput = document.getElementById('gps'),
              gpsStatusDiv = document.getElementById('gps-status'), 
              submitButton = document.getElementById('submit-button'),
              submitStatus = document.getElementById('submit-status'), 
              timeWindowStatusDiv = document.getElementById('time-window-status');

        const attendanceSettings = getDataFromCache('attendanceSettings', { mode: 'manual' });
        const dateInput = document.getElementById('tanggal');
        const timeInput = document.getElementById('waktu');

        // Sesuaikan input tanggal/waktu berdasarkan pengaturan dari Pengawas
        if (attendanceSettings.mode === 'realtime' || attendanceSettings.mode === 'window') {
            dateInput.readOnly = true;
            timeInput.readOnly = true;
            dateInput.title = "Tanggal & waktu diatur otomatis oleh pengawas.";
            timeInput.title = "Tanggal & waktu diatur otomatis oleh pengawas.";
            setDateTimeToNow();
        }

        if (attendanceSettings.mode === 'window') {
            const { startTime, endTime } = attendanceSettings;
            if (startTime && endTime) {
                timeWindowStatusDiv.textContent = `Absensi hanya bisa dilakukan antara jam ${startTime} - ${endTime}.`;
                timeWindowStatusDiv.classList.remove('hidden');
            }
        }
        
        // Event listener untuk tombol "Isi Sesuai Tugas"
        document.getElementById('fill-my-rooms-btn').onclick = () => {
            const loggedInUser = document.getElementById('nama').value;
            const allocations = getJobAllocations();
            const userAllocation = allocations.find(alloc => alloc.name === loggedInUser);

            if (userAllocation) {
                const roomsLantai1 = (userAllocation.roomsLantai1 || '').split(',').map(r => r.trim()).filter(Boolean);
                const roomsLantai2 = (userAllocation.roomsLantai2 || '').split(',').map(r => r.trim()).filter(Boolean);
                const allMyRooms = [...roomsLantai1, ...roomsLantai2];

                if (allMyRooms.length > 0 && roomChoicesInstance) {
                    roomChoicesInstance.setValue(allMyRooms);
                } else {
                    alert('Tidak ada ruangan yang ditugaskan untuk Anda dalam sistem.');
                }
            } else {
                alert('Pembagian tugas untuk Anda tidak ditemukan.');
            }
        };

        let map = null;

        /**
         * Mengecek apakah sebuah titik (lat, lon) berada di dalam sebuah poligon.
         * Menggunakan algoritma ray casting.
         * @param {number[]} point - Titik [latitude, longitude].
         * @param {Array<Array<number>>} polygon - Array dari titik-titik poligon.
         * @returns {boolean} - True jika titik berada di dalam poligon.
         */
        const isInside = (point, polygon) => {
            const x = point[0], y = point[1]; 
            let isInside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) isInside = !isInside;
            }
            return isInside;
        };
        
        /**
         * Inisialisasi peta Leaflet dan melakukan validasi lokasi pengguna.
         * @param {number[]} userLocation - Koordinat pengguna [latitude, longitude].
         */
        const initMap = (userLocation) => {
            const officePolygonCoords = getActivePolygon();
            if (!map) {
                try {
                    map = L.map('map').setView(userLocation, 18);
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    }).addTo(map);
                } catch (e) {
                    console.error("Gagal menginisialisasi peta Leaflet:", e);
                    document.getElementById('map').innerHTML = '<p class="text-danger-color p-4">Gagal memuat peta.</p>';
                    return;
                }
            } else { map.setView(userLocation, 18); }

            const status = isInside(userLocation, officePolygonCoords);
            L.polygon(officePolygonCoords, {color: status ? 'var(--success-color)' : 'var(--danger-color)'}).addTo(map);
            L.marker(userLocation).addTo(map).bindPopup('Lokasi Anda Saat Ini').openPopup();
            
            if (gpsStatusDiv) {
                gpsStatusDiv.innerHTML = status ? "✅ Anda berada di dalam area kantor" : "⛔️ Anda berada di luar area kantor";
                gpsStatusDiv.className = `status-badge ${status ? 'success' : 'danger'} justify-center w-full`;
            }
            checkConditionsAndEnableSubmit();
        };

        // Meminta lokasi GPS pengguna saat halaman dimuat
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const userLocation = [pos.coords.latitude, pos.coords.longitude];
                    if (gpsInput) gpsInput.value = `${userLocation[0].toFixed(7)}, ${userLocation[1].toFixed(7)}`;
                    // Pastikan library Leaflet (L) sudah dimuat
                    if (window.L) initMap(userLocation); 
                },
                (err) => {
                    if (gpsInput) gpsInput.value = 'GPS gagal: ' + err.message;
                    if (gpsStatusDiv) {
                        gpsStatusDiv.innerHTML = "❌ Gagal mendapatkan lokasi GPS";
                        gpsStatusDiv.className = 'status-badge danger justify-center w-full';
                    }
                    checkConditionsAndEnableSubmit();
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        } else {
            alert('Browser Anda tidak mendukung Geolocation.');
            if (gpsStatusDiv) {
                gpsStatusDiv.innerHTML = "❌ Browser tidak mendukung GPS";
                gpsStatusDiv.className = 'status-badge danger justify-center w-full';
            }
        }
        
        /**
         * Meminta akses kamera pengguna dan menampilkannya di elemen <video>.
         */
        function initializeCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                 navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(s => {
                    stream = s; 
                    if (video) video.srcObject = stream;
                    video.onloadedmetadata = () => video.play();
                    startFaceDetection();
                }).catch(err => {
                    alert('Kamera gagal diakses: ' + err.message + '\n\nPastikan Anda memberikan izin akses kamera pada browser.');
                    if (faceStatusDiv) {
                        faceStatusDiv.innerHTML = "❌ Kamera tidak dapat diakses."; 
                        faceStatusDiv.className = 'status-badge danger justify-center w-full';
                    }
                    if(detectionInterval) clearInterval(detectionInterval);
                });
            } else {
                 alert('Browser Anda tidak mendukung akses kamera.');
                 if (faceStatusDiv) {
                    faceStatusDiv.innerHTML = "❌ Browser tidak mendukung kamera.";
                    faceStatusDiv.className = 'status-badge danger justify-center w-full';
                 }
            }
        }
        
        initializeCamera();
        
        // Event listener untuk tombol "Ambil Foto"
        snapButton.addEventListener('click', async () => {
            // Validasi wajah jika model AI berhasil dimuat
            if (modelsAreLoaded && !window.faceApiFailed) {
                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
                if (!detections) {
                    if (faceOverlay) {
                        faceOverlay.style.opacity = '1'; 
                        faceOverlay.innerText = "Wajah tidak terdeteksi. Posisikan wajah di tengah dan coba lagi.";
                        setTimeout(() => { faceOverlay.style.opacity = '0'; }, 3000);
                    }
                    return;
                }
            }
            
            if(detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }
            
            // Proses pengambilan gambar dari video, kompresi, dan menampilkannya
            const MAX_WIDTH = 640;
            const scale = MAX_WIDTH / video.videoWidth;
            canvas.width = MAX_WIDTH;
            canvas.height = video.videoHeight * scale;
            const ctx = canvas.getContext('2d');
            // Flip gambar secara horizontal agar tidak terbalik seperti cermin
            ctx.translate(canvas.width, 0); 
            ctx.scale(-1, 1); 
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // Kompresi gambar ke 70% kualitas untuk menghemat ukuran
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
            // Simpan data base64 (tanpa header 'data:image/jpeg;base64,')
            photoPreview.src = dataUrl; 
            photoDataInput.value = dataUrl.split(',')[1]; 
            
            video.classList.add('hidden'); 
            photoPreview.classList.remove('hidden');
            snapButton.classList.add('hidden'); 
            retakeButton.classList.remove('hidden');
            faceStatusDiv.innerHTML = "✅ Foto berhasil diambil!"; 
            faceStatusDiv.className = 'status-badge success justify-center w-full';
            checkConditionsAndEnableSubmit();
        });

        // Event listener untuk tombol "Ulangi Foto"
        retakeButton.addEventListener('click', () => {
            photoPreview.classList.add('hidden'); 
            video.classList.remove('hidden');
            snapButton.classList.remove('hidden'); 
            retakeButton.classList.add('hidden');
            photoDataInput.value = ''; 
            faceStatusDiv.innerHTML = "Menunggu deteksi wajah..."; 
            faceStatusDiv.className = 'status-badge warning justify-center w-full';
            // Mulai lagi deteksi wajah
            startFaceDetection(); 
            checkConditionsAndEnableSubmit();
        });

        /**
         * Memeriksa semua kondisi (GPS, Foto, Waktu) dan mengaktifkan/menonaktifkan tombol submit.
         * Fungsi ini dipanggil setiap kali ada perubahan status.
         */
        function checkConditionsAndEnableSubmit() {
            const isGpsValid = gpsStatusDiv.classList.contains('success');
            const isPhotoPresent = photoDataInput.value !== '';
            let isTimeValid = true;
            let timeStatusText = '';

            const settings = getDataFromCache('attendanceSettings', { mode: 'manual' });
            if (settings.mode === 'window') {
                const { startTime, endTime } = settings;
                if (startTime && endTime) {
                    const currentTime = new Date().toTimeString().slice(0, 5);
                    if (currentTime < startTime || currentTime > endTime) {
                        isTimeValid = false;
                        timeStatusText = `Di luar jam absen (${startTime} - ${endTime})`;
                    }
                }
            }

            if (isGpsValid && isPhotoPresent && isTimeValid) {
                submitButton.disabled = false;
                submitStatus.innerText = "Semua data valid dan siap untuk dikirim.";
                submitStatus.style.color = 'var(--success-color)';
                document.getElementById('submit-btn-text').innerText = "Kirim ke Pengawas";
            } else {
                submitButton.disabled = true;
                let statusText = [];
                if (!isGpsValid) statusText.push("Lokasi GPS belum valid");
                if (!isPhotoPresent) statusText.push("Foto belum diambil");
                if (!isTimeValid) statusText.push(timeStatusText);
                submitStatus.innerText = "Tombol nonaktif: " + statusText.join(' & ');
                submitStatus.style.color = 'var(--warning-color)';
                document.getElementById('submit-btn-text').innerText = "Lengkapi Data Dahulu";
            }
        }
        
        // Panggil pengecekan awal
        checkConditionsAndEnableSubmit();

        // Event listener untuk submit form absensi utama
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(form);
            
            // Ambil data ruangan dari Choices.js dan format sebagai string
            if (roomChoicesInstance) {
                const selectedRooms = roomChoicesInstance.getValue(true);
                if (selectedRooms.length === 0) {
                    alert('Anda harus memilih minimal satu ruangan!');
                    return;
                }
                formData.set('nama_ruang', selectedRooms.join(', '));
            }
            
            // Format timestamp dan tanggal/waktu sebelum dikirim
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, -1);
            formData.set('timestamp', localISOTime);

            const tanggalInput = document.getElementById('tanggal').value;
            const waktuInput = document.getElementById('waktu').value;
            if (!tanggalInput || !waktuInput) { 
                alert('Tanggal dan Waktu wajib diisi!'); 
                return; 
            }
            const dateParts = tanggalInput.split('-');
            const dateObj = new Date(Date.UTC(dateParts[0], parseInt(dateParts[1], 10) - 1, dateParts[2]));
            const formattedDate = dateObj.toLocaleString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
            formData.set('tanggal', formattedDate);
            formData.set('waktu', `${waktuInput} WIB`);

            if (!photoDataInput.value) { 
                alert('Anda harus mengambil foto bukti terlebih dahulu!'); 
                return; 
            }
            
            // Tampilkan loader pada tombol submit untuk feedback visual
            const submitBtnText = document.getElementById('submit-btn-text');
            const submitLoader = document.getElementById('submit-loader');
            submitButton.disabled = true; 
            submitBtnText.classList.add('hidden'); 
            submitLoader.classList.remove('hidden');
            submitStatus.innerText = 'Mengirim data dan foto, mohon tunggu... Ini mungkin perlu beberapa saat.';
            submitStatus.style.color = 'var(--accent-primary)';

            try {
                const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.result === 'success') {
                    alert('Absensi berhasil dikirim!');
                    submitStatus.innerText = 'Berhasil dikirim! Anda bisa melakukan absensi untuk ruangan lain.';
                    submitStatus.style.color = 'var(--success-color)';
                    
                    // Reset sebagian form untuk absensi berikutnya
                    form.reset();
                    // Kembalikan nama ke user yang login
                    document.getElementById('nama').value = loggedInUser; 
                    if (roomChoicesInstance) { 
                        roomChoicesInstance.clearStore(); 
                        roomChoicesInstance.clearInput(); 
                    }
                    if(retakeButton) retakeButton.click(); 
                    
                    // Jika mode realtime, setel ulang waktu ke sekarang
                    const settings = getDataFromCache('attendanceSettings', { mode: 'manual' });
                    if(settings.mode === 'realtime' || settings.mode === 'window') {
                        setDateTimeToNow();
                    }
                    checkConditionsAndEnableSubmit();
                } else { 
                    throw new Error(JSON.stringify(result.error) || 'Unknown server error'); 
                }
            } catch (err) {
                alert('Terjadi error saat mengirim data: ' + err.message);
                submitStatus.innerText = 'Gagal mengirim. Periksa koneksi internet Anda dan coba lagi.';
                submitStatus.style.color = 'var(--danger-color)';
            } finally {
                // Kembalikan tombol submit ke state semula
                submitButton.disabled = false;
                submitBtnText.classList.remove('hidden'); 
                submitLoader.classList.add('hidden');
                setTimeout(() => { 
                    if(submitStatus) checkConditionsAndEnableSubmit(); // Update status setelah beberapa detik
                }, 5000);
            }
        });
        
        // Setup tombol logout
        setupLogout('logout-btn-attendance');
    }

    /**
     * Menginisialisasi editor Peta GPS di halaman Pengawas.
     * Mengizinkan pengawas untuk mengatur area absensi yang valid secara visual.
     * @returns {object|null} Instance peta Leaflet atau null jika gagal.
     */
    function initGpsEditor() {
        const ACTIVE_COORDS_KEY = 'activeGpsCoords';
        let map, polygon, centerMarker, cornerMarkers = [];
        
        // Cache elemen DOM
        const modeRadios = document.querySelectorAll('input[name="gps_mode"]');
        const centerSizeModeContainer = document.getElementById('center-size-mode-container');
        const manualModeContainer = document.getElementById('manual-mode-container');
        const generateAreaBtn = document.getElementById('generate-area-btn');
        const presetNameInput = document.getElementById('new-preset-name');
        const savePresetBtn = document.getElementById('save-preset-btn');
        const presetSelect = document.getElementById('gps-preset-select');
        const loadPresetBtn = document.getElementById('load-preset-btn');
        const deletePresetBtn = document.getElementById('delete-preset-btn');

        /**
         * Inisialisasi peta Leaflet jika belum ada.
         * @param {object} center - Koordinat tengah {lat, lon}.
         */
        function initializeMap(center) {
            if (map) return;
            try {
                map = L.map('gps-editor-map').setView([center.lat, center.lon], 18);
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' });
                const baseMaps = { "Satelit": satelliteLayer, "Peta Jalan": osmLayer };
                L.control.layers(baseMaps).addTo(map);
                satelliteLayer.addTo(map);
            } catch (e) {
                console.error("Gagal init peta GPS Editor:", e);
                document.getElementById('gps-editor-map').innerHTML = "<p class='p-4 text-danger-color'>Gagal memuat peta.</p>";
            }
        }

        const unitFactors = { km: 1000, m: 1 };
        const degreesToRadians = (d) => d * Math.PI / 180;
        const radiansToDegrees = (r) => r * 180 / Math.PI;

        /**
         * Menghitung koordinat kotak pembatas (bounding box) berdasarkan titik tengah dan panjang sisi.
         * @param {number} centerLat - Latitude titik tengah.
         * @param {number} centerLon - Longitude titik tengah.
         * @param {number} sideLengthMeters - Panjang sisi kotak dalam meter.
         * @returns {Array<Array<number>>} Array koordinat 4 sudut.
         */
        function calculateBoundingBox(centerLat, centerLon, sideLengthMeters) {
            const R = 6378137; // Radius bumi dalam meter
            const latRad = degreesToRadians(centerLat);
            const halfSide = sideLengthMeters / 2;
            const latDelta = radiansToDegrees(halfSide / R);
            const lonDelta = radiansToDegrees(halfSide / (R * Math.cos(latRad)));
            return [
                [centerLat + latDelta, centerLon - lonDelta],
                [centerLat + latDelta, centerLon + lonDelta],
                [centerLat - latDelta, centerLon + lonDelta],
                [centerLat - latDelta, centerLon - lonDelta]
            ];
        }

        /**
         * Memperbarui poligon di peta.
         * @param {Array<Array<number>>} coords - Koordinat baru poligon.
         */
        function updatePolygonOnMap(coords) {
            if (!map) return;
            if (!polygon) {
                polygon = L.polygon(coords, { color: 'var(--accent-primary)' }).addTo(map);
            } else {
                polygon.setLatLngs(coords);
            }
            map.fitBounds(polygon.getBounds(), { padding: [20, 20] });
        }
        
        /**
         * Memperbarui nilai input form dari koordinat poligon.
         * @param {Array<Array<number>>} coords - Koordinat poligon.
         */
        function updateFormInputsFromCoords(coords) {
            for (let i = 0; i < 4; i++) {
                document.getElementById(`manual-lat-${i+1}`).value = coords[i][0].toFixed(8);
                document.getElementById(`manual-lon-${i+1}`).value = coords[i][1].toFixed(8);
            }
            const centerLat = (coords[0][0] + coords[3][0]) / 2;
            const centerLon = (coords[0][1] + coords[1][1]) / 2;
            document.getElementById('center-lat-input').value = centerLat.toFixed(8);
            document.getElementById('center-lon-input').value = centerLon.toFixed(8);
        }

        /**
         * Menyimpan koordinat area aktif dan memberi notifikasi.
         * @param {Array<Array<number>>} coords - Koordinat yang akan disimpan.
         */
        function saveAndNotify(coords) {
            localStorage.setItem(ACTIVE_COORDS_KEY, JSON.stringify(coords));
            document.getElementById('active-preset-status').textContent = 'Area Aktif Telah Diterapkan';
            alert('Area absensi baru berhasil diterapkan dan disimpan di browser ini!');
        }
        
        /**
         * Merender opsi preset GPS ke dalam elemen select.
         */
        function renderPresetOptions() {
            const presets = getGpsPresets();
            presetSelect.innerHTML = presets.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        }

        /**
         * Menangani penyimpanan preset baru.
         */
        async function handleSavePreset() {
            const name = presetNameInput.value;
            if (!name.trim()) {
                alert("Silakan masukkan nama untuk preset area ini.");
                return;
            }
            if (!polygon) {
                alert("Area belum dibuat. Silakan buat area terlebih dahulu.");
                return;
            }
            const currentCoords = polygon.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
            if (await addGpsPreset(name, currentCoords)) {
                alert(`Preset '${name}' berhasil disimpan!`);
                renderPresetOptions();
                presetSelect.value = name;
                presetNameInput.value = '';
            }
        }

        /**
         * Menangani pemuatan preset yang dipilih.
         */
        function handleLoadPreset() {
            const selectedName = presetSelect.value;
            const presets = getGpsPresets();
            const selectedPreset = presets.find(p => p.name === selectedName);
            if (selectedPreset) {
                updatePolygonOnMap(selectedPreset.coords);
                updateFormInputsFromCoords(selectedPreset.coords);
                alert(`Preset '${selectedName}' berhasil dimuat. Tekan "Terapkan & Simpan" untuk menjadikannya area aktif.`);
            }
        }
        
        /**
         * Menangani penghapusan preset.
         */
        async function handleDeletePreset() {
            const selectedName = presetSelect.value;
            if (selectedName === "Area Kantor MS Redelong (Default)") {
                 alert("Preset default tidak dapat dihapus."); 
                 return;
            }
            if (confirm(`Anda yakin ingin menghapus preset '${selectedName}'?`)) {
                await removeGpsPreset(selectedName);
                renderPresetOptions();
                alert(`Preset '${selectedName}' telah dihapus.`);
            }
        }
        
        /**
         * Mengatur UI editor ke mode 'Pusat & Ukuran'.
         */
        function setupCenterSizeMode() {
            if (!map || !polygon) return;
            centerSizeModeContainer.classList.remove('hidden');
            manualModeContainer.classList.add('hidden');
            cornerMarkers.forEach(m => m.remove());
            cornerMarkers = [];
            const centerIcon = L.divIcon({ className: 'center-marker-icon', html: `<b>C</b>` });
            const coords = polygon.getCenter();
            if (centerMarker) centerMarker.remove();
            centerMarker = L.marker(coords, { draggable: true, icon: centerIcon }).addTo(map);
            centerMarker.on('dragend', () => {
                const newCenter = centerMarker.getLatLng();
                document.getElementById('center-lat-input').value = newCenter.lat.toFixed(8);
                document.getElementById('center-lon-input').value = newCenter.lng.toFixed(8);
            });
        }
        
        /**
         * Mengatur UI editor ke mode 'Manual 4 Titik'.
         */
        function setupManualMode() {
            if (!map || !polygon) return;
            manualModeContainer.classList.remove('hidden');
            centerSizeModeContainer.classList.add('hidden');
            if (centerMarker) centerMarker.remove();
            const currentCoords = polygon.getLatLngs()[0];
            cornerMarkers.forEach(m => m.remove());
            cornerMarkers = [];
            for (let i = 0; i < 4; i++) {
                const markerIcon = L.divIcon({ className: 'corner-marker-icon', html: `<b>${i+1}</b>` });
                const marker = L.marker(currentCoords[i], { draggable: true, icon: markerIcon }).addTo(map);
                marker.on('drag', () => {
                    const latlng = marker.getLatLng();
                    document.getElementById(`manual-lat-${i+1}`).value = latlng.lat.toFixed(8);
                    document.getElementById(`manual-lon-${i+1}`).value = latlng.lng.toFixed(8);
                    const newCoords = cornerMarkers.map(m => m.getLatLng());
                    if (polygon) {
                        polygon.setLatLngs(newCoords);
                    }
                });
                cornerMarkers.push(marker);
            }
        }
        
        // Tambahkan event listener ke semua elemen interaktif
        modeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            const activeMode = e.target.value;
            if (activeMode === 'center_size') setupCenterSizeMode();
            else setupManualMode();
        }));
        
        generateAreaBtn.addEventListener('click', () => {
            const activeMode = document.querySelector('input[name="gps_mode"]:checked').value;
            let newCoords;
            if (activeMode === 'center_size') {
                const centerLat = parseFloat(document.getElementById('center-lat-input').value);
                const centerLon = parseFloat(document.getElementById('center-lon-input').value);
                const size = parseFloat(document.getElementById('area-size-input').value);
                const unit = document.getElementById('area-unit-select').value;
                if (isNaN(centerLat) || isNaN(centerLon) || isNaN(size)) {
                    alert('Pastikan Latitude, Longitude, dan Ukuran Area diisi angka valid.'); 
                    return;
                }
                newCoords = calculateBoundingBox(centerLat, centerLon, size * unitFactors[unit]);
            } else {
                newCoords = [];
                for(let i=0; i<4; i++){
                    const lat = parseFloat(document.getElementById(`manual-lat-${i+1}`).value);
                    const lon = parseFloat(document.getElementById(`manual-lon-${i+1}`).value);
                    if (isNaN(lat) || isNaN(lon)) {
                         alert(`Koordinat Titik ${i+1} tidak valid.`); 
                         return;
                    }
                    newCoords.push([lat, lon]);
                }
            }
            updatePolygonOnMap(newCoords);
            saveAndNotify(newCoords);
        });

        document.getElementById('geolocate-btn').addEventListener('click', (e) => {
            if (!navigator.geolocation) return alert('Browser tidak mendukung geolokasi.');
            const btn = e.currentTarget;
            btn.innerHTML = `<div class="loader inline-loader !w-4 !h-4 !border-2"></div> Mencari...`;
            btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('center-lat-input').value = pos.coords.latitude.toFixed(8);
                    document.getElementById('center-lon-input').value = pos.coords.longitude.toFixed(8);
                    btn.innerHTML = 'Gunakan Lokasi Saya Saat Ini';
                    btn.disabled = false;
                },
                () => {
                    alert('Gagal mendapatkan lokasi Anda.');
                    btn.innerHTML = 'Gunakan Lokasi Saya Saat Ini';
                    btn.disabled = false;
                }
            );
        });
        
        document.querySelectorAll('.manual-coord-input').forEach(input => {
            input.addEventListener('change', () => {
                const newCoords = [];
                for(let i=0; i<4; i++){
                    const lat = parseFloat(document.getElementById(`manual-lat-${i+1}`).value);
                    const lon = parseFloat(document.getElementById(`manual-lon-${i+1}`).value);
                    if (!isNaN(lat) && !isNaN(lon)) newCoords.push([lat, lon]); 
                    else return;
                }
                updatePolygonOnMap(newCoords);
            });
        });
        
        savePresetBtn.addEventListener('click', handleSavePreset);
        loadPresetBtn.addEventListener('click', handleLoadPreset);
        deletePresetBtn.addEventListener('click', handleDeletePreset);

        // --- Inisialisasi awal saat tab dibuka ---
        const savedCoords = getActivePolygon();
        initializeMap(defaultOfficeCenter);
        updatePolygonOnMap(savedCoords);
        updateFormInputsFromCoords(savedCoords);
        setupCenterSizeMode();
        renderPresetOptions();
        return map;
    }
    
    /**
     * Helper untuk memformat objek Date menjadi string tanggal yang mudah dibaca (e.g., "17 Agustus 2024").
     * @param {Date|string} dateObj - Objek Date atau string tanggal yang akan diformat.
     * @returns {string} - String tanggal yang sudah diformat atau pesan error.
     */
    function formatDateForDisplay(dateObj) {
        if (!dateObj || isNaN(new Date(dateObj).getTime())) {
            return 'Format Tanggal Salah';
        }
        const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
        return new Date(dateObj).toLocaleDateString('id-ID', options);
    }
    
    /**
     * Mengambil semua data absensi dari Google Sheet dan menyimpannya di cache `fullAttendanceData`.
     * @param {boolean} [isReadOnly=false] - Jika true, akan merender tabel tanpa fitur edit/hapus.
     */
    async function fetchAttendanceData(isReadOnly = false) {
        const container = document.getElementById('attendance-records-container');
        if (!container) return;

        // Tampilkan loader saat data sedang dimuat
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 text-center" style="min-height: 300px;">
                <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p class="text-text-secondary text-lg font-medium">Memuat data absensi dari server...</p>
                <p class="text-text-secondary text-sm">Mohon tunggu sebentar, ini bisa memakan waktu beberapa saat jika data banyak.</p>
            </div>`;

        try {
            // Fetch data dari spreadsheet dengan cache-busting (menambahkan timestamp)
            const response = await fetch(`${SPREADSHEET_URL}?t=${new Date().getTime()}`);
            if (!response.ok) {
                throw new Error(`Gagal mengambil data dari server (Status: ${response.status}).`);
            }
            
            const responseData = await response.json();
            if (responseData.result === 'error') {
                throw new Error(responseData.error || "Terjadi error di server Apps Script.");
            }

            if (!Array.isArray(responseData)) {
                throw new Error("Format data yang diterima dari server tidak valid (bukan array).");
            }
            
            // Proses dan urutkan data: ubah string timestamp menjadi objek Date dan urutkan dari yang terbaru
            fullAttendanceData = responseData.map(row => {
                const parsedDate = new Date(row.timestamp);
                return {
                    ...row,
                    parsedDate: !isNaN(parsedDate.getTime()) ? parsedDate : null
                };
            }).sort((a, b) => (b.parsedDate?.getTime() || 0) - (a.parsedDate?.getTime() || 0));

            renderTable(fullAttendanceData, isReadOnly);

        } catch (error) {
            console.error('Error fetching attendance data:', error);
            // Tampilkan pesan error yang informatif jika fetch gagal
            container.innerHTML = `
                <div class="form-section-card !bg-danger-color/10 border-danger-color/50 !p-6 text-center">
                    <h3 class="text-2xl font-bold text-danger-color mb-3">Gagal Memuat Data</h3>
                    <p class="text-text-secondary mb-4">Terjadi masalah saat mengambil data dari Google Sheet. Periksa koneksi internet Anda atau hubungi administrator.</p>
                    <div class="text-left text-sm bg-black/20 p-4 rounded-lg">
                        <strong class="text-warning-color">Detail Error:</strong>
                        <pre class="whitespace-pre-wrap text-text-secondary mt-1">${error.message}</pre>
                    </div>
                </div>`;
        }
    }
    
    /**
     * Merender tabel laporan absensi berdasarkan data yang diberikan.
     * @param {Array} data - Array objek data absensi yang akan ditampilkan.
     * @param {boolean} [isReadOnly=false] - Mode read-only atau tidak.
     */
    function renderTable(data, isReadOnly = false) {
        const container = document.getElementById('attendance-records-container');
        if (!container) return;
        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-text-secondary py-8">Tidak ada data absensi untuk ditampilkan.</p>';
            return;
        }

        const tableHTML = `
            <table class="report-table" id="report-table-main">
                <thead>
                    <tr>
                        ${!isReadOnly ? '<th><input type="checkbox" id="select-all-checkbox" title="Pilih Semua"></th>' : ''}
                        <th>Nama</th>
                        <th style="width: 30%;">Ruangan</th>
                        <th>Tanggal</th>
                        <th>Waktu</th>
                        <th>GPS</th>
                        <th>Penilaian</th>
                        ${!isReadOnly ? '<th>Aksi</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => {
                        const timestamp = row.timestamp || new Date().toISOString(); // Fallback timestamp
                        const formattedDate = row.tanggal || (row.parsedDate ? formatDateForDisplay(row.parsedDate) : 'N/A');
                        const formattedTime = row.waktu || (row.parsedDate ? row.parsedDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' }) + ' WIB' : '');
                        const gpsLink = row.gps ? `https://www.google.com/maps?q=${row.gps}` : '#';
                        
                        return `
                        <tr data-timestamp="${timestamp}">
                            ${!isReadOnly ? `<td><input type="checkbox" class="row-checkbox" data-timestamp="${timestamp}"></td>` : ''}
                            <td class="font-medium">${row.nama || '<em>Tidak ada nama</em>'}</td>
                            <td class="room-cell">${row.nama_ruang || '<em>Tidak ada ruangan</em>'}</td>
                            <td id="date-cell-${timestamp}">${formattedDate}</td>
                            <td id="time-cell-${timestamp}">${formattedTime}</td>
                            <td>
                                <a href="${gpsLink}" target="_blank" class="text-accent-primary hover:underline" title="Lihat di Google Maps">
                                    ${(row.gps || '').substring(0,20)}...
                                </a>
                            </td>
                            <td id="assessment-cell-${timestamp}">
                                ${isReadOnly ? (row.penilaian || '<em>Belum dinilai</em>') : `
                                <div class="flex items-center">
                                <select class="assessment-select" onchange="handleAssessmentChange('${timestamp}', this)" aria-label="Penilaian untuk ${row.nama}">
                                    <option value="">-- Beri Nilai --</option>
                                    <option value="Baik" ${row.penilaian === 'Baik' ? 'selected' : ''}>Baik</option>
                                    <option value="Cukup Baik" ${row.penilaian === 'Cukup Baik' ? 'selected' : ''}>Cukup Baik</option>
                                    <option value="Kurang Baik" ${row.penilaian === 'Kurang Baik' ? 'selected' : ''}>Kurang Baik</option>
                                </select>
                                <span id="status-${timestamp}" class="ml-2"></span>
                                </div>
                                `}
                            </td>
                            ${!isReadOnly ? `<td id="action-cell-${timestamp}">
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary !py-1 !px-2 text-xs" onclick="editRecord('${timestamp}')" title="Edit Tanggal/Waktu">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                                    </button>
                                    <button class="btn btn-danger !py-1 !px-2 text-xs" onclick="deleteRecord('${timestamp}')" title="Hapus Data">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                                </td>` : ''}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`;
        container.innerHTML = tableHTML;
        if (!isReadOnly) setupBulkActions();
    }
    
    /**
     * Mengaktifkan mode edit untuk satu baris data di tabel laporan.
     * @param {string} timestamp - ID unik dari rekaman data (ISO string).
     */
    function editRecord(timestamp) {
        // Jika sedang mengedit baris lain, batalkan dulu untuk menghindari konflik
        if (editingState.timestamp && editingState.timestamp !== timestamp) {
            cancelEdit(editingState.timestamp);
        }
        const dateCell = document.getElementById(`date-cell-${timestamp}`);
        const timeCell = document.getElementById(`time-cell-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        if (!dateCell || !timeCell || !actionCell) return;

        const originalRowData = fullAttendanceData.find(row => row.timestamp === timestamp);
        if (!originalRowData || !originalRowData.parsedDate) {
            alert("Data tanggal asli tidak valid, tidak bisa mengedit.");
            return;
        }

        // Simpan state HTML dan data asli sebelum diubah
        editingState = {
            timestamp: timestamp,
            originalDateHTML: dateCell.innerHTML,
            originalTimeHTML: timeCell.innerHTML,
            originalActionHTML: actionCell.innerHTML
        };
        
        // Format tanggal dan waktu agar sesuai dengan value input type="date" dan "time"
        const dateForInput = new Date(originalRowData.parsedDate.getTime() - (originalRowData.parsedDate.getTimezoneOffset() * 60000))
                            .toISOString().split('T')[0];
        const timeValue = originalRowData.parsedDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        dateCell.innerHTML = `<input type="date" id="date-input-${timestamp}" class="date-time-input w-full" value="${dateForInput}">`;
        timeCell.innerHTML = `<input type="time" id="time-input-${timestamp}" class="date-time-input w-full" value="${timeValue}">`;
        actionCell.innerHTML = `
            <div class="flex gap-2">
                <button class="btn btn-success !p-2 text-xs icon-only" onclick="saveRecord('${timestamp}')" title="Simpan Perubahan">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
                <button class="btn btn-secondary !p-2 text-xs icon-only" onclick="cancelEdit('${timestamp}')" title="Batal Edit">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        `;
    }

    /**
     * Membatalkan mode edit dan mengembalikan sel ke tampilan semula.
     * @param {string} timestamp - ID unik dari rekaman data.
     */
    function cancelEdit(timestamp) {
        const dateCell = document.getElementById(`date-cell-${timestamp}`);
        const timeCell = document.getElementById(`time-cell-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        if (editingState.timestamp === timestamp) {
            dateCell.innerHTML = editingState.originalDateHTML;
            timeCell.innerHTML = editingState.originalTimeHTML;
            actionCell.innerHTML = editingState.originalActionHTML;
            // Reset state
            editingState = {}; 
        }
    }

    /**
     * Menyimpan perubahan tanggal dan waktu ke Google Sheet.
     * @param {string} timestamp - ID unik dari rekaman data.
     */
    async function saveRecord(timestamp) {
        const newDateInput = document.getElementById(`date-input-${timestamp}`);
        const newTimeInput = document.getElementById(`time-input-${timestamp}`);
        const actionCell = document.getElementById(`action-cell-${timestamp}`);
        
        if (!newDateInput || !newTimeInput || !newDateInput.value || !newTimeInput.value) {
            alert('Tanggal dan waktu tidak boleh kosong!'); 
            return;
        }
        
        actionCell.innerHTML = `<div class="loader !w-6 !h-6 mx-auto"></div>`;
        
        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('timestamp', timestamp);
        formData.append('newDate', newDateInput.value);
        formData.append('newTime', newTimeInput.value);
        
        try {
            const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            const result = await res.json();
            if (result.result === 'success') {
                alert('Data berhasil diperbarui! Memuat ulang seluruh data laporan...');
                // Muat ulang semua data untuk memastikan konsistensi
                await fetchAttendanceData(false); 
            } else { 
                throw new Error(result.error || 'Gagal memperbarui data di server.'); 
            }
        } catch (error) {
            alert(`Gagal menyimpan perubahan: ${error.message}`);
            // Jika gagal, kembalikan ke state semula
            cancelEdit(timestamp);
        }
    }
    
    /**
     * Menangani perubahan pada dropdown penilaian dan menyimpannya secara asynchronous.
     * @param {string} timestamp - ID unik dari rekaman data.
     * @param {HTMLSelectElement} selectElement - Elemen <select> yang berubah.
     */
    async function handleAssessmentChange(timestamp, selectElement) {
        const value = selectElement.value;
        const statusSpan = document.getElementById(`status-${timestamp}`);
        if (!statusSpan) return;
        
        statusSpan.innerHTML = `<div class="loader inline-loader"></div>`;
        selectElement.disabled = true;
        
        try {
            await updateAssessment(timestamp, value);
            statusSpan.innerHTML = `✅`;
        } catch (error) {
            statusSpan.innerHTML = `❌`;
            alert(`Gagal menyimpan penilaian. Coba lagi.\nError: ${error.reason}`);
            // Kembalikan ke nilai semula jika gagal
            const originalData = fullAttendanceData.find(d => d.timestamp === timestamp);
            if (originalData) selectElement.value = originalData.penilaian || "";
        } finally {
            selectElement.disabled = false;
            // Hilangkan ikon status setelah beberapa detik
            setTimeout(() => { statusSpan.innerHTML = ''; }, 3000);
        }
    }

    /**
     * Mengirim pembaruan data penilaian ke Google Sheet.
     * @param {string} timestamp - ID unik rekaman.
     * @param {string} value - Nilai baru (e.g., "Baik").
     * @returns {Promise<object>}
     */
    async function updateAssessment(timestamp, value) {
        if (!timestamp) {
            return Promise.reject(new Error("Timestamp tidak valid."));
        }
        const formData = new FormData();
        formData.append('action', 'updateAssessment');
        formData.append('timestamp', timestamp);
        formData.append('penilaian', value);
        
        try {
            const res = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            if (!res.ok) { throw new Error(`Network response was not ok: ${res.statusText}`); }
            const result = await res.json();
            if (result.result !== 'success') {
                throw new Error(result.error || 'Server error during assessment update');
            }
            
            // Update data di cache lokal agar UI sinkron tanpa perlu fetch ulang
            const dataIndex = fullAttendanceData.findIndex(d => d.timestamp === timestamp);
            if(dataIndex > -1) fullAttendanceData[dataIndex].penilaian = value;
            
            return { status: 'fulfilled', timestamp };
        } catch (error) {
            console.error(`Error saat memperbarui penilaian untuk ${timestamp}:`, error);
            return Promise.reject({ status: 'rejected', timestamp, reason: error.message });
        }
    }
    
    /**
     * Menyiapkan fungsionalitas untuk aksi massal (bulk actions) seperti pilih semua,
     * nilai massal, dan hapus massal pada tabel laporan.
     */
    function setupBulkActions() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkActionPanel = document.getElementById('bulk-action-panel');
        const selectionCount = document.getElementById('selection-count');
        const applyBtn = document.getElementById('apply-bulk-action-btn');
        const bulkSelect = document.getElementById('bulk-assessment-select');
        const bulkDeleteBtn = document.getElementById('apply-bulk-delete-btn');
        if (!selectAllCheckbox || !bulkActionPanel) return;

        /**
         * Memperbarui visibilitas panel aksi massal dan status checkbox "pilih semua".
         */
        function updatePanelVisibility() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (checkedCount > 0) {
                bulkActionPanel.classList.remove('hidden', 'opacity-0');
                bulkActionPanel.classList.add('flex');
                selectionCount.textContent = `${checkedCount} data terpilih`;
            } else {
                bulkActionPanel.classList.add('hidden', 'opacity-0');
                bulkActionPanel.classList.remove('flex');
            }
            // Sinkronkan status checkbox "pilih semua"
            selectAllCheckbox.checked = checkedCount > 0 && checkedCount === rowCheckboxes.length;
        }

        // Event listener untuk checkbox "pilih semua"
        selectAllCheckbox.addEventListener('change', () => {
            rowCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updatePanelVisibility();
        });
        
        // Event listener untuk setiap checkbox di baris tabel
        rowCheckboxes.forEach(cb => cb.addEventListener('change', updatePanelVisibility));

        // Event listener untuk tombol "Terapkan" penilaian massal
        applyBtn.addEventListener('click', async () => {
            const valueToApply = bulkSelect.value;
            if (!valueToApply) {
                alert('Pilih nilai yang akan diterapkan!'); 
                return;
            }
            const checkedBoxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            const timestampsToUpdate = checkedBoxes.map(cb => cb.dataset.timestamp).filter(Boolean);
            if (timestampsToUpdate.length === 0) return;
            
            applyBtn.disabled = true;
            applyBtn.innerHTML = `<div class="loader !w-4 !h-4"></div>`;
            
            // Jalankan semua pembaruan secara paralel
            const results = await Promise.allSettled(timestampsToUpdate.map(ts => updateAssessment(ts, valueToApply)));
            
            let successCount = 0;
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    successCount++;
                    const row = document.querySelector(`tr[data-timestamp="${result.value.timestamp}"]`);
                    if (row) {
                        const assessmentSelect = row.querySelector('.assessment-select');
                        if (assessmentSelect) assessmentSelect.value = valueToApply;
                        // Beri efek visual pada baris yang berhasil diupdate
                        row.classList.add('flash-success');
                        setTimeout(() => row.classList.remove('flash-success'), 1500);
                    }
                }
            });

            applyBtn.disabled = false;
            applyBtn.innerHTML = 'Terapkan';

            let alertMessage = `Operasi selesai. ${successCount} dari ${timestampsToUpdate.length} data berhasil diperbarui.`;
            const failureCount = timestampsToUpdate.length - successCount;
            if (failureCount > 0) {
                alertMessage += `\n${failureCount} data GAGAL diperbarui karena masalah jaringan atau server.`;
            }
            alert(alertMessage);
            
            // Hapus centang pada semua checkbox dan sembunyikan panel
            checkedBoxes.forEach(cb => cb.checked = false);
            updatePanelVisibility();
        });
        
        // Event listener untuk tombol "Hapus Terpilih"
        bulkDeleteBtn.addEventListener('click', async () => {
            const checkedBoxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            const timestampsToDelete = checkedBoxes.map(cb => cb.dataset.timestamp).filter(Boolean);
            if (timestampsToDelete.length === 0) return;
            
            if (!confirm(`ANDA YAKIN?\n\nAnda akan menghapus ${timestampsToDelete.length} data terpilih secara permanen. Aksi ini tidak dapat dibatalkan.`)) return;
            
            bulkDeleteBtn.disabled = true;
            bulkDeleteBtn.innerHTML = `<div class="loader !w-4 !h-4"></div>`;
            
            // Hapus data secara paralel
            const results = await Promise.allSettled(timestampsToDelete.map(ts => deleteRecord(ts, false)));
            
            let successCount = 0;
            results.forEach(result => { 
                if (result.status === 'fulfilled') {
                    successCount++;
                    const row = document.querySelector(`tr[data-timestamp="${result.value.timestamp}"]`);
                    if(row) row.remove(); // Hapus baris dari DOM
                }
            });
            
            let alertMessage = `${successCount} dari ${timestampsToDelete.length} data berhasil dihapus.`;
            if (successCount < timestampsToDelete.length) {
                alertMessage += `\n${timestampsToDelete.length - successCount} data gagal dihapus.`;
            }
            alert(alertMessage);
            
            // Reset UI
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = 'Hapus Terpilih';
            updatePanelVisibility();
        });
    }
    
    /**
     * Menghapus satu rekaman data dari Google Sheet.
     * @param {string} timestamp - ID unik rekaman.
     * @param {boolean} [showConfirmation=true] - Tampilkan dialog konfirmasi atau tidak (berguna untuk hapus massal).
     * @returns {Promise<object>}
     */
    async function deleteRecord(timestamp, showConfirmation = true) {
        if (!timestamp) return Promise.reject(new Error('ID rekaman tidak valid.')); 
        
        const performDelete = async () => {
            const rowToDelete = document.querySelector(`tr[data-timestamp="${timestamp}"]`);
            try {
                if (rowToDelete) rowToDelete.style.opacity = '0.5';
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('timestamp', timestamp);
                
                const response = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
                if (!response.ok) { throw new Error(`Network error: ${response.statusText}`); }
                
                const result = await response.json();
                if (result.result === 'success') {
                    if (rowToDelete) rowToDelete.remove();
                    // Hapus dari cache lokal agar data tetap konsisten
                    fullAttendanceData = fullAttendanceData.filter(row => row.timestamp !== timestamp);
                    return Promise.resolve({ timestamp });
                } else { 
                    throw new Error(result.error || 'Gagal menghapus di server.'); 
                }
            } catch (error) {
                if (showConfirmation) alert(`Gagal menghapus: ${error.message}`);
                if (rowToDelete) rowToDelete.style.opacity = '1'; // Kembalikan opacity jika gagal
                return Promise.reject({ timestamp, reason: error.message });
            }
        };
        
        if (showConfirmation) {
            if (confirm('Yakin ingin menghapus rekapan ini secara permanen? Aksi ini tidak bisa dibatalkan.')) {
                await performDelete();
                alert('Rekapan berhasil dihapus.');
            }
        } else {
            return await performDelete();
        }
    }
    
    /**
     * Membuat file PDF dari data laporan absensi yang sedang ditampilkan/difilter.
     */
    function generatePdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });

        const startDateVal = document.getElementById('start-date').value;
        const endDateVal = document.getElementById('end-date').value;
        let dateRangeText = "Seluruh Periode";
        let dataToPrint = fullAttendanceData;

        // Filter data berdasarkan rentang tanggal jika dipilih
        if (startDateVal && endDateVal) {
            try {
                const startDate = new Date(startDateVal + 'T00:00:00Z');
                const endDate = new Date(endDateVal + 'T23:59:59Z');
                dataToPrint = fullAttendanceData.filter(row => row.parsedDate && row.parsedDate >= startDate && row.parsedDate <= endDate);
                
                const start = new Date(startDateVal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
                const end = new Date(endDateVal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
                dateRangeText = `Periode ${start} - ${end}`;
            } catch (e) {
                alert("Format tanggal tidak valid.");
                return;
            }
        }
        
        if (dataToPrint.length === 0) {
            alert("Tidak ada data untuk dicetak pada rentang tanggal ini.");
            return;
        }

        // Tambahkan judul ke PDF
        doc.setFontSize(18);
        doc.text("Laporan Absensi Kebersihan", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.text("Mahkamah Syar'iyah Simpang Tiga Redelong", doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 35, { align: 'center' });

        // Gunakan autoTable untuk membuat tabel di PDF
        doc.autoTable({
            startY: 45,
            head: [['Nama', 'Ruangan', 'Tanggal', 'Waktu', 'GPS', 'Penilaian']],
            body: dataToPrint.map(row => [
                row.nama || '',
                row.nama_ruang || '',
                row.tanggal || 'N/A',
                (row.waktu || '').replace('WIB', '').trim(),
                row.gps || '',
                row.penilaian || 'Belum dinilai'
            ]),
            theme: 'grid',
            headStyles: { fillColor: [40, 50, 60] },
            styles: { fontSize: 8, cellPadding: 4, overflow: 'linebreak' },
            columnStyles: { 
                1: { cellWidth: 80 } // Atur lebar kolom 'Ruangan'
            }, 
            didDrawPage: function(data) {
                // Tambahkan nomor halaman di footer setiap halaman
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text('Halaman ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.getHeight() - 10);
            }
        });

        doc.save(`Laporan-Absensi-Kebersihan-${new Date().toISOString().slice(0, 10)}.pdf`);
    }

    /**
     * Merender tabel pembagian tugas yang bisa diedit di halaman Supervisor.
     */
    function renderJobAllocationTable() {
        const container = document.getElementById('job-allocation-container');
        if(!container) return;
        const allocations = getJobAllocations();
        const table = document.createElement('table');
        table.className = 'report-table job-table';
        table.id = 'job-allocation-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Ruang Lantai 1</th>
                    <th>Ruang Lantai 2</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                ${allocations.map((alloc, index) => `
                    <tr data-index="${index}">
                        <td contenteditable="true" spellcheck="false">${alloc.name}</td>
                        <td contenteditable="true" spellcheck="false">${alloc.roomsLantai1}</td>
                        <td contenteditable="true" spellcheck="false">${alloc.roomsLantai2}</td>
                        <td>
                            <button class="btn btn-danger !py-1 !px-2 text-xs remove-allocation-row-btn" title="Hapus Baris Ini">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>`).join('')}
            </tbody>`;
        container.innerHTML = '';
        container.appendChild(table);
    }
    /**
     * Menyiapkan fungsionalitas di tab pembagian tugas.
     * Termasuk menyimpan, menambah baris, dan menghapus baris.
     */
    function setupAllocationListeners() {
        document.getElementById('save-allocations-btn').addEventListener('click', async () => {
            const table = document.getElementById('job-allocation-table');
            if (!table) return;
            
            const newAllocations = [];
            table.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                // Pastikan baris tidak kosong sebelum disimpan
                if (cells[0].innerText.trim()) {
                    newAllocations.push({
                        name: cells[0].innerText.trim(),
                        roomsLantai1: cells[1].innerText.trim(),
                        roomsLantai2: cells[2].innerText.trim(),
                    });
                }
            });

            await saveJobAllocations(newAllocations);
            alert('Pembagian tugas berhasil disimpan!');
            
            // Cek jika ada ruangan baru ditambahkan dari tabel, otomatis tambahkan ke master data ruangan
            const roomData = getRoomData();
            const allLantai1Rooms = new Set(roomData["Lantai 1"] || []);
            const allLantai2Rooms = new Set(roomData["Lantai 2"] || []);
            let roomsWereAdded = false;

            newAllocations.forEach(alloc => {
                const rooms1 = (alloc.roomsLantai1 || '').split(',').map(r => r.trim()).filter(Boolean);
                const rooms2 = (alloc.roomsLantai2 || '').split(',').map(r => r.trim()).filter(Boolean);
                rooms1.forEach(room => { if (!allLantai1Rooms.has(room)) { allLantai1Rooms.add(room); roomsWereAdded = true; } });
                rooms2.forEach(room => { if (!allLantai2Rooms.has(room)) { allLantai2Rooms.add(room); roomsWereAdded = true; } });
            });

            if (roomsWereAdded) {
                roomData["Lantai 1"] = Array.from(allLantai1Rooms).sort();
                roomData["Lantai 2"] = Array.from(allLantai2Rooms).sort();
                await saveRoomData(roomData);
                renderFloorManagement(); // Render ulang daftar ruangan
                alert('Ruangan baru dari tabel tugas telah ditambahkan ke data master Manajemen Ruangan.');
            }
            // Perbarui laporan progres setelah menyimpan tugas
            renderProgressReport();
        });
        
        document.getElementById('add-allocation-row-btn').addEventListener('click', () => {
             const table = document.getElementById('job-allocation-table').querySelector('tbody');
             const newRow = table.insertRow();
             newRow.innerHTML = `
                <td contenteditable="true" spellcheck="false">Nama Baru</td>
                <td contenteditable="true" spellcheck="false">Ruangan di Lantai 1 pisahkan dengan koma</td>
                <td contenteditable="true" spellcheck="false">Ruangan di Lantai 2 pisahkan dengan koma</td>
                <td>
                    <button class="btn btn-danger !py-1 !px-2 text-xs remove-allocation-row-btn" title="Hapus Baris Ini">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>`;
        });
        
        document.getElementById('job-allocation-container').addEventListener('click', e => {
            const removeBtn = e.target.closest('.remove-allocation-row-btn');
            if (removeBtn) {
                if (confirm('Yakin ingin menghapus baris tugas ini?')) { 
                    removeBtn.closest('tr').remove(); 
                }
            }
        });
        
        document.getElementById('generate-progress-report-btn').addEventListener('click', renderProgressReport);
    }
    
    /**
     * Merender laporan progres harian dalam bentuk tabel silang (crosstab).
     * Tabel ini menunjukkan status penyelesaian tugas setiap pegawai per hari.
     */
    function renderProgressReport() {
        const container = document.getElementById('progress-report-container');
        const startDateInput = document.getElementById('progress-report-start-date');
        const endDateInput = document.getElementById('progress-report-end-date');

        if (!startDateInput.value || !endDateInput.value) {
            container.innerHTML = `<p class="text-center text-text-secondary py-8">Pilih rentang tanggal untuk menampilkan laporan progres.</p>`;
            return;
        }

        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate > endDate) {
            container.innerHTML = `<p class="text-center text-danger-color py-8">Tanggal mulai tidak boleh lebih besar dari tanggal selesai.</p>`;
            return;
        }

        // Buat array tanggal dalam rentang yang dipilih
        const datesInRange = [];
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            datesInRange.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const reminderSettings = getDataFromCache('reminderSettings', { activeDays: [1, 2, 3, 4, 5] });
        const workingDays = new Set(reminderSettings.activeDays);
        
        const allocations = getJobAllocations();
        
        // Optimasi: Proses data absensi sekali saja dan simpan dalam Map untuk lookup cepat
        const cleanedData = new Map();
        fullAttendanceData.forEach(record => {
            if (!record.parsedDate) return;
            const recordDate = new Date(record.parsedDate);
            // Kunci tanggal format YYYY-MM-DD
            const dateKey = `${recordDate.getUTCFullYear()}-${String(recordDate.getUTCMonth() + 1).padStart(2, '0')}-${String(recordDate.getUTCDate()).padStart(2, '0')}`;
            const mapKey = `${record.nama}-${dateKey}`;
            
            if (!cleanedData.has(mapKey)) cleanedData.set(mapKey, new Set());
            const cleanedRooms = (record.nama_ruang || '').split(',').map(r => r.trim()).filter(Boolean);
            cleanedRooms.forEach(room => cleanedData.get(mapKey).add(room));
        });

        const tableHead = `
            <thead>
                <tr>
                    <th>Nama Pegawai</th>
                    ${datesInRange.map(date => {
                        const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                        const dateString = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                        return `<th>${dayName}<br>${dateString}</th>`;
                    }).join('')}
                </tr>
            </thead>`;

        const tableBody = `
            <tbody>
                ${allocations.map(alloc => {
                    const assignedRooms = new Set((alloc.roomsLantai1 + ", " + alloc.roomsLantai2).split(',').map(r => r.trim()).filter(Boolean));
                    // Jangan render baris jika pegawai tidak punya tugas
                    if (assignedRooms.size === 0) return ''; 
                    
                    return `
                        <tr>
                            <td>${alloc.name}</td>
                            ${datesInRange.map(date => {
                                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                const mapKey = `${alloc.name}-${dateKey}`;
                                const cleanedRoomsToday = cleanedData.get(mapKey) || new Set();
                                const isWorkDay = workingDays.has(date.getDay());
                                
                                if (!isWorkDay) {
                                    return `<td class="is-off-day">Libur</td>`;
                                }

                                const unfinishedRooms = [...assignedRooms].filter(room => !cleanedRoomsToday.has(room));
                                
                                let cellContent = '';
                                if (cleanedRoomsToday.size > 0) {
                                    cellContent += `<div class="recap-complete">Selesai: <ul>${[...cleanedRoomsToday].map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                                }
                                if (unfinishedRooms.length > 0) {
                                    cellContent += `<div class="recap-incomplete mt-2">Belum: <ul>${unfinishedRooms.map(r => `<li>- ${r}</li>`).join('')}</ul></div>`;
                                    // Tambah tombol untuk menandai selesai secara manual
                                    cellContent += `<button class="btn btn-secondary recap-action-btn" onclick="markDayAsComplete('${alloc.name}', '${dateKey}', '${unfinishedRooms.join(',')}')">Tandai Selesai</button>`;
                                }
                                
                                if (cellContent === '' && assignedRooms.size > 0) {
                                    cellContent = `<em>Tidak Ada Laporan</em><button class="btn btn-secondary recap-action-btn" onclick="markDayAsComplete('${alloc.name}', '${dateKey}', '${[...assignedRooms].join(',')}')">Tandai Selesai</button>`;
                                } else if (cellContent !== '' && unfinishedRooms.length === 0) {
                                     cellContent += `<div class="recap-complete mt-2"><strong>✅ Semua Selesai</strong></div>`;
                                }


                                return `<td>${cellContent}</td>`;
                            }).join('')}
                        </tr>`;
                }).join('')}
            </tbody>`;

        container.innerHTML = `<table class="daily-recap-table">${tableHead}${tableBody}</table>`;
        // Aktifkan scrollbar ganda untuk tabel yang sangat lebar ini
        setupDualScrollbars('progress-report-container', 'top-scrollbar-wrapper');
    }

    /**
     * Membuat entri absensi manual untuk pegawai oleh Pengawas.
     * @param {string} name - Nama pegawai.
     * @param {string} dateKey - Tanggal format YYYY-MM-DD.
     * @param {string} unfinishedRooms - Daftar ruangan yang akan ditandai selesai, dipisahkan koma.
     */
    async function markDayAsComplete(name, dateKey, unfinishedRooms) {
        if (!confirm(`Anda akan membuat absensi manual untuk ${name} pada tanggal ${dateKey} untuk ruangan:\n\n${unfinishedRooms.replace(/,/g, '\n')}\n\nLanjutkan?`)) return;

        const container = document.getElementById('progress-report-container');
        container.style.opacity = '0.5'; // Beri feedback visual bahwa proses sedang berjalan
        
        try {
            const targetDate = new Date(`${dateKey}T08:00:00Z`); // Gunakan Z untuk UTC
            
            // Siapkan data seolah-olah diisi oleh pegawai
            const timestamp = targetDate.toISOString().slice(0, -1);
            const formattedDate = targetDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
            const formattedTime = '08:00 WIB'; // Waktu default untuk entri manual

            const centerGps = getPolygonCenter();
            
            const formData = new FormData();
            formData.append('nama', name);
            formData.append('nama_ruang', unfinishedRooms);
            formData.append('timestamp', timestamp);
            formData.append('tanggal', formattedDate);
            formData.append('waktu', formattedTime);
            formData.append('gps', centerGps);
            formData.append('catatan', `Entri dibuat manual oleh Pengawas pada ${new Date().toLocaleString('id-ID')}`);
            formData.append('foto', ''); // Foto kosong untuk entri manual

            const response = await fetch(SPREADSHEET_URL, { method: 'POST', body: formData });
            const result = await response.json();

            if (result.result !== 'success') throw new Error(JSON.stringify(result.error));

            alert(`Absensi untuk ${name} pada ${dateKey} berhasil dikirim.`);
            
            // Tambahkan data baru ke cache lokal dan render ulang laporan agar UI update
            const newRecord = {
                nama: name,
                nama_ruang: unfinishedRooms,
                timestamp: timestamp,
                parsedDate: targetDate,
                tanggal: formattedDate,
                waktu: formattedTime,
                gps: centerGps,
                catatan: `Entri dibuat manual oleh Pengawas pada ${new Date().toLocaleString('id-ID')}`,
                foto: ''
            };
            fullAttendanceData.unshift(newRecord); // Tambahkan ke awal array
            renderProgressReport();

        } catch (error) {
            console.error(`Gagal mengirim data manual untuk ${name}:`, error);
            alert(`Gagal mengirim data. Error: ${error.message}`);
        } finally {
            container.style.opacity = '1';
        }
    }
    
    /**
     * Helper untuk mendapatkan titik tengah dari poligon area kantor yang aktif.
     * @returns {string} Koordinat tengah dalam format "lat,lon".
     */
    function getPolygonCenter() {
        const coords = getActivePolygon();
        if (!coords || coords.length === 0) return '0,0';
        let latSum = 0, lonSum = 0;
        coords.forEach(c => { latSum += c[0]; lonSum += c[1]; });
        return `${(latSum / coords.length).toFixed(7)}, ${(lonSum / coords.length).toFixed(7)}`;
    }

    /**
     * Menyiapkan fungsionalitas di tab Pengaturan Absensi (mode, jendela waktu).
     */
    function setupAttendanceSettings() {
        const modeRadios = document.querySelectorAll('input[name="attendance_mode"]');
        const startTimeInput = document.getElementById('start-time-setting');
        const endTimeInput = document.getElementById('end-time-setting');
        const timeWindowInputsDiv = document.getElementById('time-window-inputs');
        const saveBtn = document.getElementById('save-attendance-settings-btn');
        if (!modeRadios.length) return;

        function toggleTimeInputs(isWindowMode) {
            if (isWindowMode) {
                timeWindowInputsDiv.style.opacity = '1';
                startTimeInput.disabled = false;
                endTimeInput.disabled = false;
            } else {
                timeWindowInputsDiv.style.opacity = '0.5';
                startTimeInput.disabled = true;
                endTimeInput.disabled = true;
            }
        }
        
        // Muat pengaturan saat ini ke UI
        const currentSettings = getDataFromCache('attendanceSettings', { mode: 'manual', startTime: '08:00', endTime: '17:00' });
        
        const radioToCheck = document.querySelector(`input[name="attendance_mode"][value="${currentSettings.mode}"]`);
        if(radioToCheck) radioToCheck.checked = true;
        
        startTimeInput.value = currentSettings.startTime || '08:00';
        endTimeInput.value = currentSettings.endTime || '17:00';
        toggleTimeInputs(currentSettings.mode === 'window');

        modeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                toggleTimeInputs(radio.value === 'window');
            });
        });

        saveBtn.addEventListener('click', async () => {
            const selectedMode = document.querySelector('input[name="attendance_mode"]:checked').value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            if (selectedMode === 'window' && (!startTime || !endTime)) {
                alert('Untuk Mode Jendela Waktu, jam mulai dan selesai wajib diisi.');
                return;
            }

            const newSettings = {
                mode: selectedMode,
                startTime: startTime,
                endTime: endTime
            };

            await updateAndSaveData('attendanceSettings', newSettings);
            alert(`Pengaturan absensi berhasil disimpan. Mode aktif saat ini: ${selectedMode.toUpperCase()}.`);
        });
    }

    /**
     * Menyiapkan fungsionalitas di tab Manajemen Akses (password).
     */
    function setupAccessManagement() {
        const toggleInputs = document.querySelectorAll('.toggle-input');
        const pengawasInput = document.getElementById('pengawas-password');
        const pegawaiInput = document.getElementById('pegawai-password');
        const pengunjungInput = document.getElementById('pengunjung-password');
        const saveBtn = document.getElementById('save-access-settings-btn');
        const visibilityToggles = document.querySelectorAll('.password-visibility-toggle');

        function loadSettingsToUI() {
            const credentials = getCredentials();
            toggleInputs.forEach(input => {
                const role = input.dataset.role;
                input.checked = credentials.passwordStates[role];
                updateVisualState(role, input.checked);
            });
            // Kosongkan input password demi keamanan setiap kali tab dibuka
            pengawasInput.value = '';
            pegawaiInput.value = '';
            pengunjungInput.value = '';
        }

        function updateVisualState(role, isEnabled) {
            const statusEl = document.getElementById(`password-toggle-status-${role}`);
            if (isEnabled) {
                statusEl.textContent = "Status: Aktif (Password Diperlukan)";
                statusEl.style.color = 'var(--success-color)';
            } else {
                statusEl.textContent = "Status: Nonaktif (Login Tanpa Password)";
                statusEl.style.color = 'var(--warning-color)';
            }
        }

        toggleInputs.forEach(input => {
            input.addEventListener('change', () => {
                const role = input.dataset.role;
                updateVisualState(role, input.checked);
            });
        });

        saveBtn.addEventListener('click', async () => {
            let credentials = getCredentials();
            
            toggleInputs.forEach(input => {
                const role = input.dataset.role;
                credentials.passwordStates[role] = input.checked;
            });
            
            // Hanya update password jika input diisi (tidak kosong)
            if (pengawasInput.value) credentials.pengawasPassword = pengawasInput.value;
            if (pegawaiInput.value) credentials.pegawaiPassword = pegawaiInput.value;
            if (pengunjungInput.value) credentials.pengunjungPassword = pengunjungInput.value;

            await saveCredentials(credentials);
            alert('Pengaturan akses dan password berhasil disimpan!');
            loadSettingsToUI(); // Muat ulang UI untuk mengosongkan input
        });
        
        visibilityToggles.forEach(toggle => {
            const input = toggle.previousElementSibling;
            toggle.addEventListener('click', () => {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                toggle.querySelector('.eye-icon').classList.toggle('hidden', isPassword);
                toggle.querySelector('.eye-slash-icon').classList.toggle('hidden', !isPassword);
            });
        });

        loadSettingsToUI();
    }
    
    // Variabel global untuk menyimpan ID interval pengingat
    let reminderIntervalId = null; 

    /**
     * Menyiapkan fungsionalitas di tab Pengingat WhatsApp.
     */
    function setupReminderTab() {
        const whatsAppListContainer = document.getElementById('whatsapp-list-container');
        const addWhatsAppBtn = document.getElementById('add-whatsapp-number-btn');
        const newWhatsAppInput = document.getElementById('new-whatsapp-number');
        const saveSettingsBtn = document.getElementById('save-reminder-settings-btn');
        const dayToggleButtons = document.querySelectorAll('.day-toggle-btn');
        const statusLog = document.getElementById('reminder-status-log');

        const settingsKey = 'reminderSettings';

        const getDefaultSettings = () => ({
            numbers: [],
            interval: 2,
            unit: 'hours',
            startTime: '08:00',
            endTime: '17:00',
            activeDays: [1, 2, 3, 4, 5] // Senin-Jumat (0=Minggu, 1=Senin, dst)
        });

        let currentSettings = getDataFromCache(settingsKey, getDefaultSettings());

        function renderWhatsAppNumbers() {
            whatsAppListContainer.innerHTML = currentSettings.numbers.map(num => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="font-mono">${num}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-whatsapp-btn" data-number="${num}">Hapus</button>
                </div>
            `).join('') || `<p class="text-text-secondary text-center">Belum ada nomor WhatsApp tujuan.</p>`;
        }

        function updateDayButtonsUI() {
            dayToggleButtons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (currentSettings.activeDays.includes(day)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function loadSettingsToUI() {
            renderWhatsAppNumbers();
            document.getElementById('reminder-interval').value = currentSettings.interval;
            document.getElementById('reminder-unit').value = currentSettings.unit;
            document.getElementById('reminder-start-time').value = currentSettings.startTime;
            document.getElementById('reminder-end-time').value = currentSettings.endTime;
            updateDayButtonsUI();
        }

        addWhatsAppBtn.addEventListener('click', () => {
            const number = newWhatsAppInput.value.trim();
            if (!number || !/^\d{10,15}$/.test(number)) {
                alert('Masukkan nomor WhatsApp yang valid (hanya angka, 10-15 digit), contoh: 6281234567890.');
                return;
            }
            if (currentSettings.numbers.includes(number)) {
                alert('Nomor ini sudah ada dalam daftar.');
                return;
            }
            currentSettings.numbers.push(number);
            newWhatsAppInput.value = '';
            renderWhatsAppNumbers();
        });

        whatsAppListContainer.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-whatsapp-btn');
            if (removeBtn) {
                const numberToRemove = removeBtn.dataset.number;
                currentSettings.numbers = currentSettings.numbers.filter(n => n !== numberToRemove);
                renderWhatsAppNumbers();
            }
        });

        dayToggleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const day = parseInt(btn.dataset.day);
                const index = currentSettings.activeDays.indexOf(day);
                if (index > -1) {
                    currentSettings.activeDays.splice(index, 1);
                } else {
                    currentSettings.activeDays.push(day);
                }
            });
        });

        saveSettingsBtn.addEventListener('click', async () => {
            currentSettings.interval = parseInt(document.getElementById('reminder-interval').value) || 2;
            currentSettings.unit = document.getElementById('reminder-unit').value;
            currentSettings.startTime = document.getElementById('reminder-start-time').value;
            currentSettings.endTime = document.getElementById('reminder-end-time').value;

            await updateAndSaveData(settingsKey, currentSettings);
            alert('Pengaturan pengingat berhasil disimpan dan diaktifkan!');
            statusLog.textContent = `Status: Aktif. Pengecekan setiap ${currentSettings.interval} ${currentSettings.unit}.`;

            startReminderService();
        });

        loadSettingsToUI();
        if (localStorage.getItem(settingsKey)) {
            statusLog.textContent = `Status: Aktif. Pengecekan setiap ${currentSettings.interval} ${currentSettings.unit}.`;
            startReminderService();
        }
    }

    /**
     * Memulai service pengecekan tugas di latar belakang (client-side).
     * Akan memeriksa secara berkala dan menampilkan notifikasi jika ada tugas yang belum selesai.
     */
    function startReminderService() {
        if (reminderIntervalId) {
            clearInterval(reminderIntervalId); 
        }

        const settings = getDataFromCache('reminderSettings', null);
        if (!settings || settings.numbers.length === 0) {
            console.log("Layanan Pengingat dihentikan: tidak ada nomor tujuan.");
            return;
        }

        const checkIntervalMs = settings.unit === 'hours' 
            ? settings.interval * 60 * 60 * 1000 
            : settings.interval * 60 * 1000;

        reminderIntervalId = setInterval(async () => {
            const now = new Date();
            const currentDay = now.getDay(); 
            const currentTime = now.toTimeString().slice(0, 5);

            // Cek apakah saat ini berada dalam jadwal pengingat (hari dan jam)
            if (!settings.activeDays.includes(currentDay) || currentTime < settings.startTime || currentTime > settings.endTime) {
                console.log("Di luar jadwal pengingat. Pengecekan dilewati.");
                return;
            }

            console.log("Menjalankan pengecekan tugas untuk pengingat...");

            const allocations = getJobAllocations();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const attendanceForToday = fullAttendanceData.filter(record => {
                if (!record.parsedDate) return false;
                const recordDate = new Date(record.parsedDate);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate.getTime() === today.getTime();
            });

            const unfinishedEmployees = [];
            allocations.forEach(alloc => {
                const assignedRooms = new Set((alloc.roomsLantai1 + ", " + alloc.roomsLantai2).split(',').map(r => r.trim()).filter(Boolean));
                if (assignedRooms.size === 0) return;

                const employeeAttendance = attendanceForToday.filter(rec => rec.nama === alloc.name);
                let completedRooms = new Set();
                employeeAttendance.forEach(rec => {
                    const rooms = (rec.nama_ruang || '').split(',').map(r => r.trim()).filter(Boolean);
                    rooms.forEach(room => completedRooms.add(room));
                });
                
                const unfinishedRooms = [...assignedRooms].filter(room => !completedRooms.has(room));

                if (unfinishedRooms.length > 0) {
                    unfinishedEmployees.push({
                        name: alloc.name,
                        rooms: unfinishedRooms.join(', ')
                    });
                }
            });

            if (unfinishedEmployees.length > 0) {
                console.log("Pegawai yang belum selesai ditemukan:", unfinishedEmployees);
                showReminderNotification(unfinishedEmployees, settings.numbers);
            } else {
                console.log("Semua pekerjaan hari ini sudah selesai. Tidak ada pengingat dikirim.");
            }

        }, checkIntervalMs);
    }
    
    /**
     * Menampilkan notifikasi pop-up untuk mengirim pengingat WhatsApp.
     * @param {Array<object>} employees - Array objek pegawai yang belum selesai.
     * @param {Array<string>} numbers - Array nomor WhatsApp tujuan.
     */
    function showReminderNotification(employees, numbers) {
        const notification = document.getElementById('reminder-notification');
        const messageEl = document.getElementById('notification-message');
        const buttonsContainer = document.getElementById('notification-whatsapp-buttons');
        const closeBtn = document.getElementById('close-notification-btn');

        let employeeList = employees.map(e => `\n- *${e.name}*: ${e.rooms}`).join('');
        const fullMessage = `*PENGINGAT KEBERSIHAN* ⚠️\n\nMohon perhatian, beberapa tugas kebersihan untuk hari ini belum tercatat di sistem:\n${employeeList}\n\nHarap untuk segera diselesaikan dan dilakukan absensinya. Terima kasih.\n\n_(Pesan otomatis dari Sistem Informasi Kebersihan)_`;

        messageEl.innerText = `Ditemukan ${employees.length} pegawai yang belum menyelesaikan semua tugasnya: ${employees.map(e => e.name).join(', ')}.`;

        buttonsContainer.innerHTML = '';
        numbers.forEach(num => {
            const encodedMessage = encodeURIComponent(fullMessage);
            const waLink = `https://wa.me/${num}?text=${encodedMessage}`;
            const button = document.createElement('a');
            button.href = waLink;
            button.target = '_blank';
            button.className = 'btn btn-success w-full';
            button.innerHTML = `
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.908 6.161l.217.324-1.283 4.657 4.758-1.249.352.215z"/></svg>
                <span>Kirim Pengingat ke ${num}</span>`;
            buttonsContainer.appendChild(button);
        });

        notification.classList.remove('hidden');

        closeBtn.onclick = () => {
            notification.classList.add('hidden');
        };
    }
    
    /**
     * Menyiapkan fungsionalitas di tab Email Pemulihan.
     */
    function setupRecoveryTab() {
        const container = document.getElementById('recovery-email-list-container');
        const addBtn = document.getElementById('add-recovery-email-btn');
        const input = document.getElementById('new-recovery-email-input');

        function renderEmailList() {
            const credentials = getCredentials();
            const emails = credentials.recoveryEmails || [];
            container.innerHTML = emails.map(email => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="truncate pr-2 font-mono">${email}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-email-btn" data-email="${email}">Hapus</button>
                </div>
            `).join('') || `<p class="text-text-secondary text-center">Belum ada email pemulihan yang ditambahkan.</p>`;
        }
        
        container.addEventListener('click', async e => {
            const removeBtn = e.target.closest('.remove-email-btn');
            if (removeBtn) {
                const emailToRemove = removeBtn.dataset.email;
                if(confirm(`Yakin ingin menghapus email "${emailToRemove}" dari daftar pemulihan?`)){
                    let credentials = getCredentials();
                    credentials.recoveryEmails = credentials.recoveryEmails.filter(e => e !== emailToRemove);
                    await saveCredentials(credentials);
                    renderEmailList();
                    alert("Email pemulihan berhasil dihapus.");
                }
            }
        });

        addBtn.addEventListener('click', async () => {
            const newEmail = input.value.trim().toLowerCase();
            // Validasi email sederhana
            if (!newEmail.includes('@') || !newEmail.includes('.')) {
                alert('Silakan masukkan alamat email yang valid.');
                return;
            }
            let credentials = getCredentials();
            if ((credentials.recoveryEmails || []).includes(newEmail)) {
                 alert('Email ini sudah ada dalam daftar.');
                 return;
            }
            if (!credentials.recoveryEmails) credentials.recoveryEmails = [];
            credentials.recoveryEmails.push(newEmail);
            await saveCredentials(credentials);
            renderEmailList();
            input.value = '';
            alert(`Email ${newEmail} berhasil ditambahkan sebagai email pemulihan.`);
        });

        renderEmailList();
    }

    /**
     * Titik masuk utama untuk semua fungsionalitas di halaman Pengawas.
     * Fungsi ini akan merender HTML dashboard dan menginisialisasi semua event listener.
     */
    function runSupervisorScript() {
        // Render HTML dasar untuk dashboard
        renderSupervisorPageHTML();

        // Setelah HTML ada, baru cari elemen-elemennya
        const sidebarItems = document.querySelectorAll('.sidebar-nav-item');
        const panes = document.querySelectorAll('.tab-pane');
        const sidebar = document.getElementById('supervisor-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        
        // Inisialisasi Peta GPS sekali saja untuk efisiensi
        const gpsMap = initGpsEditor();

        /**
         * Beralih antar tab di dashboard.
         * @param {string} tabName - Nama tab tujuan (e.g., 'laporan', 'gps').
         */
        function switchTab(tabName) {
            sidebarItems.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            
            const activeItem = document.querySelector(`.sidebar-nav-item[data-tab="${tabName}"]`);
            if (activeItem) activeItem.classList.add('active');
            
            const activePane = document.getElementById(`tab-${tabName}`);
            if (activePane) activePane.classList.add('active');

            // PERBAIKAN: Peta Leaflet perlu di-refresh ukurannya jika tab-nya awalnya 'display: none'.
            if (tabName === 'gps' && gpsMap) {
                setTimeout(() => {
                    gpsMap.invalidateSize(true);
                    const activeCoords = getActivePolygon();
                    if (activeCoords && activeCoords.length > 0) {
                        gpsMap.fitBounds(activeCoords, { padding: [20, 20] });
                    }
                }, 150);
            }

            // Aktifkan scrollbar ganda saat tab yang relevan dibuka
            if (tabName === 'proses') {
                setupDualScrollbars('job-allocation-container', 'job-allocation-top-scrollbar-wrapper');
                setupDualScrollbars('progress-report-container', 'top-scrollbar-wrapper');
            }
        }
        
        /**
         * Membuka atau menutup sidebar (untuk tampilan mobile).
         * @param {boolean} [forceClose=false] - Jika true, akan selalu menutup sidebar.
         */
        function toggleSidebar(forceClose = false) {
             if (forceClose || sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('visible');
             } else {
                sidebar.classList.add('open');
                overlay.classList.add('visible');
             }
        }

        sidebarItems.forEach(item => {
            item.addEventListener('click', () => {
                switchTab(item.dataset.tab);
                // Tutup sidebar otomatis setelah memilih menu di mobile
                if (window.innerWidth <= 1024) { 
                    toggleSidebar(true);
                }
            });
        });
        
        hamburgerBtn.addEventListener('click', () => toggleSidebar());
        overlay.addEventListener('click', () => toggleSidebar(true));
        
        // --- Panggil semua fungsi setup untuk setiap tab ---
        setupReminderTab(); 
        setupRecoveryTab(); 

        setupManagementInterface('pegawai', {
            inputEl: document.getElementById('new-employee-name'), 
            addBtnEl: document.getElementById('add-employee-btn'),
            containerEl: document.getElementById('employee-list-container'), 
            getListFunc: getEmployeeList,
            addFunc: addEmployee, 
            removeFunc: removeEmployee
        });
        renderFloorManagement();
        
        // Setup filter tanggal di tab laporan
        document.getElementById('filter-btn').addEventListener('click', () => {
            const startVal = document.getElementById('start-date').value;
            const endVal = document.getElementById('end-date').value;

            if (!startVal || !endVal) {
                renderTable(fullAttendanceData, false); // Jika filter kosong, tampilkan semua data
                return;
            }
            try {
                const startDate = new Date(startVal + 'T00:00:00Z');
                const endDate = new Date(endVal + 'T23:59:59Z');

                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error("Format tanggal tidak valid.");
                }
                const filteredData = fullAttendanceData.filter(item => {
                     return item.parsedDate && item.parsedDate >= startDate && item.parsedDate <= endDate;
                });
                renderTable(filteredData, false);
            } catch(e) {
                alert("Terjadi kesalahan pada filter tanggal: " + e.message);
            }
        });
        
        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            renderTable(fullAttendanceData, false);
        });

        document.getElementById('print-pdf-btn').addEventListener('click', generatePdf);

        // Ambil data absensi utama, lalu render tabel tugas & progres
        fetchAttendanceData(false).then(() => {
            const container = document.getElementById('attendance-records-container');
            // Hanya render tabel tugas jika data absensi berhasil dimuat
            if (container && !container.querySelector('.text-danger-color')) {
                renderJobAllocationTable();
                setupAllocationListeners();
                
                // Atur tanggal default untuk laporan progres (7 hari terakhir)
                const today = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(today.getDate() - 7);
                document.getElementById('progress-report-start-date').valueAsDate = sevenDaysAgo;
                document.getElementById('progress-report-end-date').valueAsDate = today;
                renderProgressReport();
            }
        });

        setupLogout('logout-btn-supervisor');
        setupAttendanceSettings();
        setupAccessManagement();
        setupDiagnostics();
    }
    
    /**
     * Fungsi generik untuk membuat antarmuka manajemen daftar (tambah/hapus).
     * Digunakan untuk Pegawai, Ruangan, dll. agar tidak duplikasi kode.
     * @param {string} type - Tipe data (e.g., 'pegawai').
     * @param {object} config - Objek konfigurasi elemen DOM dan fungsi.
     */
    function setupManagementInterface(type, config) {
        const { inputEl, addBtnEl, containerEl, getListFunc, addFunc, removeFunc } = config;
        
        function renderList() {
            const items = getListFunc();
            containerEl.innerHTML = items.map(name => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="truncate pr-2">${name}</span>
                    <button class="btn btn-danger !py-1 !px-3 text-xs remove-btn" data-name="${name}">Hapus</button>
                </div>`).join('') || `<p class="text-text-secondary text-center">Belum ada data ${type}.</p>`;
            
            // Tambahkan event listener setelah elemen dibuat
            containerEl.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    const name = e.target.dataset.name;
                    await removeFunc(name); 
                    renderList(); 
                });
            });
        }

        addBtnEl.addEventListener('click', async () => { 
            await addFunc(inputEl.value); 
            inputEl.value = ''; 
            renderList(); 
        });
        
        // Render daftar saat pertama kali dipanggil
        renderList();
    }
    
    /**
     * Merender UI untuk manajemen lantai dan ruangan.
     */
    function renderFloorManagement() {
        const container = document.getElementById('floor-management-container');
        if (!container) return;
        const roomData = getRoomData();
        const floors = Object.keys(roomData);
        let floorOptions = floors.map(floor => `<option value="${floor}">${floor}</option>`).join('');
        
        container.innerHTML = `
            <div class="form-section-card !p-4 mb-6">
                <h3 class="text-lg font-semibold mb-3">Tambah Lantai Baru</h3>
                <div class="flex gap-4">
                    <input type="text" id="new-floor-name" class="form-input w-full" placeholder="Contoh: Lantai 3">
                    <button id="add-floor-btn" class="btn btn-primary whitespace-nowrap">Tambah</button>
                </div>
            </div>
            <div class="form-section-card !p-4">
                <h3 class="text-lg font-semibold mb-3">Tambah Ruangan Baru</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="new-room-name" class="form-input w-full" placeholder="Nama Ruangan Baru">
                    <select id="floor-select" class="form-input">${floorOptions}</select>
                </div>
                <button id="add-room-btn" class="btn btn-primary w-full mt-4">Tambah Ruangan</button>
            </div>
            <div id="room-list-by-floor" class="space-y-6 mt-6 max-h-[40vh] overflow-y-auto pr-2"></div>
        `;
        renderRoomListByFloor();
        document.getElementById('add-floor-btn').addEventListener('click', addFloor);
        document.getElementById('add-room-btn').addEventListener('click', addRoomToFloor);
    }
    
    /**
     * Merender daftar ruangan yang dikelompokkan per lantai.
     */
    function renderRoomListByFloor() {
        const container = document.getElementById('room-list-by-floor');
        if (!container) return;
        const roomData = getRoomData();
        container.innerHTML = ''; // Kosongkan kontainer
        for (const floor in roomData) {
            const floorSection = document.createElement('div');
            let roomListHTML = roomData[floor].map(room => `
                <div class="flex items-center justify-between bg-black bg-opacity-20 p-3 rounded-lg">
                    <span class="truncate pr-2">${room}</span>
                    <button class="btn btn-danger !py-1 !px-2 text-xs" onclick="removeRoomFromFloor('${floor}', '${room}')">Hapus</button>
                </div>`).join('');
            
            if (roomData[floor].length === 0) roomListHTML = '<p class="text-text-secondary text-sm italic p-3">Belum ada ruangan di lantai ini.</p>';
            
            floorSection.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-accent-primary">${floor}</h4>
                    <button class="btn btn-danger !py-1 !px-2 text-xs" onclick="removeFloor('${floor}')">Hapus Lantai Ini</button>
                </div>
                <div class="space-y-2">${roomListHTML}</div>
            `;
            container.appendChild(floorSection);
        }
    }

    /**
     * Menambahkan lantai baru ke data.
     */
    async function addFloor() {
        const input = document.getElementById('new-floor-name');
        const newFloorName = input.value.trim();
        if (!newFloorName) { alert('Nama lantai tidak boleh kosong!'); return; }
        
        const roomData = getRoomData();
        if (roomData[newFloorName]) { alert('Nama lantai sudah ada!'); return; }
        
        roomData[newFloorName] = [];
        await saveRoomData(roomData);
        renderFloorManagement();
        input.value = '';
    }

    /**
     * Menghapus lantai beserta semua ruangan di dalamnya.
     * @param {string} floorName - Nama lantai yang akan dihapus.
     */
    async function removeFloor(floorName) {
        if (confirm(`ANDA YAKIN?\n\nIni akan menghapus lantai "${floorName}" dan SEMUA ruangan di dalamnya secara permanen.`)) {
            const roomData = getRoomData();
            delete roomData[floorName];
            await saveRoomData(roomData);
            renderFloorManagement();
        }
    }
    
    /**
     * Menambahkan ruangan baru ke lantai yang dipilih.
     */
    async function addRoomToFloor() {
        const roomInput = document.getElementById('new-room-name');
        const floorSelect = document.getElementById('floor-select');
        const newRoomName = roomInput.value.trim();
        const selectedFloor = floorSelect.value;
        
        if (!newRoomName || !selectedFloor) { 
            alert('Nama ruangan dan lantai tidak boleh kosong!'); 
            return; 
        }
        
        const roomData = getRoomData();
        if (roomData[selectedFloor].map(r => r.toLowerCase()).includes(newRoomName.toLowerCase())) { 
            alert(`Ruangan dengan nama "${newRoomName}" sudah ada di ${selectedFloor}.`); 
            return; 
        }
        
        roomData[selectedFloor].push(newRoomName);
        // Urutkan ruangan secara alfabetis
        roomData[selectedFloor].sort((a, b) => a.localeCompare(b));
        
        await saveRoomData(roomData);
        renderRoomListByFloor();
        roomInput.value = '';
    }

    /**
     * Menghapus ruangan dari lantai tertentu.
     * @param {string} floorName - Nama lantai.
     * @param {string} roomName - Nama ruangan.
     */
    async function removeRoomFromFloor(floorName, roomName) {
         if (confirm(`Yakin ingin menghapus ruangan "${roomName}" dari ${floorName}?`)) {
            const roomData = getRoomData();
            roomData[floorName] = roomData[floorName].filter(room => room !== roomName);
            await saveRoomData(roomData);
            renderRoomListByFloor();
        }
    }

    /**
     * Membuat scrollbar ganda (atas dan bawah) untuk kontainer dengan tabel lebar.
     * Ini meningkatkan UX pada tabel yang sangat lebar di desktop.
     * @param {string} bottomScrollerId - ID kontainer utama yang bisa di-scroll.
     * @param {string} topScrollerId - ID wrapper untuk scrollbar atas.
     */
    function setupDualScrollbars(bottomScrollerId, topScrollerId) {
        const topScroller = document.getElementById(topScrollerId);
        const bottomScroller = document.getElementById(bottomScrollerId);
        if (!topScroller || !bottomScroller) return;
        
        const topScrollContent = topScroller.querySelector('div');
        const table = bottomScroller.querySelector('table');

        if (!table || !topScrollContent) {
            topScroller.style.display = 'none';
            return;
        }

        let isSyncing = false;

        const updateWidths = () => {
            requestAnimationFrame(() => {
                const tableWidth = table.offsetWidth;
                topScrollContent.style.width = `${tableWidth}px`;
                topScroller.style.display = tableWidth > bottomScroller.clientWidth ? 'block' : 'none';
            });
        };
        
        // Gunakan ResizeObserver untuk memantau perubahan ukuran secara efisien
        new ResizeObserver(updateWidths).observe(bottomScroller);
        new ResizeObserver(updateWidths).observe(table);

        const syncScroll = (source, target) => {
            if (isSyncing) return;
            isSyncing = true;
            target.scrollLeft = source.scrollLeft;
            requestAnimationFrame(() => { isSyncing = false; });
        };
        
        topScroller.onscroll = () => syncScroll(topScroller, bottomScroller);
        bottomScroller.onscroll = () => syncScroll(bottomScroller, topScroller);
    }

    /**
     * Menyiapkan fungsionalitas di tab Diagnostik Sistem.
     */
    function setupDiagnostics() {
        const runBtn = document.getElementById('run-diagnostics-btn');
        const fixBtn = document.getElementById('fix-system-btn');
        const resultsContainer = document.getElementById('diagnostics-results-container');
        const fixContainer = document.getElementById('diagnostic-fix-container');

        const createResultItem = (status, title, message) => `
            <li class="status-${status}">
                <span class="status-icon">${status === 'ok' ? '✅' : (status === 'error' ? '❌' : '⚠️')}</span>
                <div class="status-text">
                    <p class="status-title">${title}</p>
                    <p class="status-message">${message}</p>
                </div>
            </li>`;
        
        const createCategory = (title) => `<h3 class="diagnostic-category">${title}</h3>`;

        const runAllChecks = async () => {
            let resultsHTML = '<ul id="diagnostic-results-list">';
            let hasCorruption = false;
            
            // 1. Cek Konektivitas
            resultsHTML += createCategory('Konektivitas & Dependensi Eksternal');
            try {
                const response = await fetch(`${SPREADSHEET_URL}?action=ping&t=${new Date().getTime()}`);
                if (response.ok && (await response.json()).status === 'ok') {
                    resultsHTML += createResultItem('ok', 'Konektivitas Google Sheets', 'Berhasil terhubung dan menerima respons valid dari server spreadsheet.');
                } else {
                    resultsHTML += createResultItem('error', 'Konektivitas Google Sheets', 'Gagal terhubung. Pastikan URL benar, skrip telah di-deploy dengan benar, dan izin akses sudah diberikan.');
                }
            } catch (e) {
                resultsHTML += createResultItem('error', 'Konektivitas Google Sheets', `Gagal melakukan request jaringan. Cek koneksi internet dan pengaturan CORS. Error: ${e.message}`);
            }

            // 2. Cek Pustaka (Library)
            const libs = { 'Face-API': 'faceapi', 'Leaflet (Peta)': 'L', 'Choices (Dropdown)': 'Choices', 'jsPDF (Cetak PDF)': 'jspdf' };
            for (const [name, lib] of Object.entries(libs)) {
                resultsHTML += typeof window[lib] !== 'undefined'
                    ? createResultItem('ok', `Pustaka ${name}`, 'Berhasil dimuat dan tersedia di scope global.')
                    : createResultItem('error', `Pustaka ${name}`, 'Gagal dimuat. Beberapa fitur mungkin tidak berfungsi. Cek link di <head>.');
            }
            
            // 3. Cek Integritas Data Lokal (localStorage)
            resultsHTML += createCategory('Integritas Data Lokal (Cache)');
            const localDataKeys = ['employeeList', 'roomData', 'jobAllocations', 'gpsPresetList', 'loginCredentials', 'attendanceSettings', 'reminderSettings'];
            let dataOk = true;
            localDataKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try { JSON.parse(data); } catch (e) {
                        resultsHTML += createResultItem('error', `Data Lokal: ${key}`, `Data untuk '${key}' di cache browser rusak (corrupt). Ini dapat menyebabkan error.`);
                        dataOk = false;
                        hasCorruption = true;
                    }
                } else {
                    resultsHTML += createResultItem('warning', `Data Lokal: ${key}`, `Data untuk '${key}' tidak ditemukan di cache. Akan menggunakan data default.`);
                }
            });
            if (dataOk) {
                resultsHTML += createResultItem('ok', 'Integritas Data Lokal', 'Semua data konfigurasi di cache browser dalam kondisi baik.');
            }

            // 4. Cek Konsistensi Data
            resultsHTML += createCategory('Konsistensi Data Internal');
            try {
                const employeeList = getEmployeeList();
                const jobAllocations = getJobAllocations();
                const employeeSet = new Set(employeeList);
                let inconsistenciesFound = false;

                jobAllocations.forEach(job => {
                    if (!employeeSet.has(job.name)) {
                        resultsHTML += createResultItem('warning', 'Inkonsistensi Tugas', `Pegawai "${job.name}" memiliki tugas, tetapi namanya tidak ditemukan di daftar pegawai utama. Ini bisa menyebabkan masalah pada laporan.`);
                        inconsistenciesFound = true;
                        hasCorruption = true;
                    }
                });

                if (!inconsistenciesFound) {
                     resultsHTML += createResultItem('ok', 'Konsistensi Data Pegawai', 'Data daftar pegawai dan pembagian tugas sudah sinkron.');
                }

            } catch(e) {
                 resultsHTML += createResultItem('error', 'Pemeriksaan Konsistensi', 'Gagal memeriksa konsistensi data. Mungkin ada data yang rusak.');
            }


            // 5. Cek Izin Browser
            resultsHTML += createCategory('Izin Browser');
            try {
                if(navigator.permissions) {
                    const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                    resultsHTML += createResultItem(cameraPermission.state === 'granted' ? 'ok' : 'warning', 'Izin Kamera', `Status izin saat ini: ${cameraPermission.state}. Jika 'prompt' atau 'denied', pengguna harus memberikan izin saat diminta.`);
                    const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
                    resultsHTML += createResultItem(geoPermission.state === 'granted' ? 'ok' : 'warning', 'Izin Lokasi (GPS)', `Status izin saat ini: ${geoPermission.state}. Jika 'prompt' atau 'denied', pengguna harus memberikan izin.`);
                } else {
                    resultsHTML += createResultItem('warning', 'Izin Browser', 'Pengecekan izin otomatis tidak didukung browser ini. Izin akan diminta saat fitur digunakan.');
                }
            } catch(e) {
                 resultsHTML += createResultItem('warning', 'Izin Browser', 'Gagal memeriksa izin secara otomatis.');
            }

            resultsHTML += '</ul>';
            resultsContainer.innerHTML = resultsHTML;

            // Tampilkan tombol perbaikan jika ditemukan masalah
            fixContainer.classList.toggle('hidden', !hasCorruption);
        };

        const fixSystem = () => {
            if (confirm("ANDA YAKIN INGIN MELAKUKAN RESET?\n\nAksi ini akan menghapus semua pengaturan lokal (pegawai, ruangan, tugas, GPS, dll.) dan mengembalikannya ke kondisi default pabrik.\n\nDATA ABSENSI di Google Sheets TIDAK akan terhapus.\n\nIni berguna jika aplikasi mengalami error karena data yang rusak. Lanjutkan?")) {
                const keysToRemove = ['employeeList', 'roomData', 'jobAllocations', 'gpsPresetList', 'loginCredentials', 'activeGpsCoords', 'attendanceSettings', 'reminderSettings'];
                keysToRemove.forEach(key => localStorage.removeItem(key));
                alert('Perbaikan selesai. Semua pengaturan lokal telah di-reset. Aplikasi akan dimuat ulang sekarang.');
                window.location.reload();
            }
        };

        runBtn.addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const originalText = btn.querySelector('span').textContent;
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Mengecek...';
            resultsContainer.innerHTML = `<div class="flex justify-center items-center p-8"><div class="loader"></div><p class="ml-4 text-text-secondary">Memeriksa kesehatan sistem, mohon tunggu...</p></div>`;
            fixContainer.classList.add('hidden');

            // Beri sedikit waktu agar UI loader sempat tampil
            await new Promise(resolve => setTimeout(resolve, 200));
            await runAllChecks();

            btn.disabled = false;
            btn.querySelector('span').textContent = originalText;
        });

        fixBtn.addEventListener('click', fixSystem);
    }

    /**
     * Menyiapkan fungsionalitas tombol logout untuk halaman tertentu.
     * @param {string} buttonId - ID dari tombol logout.
     */
    function setupLogout(buttonId) {
        const logoutBtn = document.getElementById(buttonId);
        if(logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (confirm("Anda yakin ingin keluar dari sesi ini?")) {
                    // Hancurkan instance Choices.js jika ada untuk membersihkan memori
                    if (roomChoicesInstance) {
                        roomChoicesInstance.destroy();
                        roomChoicesInstance = null;
                    }
                    // Hapus data sesi dan muat ulang halaman untuk kembali ke login
                    sessionStorage.clear();
                    window.location.reload();
                }
            });
        }
    }
</script>
</body>
</html>
